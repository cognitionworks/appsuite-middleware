define("io.ox/contacts/api",["io.ox/core/http","io.ox/core/api/factory","io.ox/core/cache"],function(a,b,c){var d,e,f,g=b({module:"contacts",requests:{all:{action:"all",folder:"6",columns:"20,1,500,502",sort:"607",order:"asc",admin:"false"},list:{action:"list",columns:"20,1,500,501,502,505,520,555,556,557,569,602,606"},get:{action:"get"},search:{action:"search",columns:"20,1,500,501,502,505,520,555,556,557,569,602,606",sort:"609",getData:function(a,b){return{display_name:a+"*",first_name:a+"*",last_name
:a+"*",email1:a+"*",email2:a+"*",email3:a+"*",orSearch:!0,emailAutoComplete:!!b}}}}});"use strict";function h(a,b){(a[b]===""||a[b]===undefined)&&delete a[b]}return g.create=function(b,c){var d,f;return h(b,"email1"),h(b,"email2"),h(b,"email3"),c?(f=new FormData,f.append("file",c),f.append("json",JSON.stringify(b)),d="UPLOAD"):(f=b,d="PUT"),a[d]({module:"contacts",params:{action:"new"},data:f,appendColumns:!1,fixPost:!0}).pipe(function(a){return a=a.data||a,g.get({id:a.id,folder:b.folder_id})}).pipe
(function(a){return $.when(g.caches.all.grepRemove(a.folder_id+"\t"),e.clear()).pipe(function(){return g.trigger("refresh.all"),g.trigger("created",{id:a.id,folder:a.folder_id}),a})})},g.edit=function(b){if(_.isEmpty(b.data))return $.when();else return a.PUT({module:"contacts",params:{action:"update",id:b.id,folder:b.folder,timestamp:b.timestamp},data:b.data,appendColumns:!1}).pipe(function(){return g.get({id:b.id,folder:b.folder},!1).pipe(function(a){$.when(g.caches.all.grepRemove(b.folder+"\t")
,g.caches.list.remove({id:b.id,folder:b.folder}),e.clear()).pipe(function(){return g.trigger("refresh.list"),g.trigger("edit",{id:b.id,folder:b.folder}),a})})}).fail(function(){console.log("connection lost")})},g.editNewImage=function(b,c,d){var f=new FormData;return f.append("file",d),f.append("json",JSON.stringify(c)),a.UPLOAD({module:"contacts",params:{action:"update",id:b.id,folder:b.folder_id,timestamp:b.timestamp||_.now()},data:f,fixPost:!0}).pipe(function(){return $.when(g.caches.get.clear
(),g.caches.list.clear(),e.clear())}).done(function(){g.trigger("refresh.list")})},g.remove=function(b){return b=_.isArray(b)?b:[b],a.PUT({module:"contacts",params:{action:"delete",timestamp:_.now()},appendColumns:!1,data:_(b).map(function(a){return{folder:a.folder_id,id:a.id}})}).pipe(function(){return $.when(g.caches.all.clear(),g.caches.list.remove(b),e.clear())}).done(function(){g.trigger("refresh.all")})},d=new c.SimpleCache("contacts-autocomplete",!0),g.on("refresh.all",function(){d.clear()
}),g.autocomplete=function(a){function b(a,b,c){var d,e,f,g;b[c]&&(e=b.last_name,f=b.first_name,g=b.display_name,e&&f?d=e+", "+f:g?d=g+"":(d=[],e&&d.push(e),f&&d.push(f),d=d.join(", ")),a.push({display_name:d,email:b[c].toLowerCase(),contact:b}))}return d.get(a).pipe(function(c){if(c!==null)return c;else return a=String(a||"").toLowerCase(),g.search(a,!0).pipe(function(c){var d=[],e={};return _(c).each(function(a){a.mark_as_distributionlist?d.push({display_name:a.display_name||"",email:"will not be resolved"
,contact:a}):(b(d,a,"email1"),b(d,a,"email2"),b(d,a,"email3"))}),d=_(d).filter(function(b){var c=b.contact.mark_as_distributionlist===!0,d=b.email in e;if(c)return String(b.display_name||"").toLowerCase().indexOf(a)>-1;else return d?!1:e[b.email]=!0}),e=null,d}).done(function(b){d.add(a,b)})})},e=new c.SimpleCache("picture-by-mail",!0),g.getPictureByMailAddress=function(b){return b=String(b).toLowerCase(),e.get(b).pipe(function(c){if(c!==null)return c;else return a.PUT({module:"contacts",params:{
action:"search",columns:"20,1,500,606"},data:{email1:b,email2:b,email3:b,orSearch:!0}}).pipe(function(a){a=$.grep(a,function(a){return!!a.image1_url});if(a.length)return a.sort(function(a,b){return b.folder_id==="6"?+1:-1}),a[0].image1_url=a[0].image1_url.replace(/^https?\:\/\/[^\/]+/i,"").replace(/^\/ajax/,ox.apiRoot),e.add(b,a[0].image1_url);else return e.add(b,"")})})},g.getPictureURL=function(a){var b=$.Deferred(),c=ox.base+"/apps/themes/default/dummypicture.png",d=function(){b.resolve(c)};return typeof 
a=="string"?g.getPictureByMailAddress(a).done(function(a){b.resolve(a||c)}).fail(d):typeof a=="object"&&a!==null?g.get({id:a.contact_id||a.id,folder:a.folder_id||a.folder}).done(function(a){a.image1_url?b.resolve(a.image1_url.replace(/^\/ajax/,ox.apiRoot)):d()}).fail(d):d(),b},g.getPicture=function(a){var b=$("<div>"),c=function(a){Modernizr.backgroundsize?b.css("backgroundImage","url("+a.data.url+")"):b.append($("<img>",{src:a.data.url,alt:""}).css({width:"100%",height:"100%"})),/dummypicture\.png$/
.test(a.data.url)&&b.addClass("default-picture"),d()},d=function(){_.defer(function(){b=c=d=e=null})},e=function(a){$(new Image).on("load",{url:a},c).on("error",{url:ox.base+"/apps/themes/default/dummypicture.png"},c).prop("src",a)};return a&&_.isString(a.image1_url)?e(a.image1_url.replace(/^\/ajax/,ox.apiRoot)):g.getPictureURL(a).done(e).fail(d),b},f=function(b,c,d){return b=_.isArray(b)?b:[b],a.pause(),_(b).map(function(b){return a.PUT({module:"contacts",params:{action:c||"update",id:b.id,folder
:b.folder_id||b.folder,timestamp:b.timestamp||_.now()},data:{folder_id:d},appendColumns:!1})}),a.resume().pipe(function(){return $.when.apply($,_(b).map(function(a){return $.when(g.caches.all.grepRemove(d+"\t"),g.caches.all.grepRemove(a.folder_id+"\t"),g.caches.list.remove({id:a.id,folder:a.folder_id}))}))}).done(function(){g.trigger("refresh.all")})},g.move=function(a,b){return f(a,"update",b)},g.copy=function(a,b){return f(a,"copy",b)},g})