define("io.ox/contacts/distrib/create-dist-view",["io.ox/core/extensions","gettext!io.ox/contacts/contacts","io.ox/contacts/util","io.ox/contacts/api","io.ox/core/tk/view","io.ox/core/tk/model","io.ox/core/tk/autocomplete","io.ox/core/config"],function(a,b,c,d,e,f,g,h){var i,j,k,l=function(a){return $("<a>",{"data-action":"save",href:"#",tabindex:"5"}).addClass("btn btn-primary").on("click",{model:a},function(a){a.data.model.save()}).text(a.get("mark_as_distributionlist")?b("Save"):b("Create list"
))},m=function(a,c){return c.parent().find(".alert").remove(),$("<div>").addClass("alert alert-block fade in").append($("<a>").attr({href:"#","data-dismiss":"alert"}).addClass("close").html("&times;"),$("<p>").text(b("The email address "+a+" is already in the list")))},n=function(b){a.point("io.ox/core/person:action").each(function(a){_.call(a.action,b.data,b)})};"use strict";function o(a){a.append($("<div>").addClass("listet-item backstripes").attr({"data-mail":"empty"}).text(b("This list has no members yet"
)))}i=function(a){var b=$("<a>").attr({"data-action":"add",href:"#",tabindex:"4"}).addClass("btn btn-inverse").text("+").on("click",function(b){var c=a.node.find('[data-holder="data-holder"]').data(),d=a.node.find("input#mail").val(),e=a.node.find("input#name").val();c.contact?u(a,c.contact,c.email):d!==""&&u(a,e,d),a.node.find('[data-holder="data-holder"]').removeData(),a.node.find("input#mail").val(""),a.node.find("input#name").val("")});return b};function p(){return $("<div>").attr("id",_.uniqueId
("box_")).addClass("item-list")}function q(a,b){var d=$("<div>").addClass("create-distributionlist-contact-image"),e=c.getImage(b.contact);Modernizr.backgroundsize?d.css("backgroundImage","url("+e+")"):d.append($("<img>",{src:e,alt:""}).css({width:"100%",height:"100%"})),a.append(d,$("<div>").addClass("person-link ellipsis").text(b.display_name),$("<div>").addClass("ellipsis").text(b.email))}function r(a){var b,c,d,e,f=a.data.frame.parent();a.preventDefault(),c=a.data.options,d=c.model;for(e=0;e<
d._data.distribution_list.length;)d._data.distribution_list[e].mail===a.data.mail&&d._data.distribution_list[e].display_name===a.data.name?d._data.distribution_list.splice(e,1):e+=1;b=f.find('[data-mail="'+a.data.name+"_"+a.data.mail+'"]'),f.find(b).remove(),f.find(".listet-item")[0]||c.displayBox.append(o(c.displayBox))}function s(a){var b=$("<div>").addClass("listet-item").attr({"data-mail":a.name+"_"+a.selectedMail}),c=d.getPicture(a.selectedMail).addClass("contact-image"),e=$("<a>",{href:"#"}
).addClass("close").html("&times;").on("click",{options:a.options,mail:a.selectedMail,name:a.name,frame:b},r);b.append(e),b.append(c).append($("<div>").addClass("person-link ellipsis").append($("<a>",{href:"#"}).on("click",{id:a.id,email1:a.selectedMail},n).text(a.name)),$("<div>").addClass("person-selected-mail").text(a.selectedMail)),a.node.append(b)}function t(a,b){var c,d=[a.email1,a.email2,a.email3];return _.each(d,function(a,d){b===a&&(c=d+1)}),c}function u(a,b,c){var d,e;a.model._data.distribution_list||
(a.model._data.distribution_list=[]),_.isString(b)?(s({node:a.displayBox,name:b,selectedMail:c,options:a}),d='[data-mail="'+b+"_"+c+'"]',a.model._data.distribution_list.push({display_name:b,mail:c,mail_field:0})):(s({node:a.displayBox,id:b.id,name:b.display_name,selectedMail:c,options:a}),d='[data-mail="'+b.display_name+"_"+c+'"]',e=t(b,c),a.model._data.distribution_list.push({id:b.id,display_name:b.display_name,mail:c,mail_field:e})),a.displayBox.find(d)[1]&&m(c,a.displayBox).appendTo(a.displayBox
.parent().parent().find(".editsection")),_.isEmpty(a.model._data.distribution_list)||a.displayBox.find('[data-mail="empty"]').remove()}function v(a,b,c,e,f){return $("<div>").addClass("fieldset "+b).append($("<label>",{"for":"input_field_"+b}).text(e),$("<input>",{type:"text",tabindex:f,autocapitalize:"off",autocomplete:"off",autocorrect:"off",id:b}).attr("data-type",b).addClass("discreet input-large").autocomplete({source:function(a){return d.autocomplete(a)},stringify:function(a){if(c==="input#mail"
)return a.display_name;else return a.email},stringifyrelated:function(a){if(c==="input#mail")return a.email;else return a.display_name},draw:function(a){q.call(null,this,a)},related:function(){var a=$(c);return a},dataHolder:function(){var a=$('[data-holder="data-holder"]');return a}}).on("keydown",function(a){a.which===13&&$('[data-action="add"]').trigger("click")}))}return j=$("<div>",{id:"myGrowl"}).addClass("jGrowl").css({position:"absolute",right:"0",top:"0"}),k=e.extend({draw:function(a){var c=
this,d=c.getModel(),e=_.uniqueId("c"),f=c.createSection(),g=c.createSection(),j=c.createSectionGroup(),k,m=h.get("folder.contacts"),n;return c.displayBox=p(),_.isArray(c.model._data.distribution_list)&&(n=c.model._data.distribution_list,_.each(n,function(a){s({node:c.displayBox,id:a.id,name:a.display_name,selectedMail:a.mail,options:c})})),c.node.append(j),j.addClass("header").append(c.createLabel({id:e,text:b("List name")}),c.createTextField({property:"display_name",id:e,classes:"input-large"}).
find("input").attr("tabindex","1"),l(c.model)),f.addClass("editsection").append(c.createSectionTitle({text:b("Members")}),c.displayBox),_.isEmpty(c.model._data.distribution_list)&&o(c.displayBox),c.node.append(f),k=$("<div>").attr("data-holder","data-holder").append(v(c,"name","input#mail",b("Name"),"2"),v(c,"mail","input#name",b("Email address"),"3")),g.addClass("last").append(k,i(c)),c.node.append(g),c.node.append($("<div>",{id:"myGrowl"}).addClass("jGrowl").css({position:"absolute",right:"-275px"
,top:"-10px"})),this.getModel().on("error:invalid",function(a,b){console.log("error validation"),console.log(arguments),$("#myGrowl").jGrowl(b.message,{header:"Make an educated guess!",sticky:!1})}),c}}),k})