define.async("io.ox/mail/write/main",["io.ox/mail/api","io.ox/mail/util","io.ox/core/extensions","io.ox/core/config","io.ox/contacts/api","io.ox/contacts/util","io.ox/core/api/user","io.ox/core/tk/upload","io.ox/mail/model","io.ox/mail/write/view-main","gettext!io.ox/mail/mail","less!io.ox/mail/style.css","less!io.ox/mail/write/style.css"],function(a,b,c,d,e,f,g,h,i,j,k){var l,m,n;"use strict",c.point("io.ox/mail/write/actions/send").extend({id:"send",action:function(a){a.send()}}),c.point("io.ox/mail/write/actions/draft"
).extend({id:"send",action:function(a){a.saveDraft().done(function(b){a.setMsgRef(b.data)}).fail(function(){})}}),c.point("io.ox/mail/write/actions/proofread").extend({id:"proofread",action:function(a){a.proofread()}}),l=[],m=1;function o(){var c,e,f,g,n,o,p={},q="",r=d.get("gui.mail.formatmessage","TEXT/PLAIN")==="TEXT/PLAIN"?"text":"html",s=ox.ui.createApp({name:"io.ox/mail/write",title:"Compose"}),t=new i,u=new j({model:t,app:s});u.ID="YEAH #"+m++,s.getView=function(){return u},window.newmailapp=
function(){return s},s.STATES={CLEAN:1,DIRTY:2},g=s.STATES.CLEAN,s.getState=function(){return g},s.markDirty=function(){g=s.STATES.DIRTY},s.markClean=function(){g=s.STATES.CLEAN},u.signatures=d.get("gui.mail.signatures",[]),s.setSignature=function(a){var b,c,d=a.data.index,e=this.getEditor(),f=!!e.removeBySelector;f?e.removeBySelector(".io-ox-signature"):q&&(e.replaceParagraph(q,""),q=""),d<u.signatures.length&&(b=u.signatures[d],c=$.trim(b.signature_text),f?e.appendContent('<p class="io-ox-signature">'+
e.ln2br(c)+"</p>"):e.appendContent(c),q=c,e.scrollTop("bottom")),e.focus()};function v(a,b,c){$("#myGrowl").jGrowl(a,{header:b,sticky:c})}return s.setLauncher(function(){var b;c=ox.ui.createWindow({name:"io.ox/mail/write",title:"",titleWidth:u.GRID_WIDTH+10+"px",toolbar:!0,close:!0}),c.detachable=!1,s.setWindow(c),u.render(),c.nodes.main.addClass("io-ox-mail-write").append(u.form=$("<form>",{name:"compose",method:"post",enctype:"multipart/form-data"}).addClass("form-inline").append($("<input>",{type
:"hidden",name:"msgref",value:""}),$("<input>",{type:"hidden",name:"sendtype",value:a.SENDTYPE.NORMAL}),u.main,u.scrollpane)),b=h.dnd.createDropZone({type:"single"}),b.on("drop",function(a,b){u.form.find("input[type=file]").last().prop("file",b).trigger("change"),u.showSection("attachments")}),c.on("show",function(){s.getEditor()&&s.getEditor().handleShow(),b.include()}),c.on("hide",function(){s&&s.getEditor()&&s.getEditor().handleHide(),b.remove()})}),s.setFormat=function(){function a(a,b){var c="io.ox/core/tk/"+
(a==="html"?"html-editor":"text-editor");return require([c]).pipe(function(c){return(p[a]=new c(u.textarea)).done(function(){s.setEditor(p[a]),s.getEditor().setPlainText(b),s.getEditor().handleShow()})})}function b(a,b){return s.setEditor(p[a]),s.getEditor().setPlainText(b),s.getEditor().handleShow(),$.when()}function c(c){var d;u.textarea.attr("disabled","disabled").busy();if(s.getEditor()){d=s.getEditor().getPlainText(),s.getEditor().clear(),s.getEditor().handleHide();if(s.getEditor().tinymce)if(!
p.text)return a("text",d);else return b("text",d);else if(!p.html)return a("html",d);else return b("html",d)}else return a(c)}return s.markDirty(),_.queued(function(a){return a===f?$.when():c(a||f).done(function(){f=a||f})})}(),s.setSubject=function(a){s.markDirty(),u.subject.val(a||"")},s.setRawBody=function(a){s.markDirty(),s.getEditor().setContent(a)},s.setBody=function(a){var b,c,d,e;s.markDirty(),b=_(u.signatures).find(function(a){return a.signature_default===!0}),c=b?$.trim(b.signature_text
):"",d=b?b.position:"below",e=$.trim(a),b?(q=c,f==="html"?(c="<p>"+c.replace(/\n/g,"<br>")+"</p>",s.getEditor().setContent("<p></p>"+(d==="above"?c+e:e+c))):d==="above"?s.getEditor().setContent("\n\n"+c+(e!==""?"\n\n"+e:"")):s.getEditor().setContent("\n\n"+(e!==""?e+"\n\n":"")+c)):s.getEditor().setContent(e!==""?(f==="html"?"<p></p>":"\n\n")+e:"")},s.setTo=function(a){u.addRecipients("to",a||[])},s.setCC=function(a){u.addRecipients("cc",a||[]),a&&a.length&&u.showSection("cc",!1)},s.setBCC=function(
a){u.addRecipients("bcc",a||[]),a&&a.length&&u.showSection("bcc",!1)},s.setAttachments=function(a){var b;s.markDirty(),b=!1,_(a||[]).each(function(a){a.disp==="attachment"&&(a.type="file",b=!0,u.form.find("input[type=file]").last().prop("attachment",a).trigger("change"))}),b&&u.showSection("attachments")},s.setNestedMessages=function(a){var b;s.markDirty(),b=!1,_(a||[]).each(function(a){b=!0,u.form.find("input[type=file]").last().prop("nested",{message:a,name:a.subject,content_type:"message/rfc822"
}).trigger("change")}),b&&u.showSection("attachments")},s.addFiles=function(a){var b;s.markDirty(),b=!1,_(a||[]).each(function(a){b=!0,u.form.find("input[type=file]").last().prop("file",a).trigger("change")}),b&&u.showSection("attachments")},s.setPriority=function(a){s.markDirty(),a=parseInt(a,10)||3,a=a<3?1:a,a=a>3?5:a,u.form.find("input[name=priority][value="+a+"]").prop("checked",!0),a===1&&u.priorityOverlay.addClass("high")},s.setAttachVCard=function(a){s.markDirty(),u.form.find("input[name=vcard]"
).prop("checked",!!a)},s.setDeliveryReceipt=function(a){s.markDirty(),u.form.find("input[name=receipt]").prop("checked",!!a)},s.setMsgRef=function(a){s.markDirty(),u.form.find("input[name=msgref]").val(a||"")},s.setSendType=function(b){s.markDirty(),u.form.find("input[name=sendtype]").val(b||a.SENDTYPE.NORMAL)},o={compose:k("Compose new email"),replyall:k("Reply all"),reply:k("Reply"),forward:k("Forward")},s.setMail=function(a){var b,e;return a=a||{},a.data=a.data||{},a.mode=a.mode||"compose",a.format=
a.format||r||"text",a.initial=a.initial||!1,b=a.data,this.setSubject(b.subject),this.setTo(b.to),this.setCC(b.cc),this.setBCC(b.bcc),this.setAttachments(b.attachments),this.setNestedMessages(b.nested_msgs),this.setPriority(b.priority||3),this.setAttachVCard(b.vcard!==undefined?b.vcard:d.get("mail.vcard",!1)),this.setDeliveryReceipt(b.disp_notification_to!==undefined?b.disp_notification_to:!1),this.setMsgRef(b.msgref),this.setSendType(b.sendtype),this.addFiles(b.infostore_ids),e=b.subject?b.subject
:o[n=a.mode],c.setTitle(e),s.setTitle(e),q=a.signature||"",s.setFormat(a.format).done(function(){var c=b.attachments&&b.attachments.length?b.attachments[0].content:"";a.format==="text"&&(c=c.replace(/<br>\n?/g,"\n")),f==="html"&&(c=c.replace(/(<img[^>]+src=")\/ajax/g,"$1"+ox.apiRoot)),s[a.initial?"setBody":"setRawBody"](c)})},s.failSave=function(){var a=s.getMail();return delete a.files,{module:"io.ox/mail/write",point:a}},s.failRestore=function(a){var b=$.Deferred();return c.show(function(){s.setMail
(a).done(function(){s.getEditor().focus(),b.resolve()})}),b},s.compose=function(a){var b,d,e,f,g,h,i;return navigator.registerProtocolHandler&&(b=location,d=b.href.indexOf("#"),e=b.href.substr(0,d),navigator.registerProtocolHandler("mailto",e+"#app=io.ox/mail/write:compose&mailto=%s",ox.serverConfig.productNameMail)),i=$.Deferred(),a===undefined&&(f=_.url.hash("mailto"))&&(g=f.split(/\?/,2),h=_.deserialize(g[1]),g=g[0].split(/\:/,2),a={to:[["",g[1]]],subject:h.subject,attachments:[{content:h.body
}]},_.url.hash("mailto",null)),c.busy().show(function(){s.setMail({data:a,mode:"compose",initial:!0}).done(function(){f?s.getEditor().focus():a&&a.to?s.getWindowNode().find("input[name=subject]").focus().select():s.getWindowNode().find("input[data-type=to]").focus().select(),c.idle(),i.resolve()})}),i},s.replyall=function(b){var d=$.Deferred();return c.busy().show(function(){a.replyall(b,r||"text").done(function(b){b.sendtype=a.SENDTYPE.REPLY,s.setMail({data:b,mode:"replyall",initial:!0}).done(function(
){s.getEditor().focus(),u.scrollpane.scrollTop(0),c.idle(),d.resolve()})})}),d},s.reply=function(b){var d=$.Deferred();return c.busy().show(function(){a.reply(b,r||"text").done(function(b){b.sendtype=a.SENDTYPE.REPLY,s.setMail({data:b,mode:"reply",initial:!0}).done(function(){s.getEditor().focus(),u.scrollpane.scrollTop(0),c.idle(),d.resolve()})})}),d},s.forward=function(b){var d=$.Deferred();return c.busy().show(function(){a.forward(b,r||"text").done(function(b){b.sendtype=a.SENDTYPE.FORWARD,s.setMail
({data:b,mode:"forward",initial:!0}).done(function(){s.getWindowNode().find("input[data-type=to]").focus().select(),c.idle(),d.resolve()})})}),d},s.proofread=function(){var a=$("<div>").addClass("abs io-ox-mail-proofread");require(["io.ox/mail/view-detail"],function(b){var c=s.getMail();_.extend(c.data,{folder_id:"default0/INBOX",received_date:_.now()}),a.append(b.draw(c.data)).appendTo("body")})},s.getMail=function(){var c,d,e=u.form.find(":input[name]").filter("textarea, [type=text], [type=hidden], [type=radio]:checked, [type=checkbox]:checked"
),g=_(e).inject(function(a,b){var c=b.name,d=a[c],e=$(b).val();return d!==undefined?(_.isArray(d)?d:a[c]=[d]).push(e):a[c]=e,a},{}),h=[],i=function(a){return _(b.parseRecipients([].concat(a).join(", "))).map(function(a){return['"'+a[0]+'"',a[1]]})};return f==="html"?c={content_type:"text/html",content:(s.getEditor()?s.getEditor().getContent():"").replace(/(<img[^>]+src=")(\/ox7\/)?api\//g,"$1/ajax/")}:c={content_type:"text/plain",content:(s.getEditor()?s.getEditor().getContent():"").replace(/</g,"&lt;"
).replace(/\n/g,"<br>\n")},d={from:[l]||[],to:i(g.to),cc:i(g.cc),bcc:i(g.bcc),subject:g.subject+"",priority:parseInt(g.priority,10)||3,vcard:parseInt(g.vcard,10)||0,attachments:[c],nested_msgs:[]},parseInt(g.receipt,10)&&(d.disp_notification_to=!0),g.msgref&&(d.msgref=g.msgref),d.sendtype=g.sendtype||a.SENDTYPE.NORMAL,u.form.find(":input[name][type=file]").each(function(){var a=$(this).prop("attachment"),b=$(this).prop("file"),c=$(this).prop("nested");a?d.attachments.push(a):c?d.nested_msgs.push(
c.message):b instanceof window.File?h.push(b):b&&"id"in b?(d.infostore_ids=d.infostore_ids||[]).push(b):this.files&&this.files.length&&_(this.files).each(function(a){h.push(a)})}),{data:d,mode:n,format:f,signature:q,files:h}},s.send=function(){var b=this.getMail();b.data.infostore_ids&&(b.data.infostore_ids=_(b.data.infostore_ids).pluck("id")),_(b.data.nested_msgs).each(function(a){b.data.attachments.push({id:b.data.attachments.length+1,filemname:a.subject,content_type:"message/rfc822",msgref:a.msgref
})}),delete b.data.nested_msgs,s.markClean(),c.busy().preQuit(),a.send(b.data,b.files).always(function(a){a.error?(console.error(a),c.idle().show(),alert(k("Server error - see console :("))):s.quit()})},s.saveDraft=function(){var b=this.getMail(),c=new $.Deferred;return b.data.sendtype=a.SENDTYPE.DRAFT,_(b.data.flags).isUndefined()?b.data.flags=a.FLAGS.DRAFT:b.data.flags&4===0&&(b.data.flags+=a.FLAGS.DRAFT),a.send(b.data,b.files).always(function(a){a.error?(console.error(a),c.reject(k("Server error - see console :("
)),v(k("Mail is NOT saved"),k("Mail Error"),!0)):(v(k("Mail is saved"),k("Mail"),!1),c.resolve(a),s.markClean())}),c},s.getEditor=function(){return e},s.setEditor=function(a){e=a},s.setQuit(function(){var a=$.Deferred(),b=function(){for(var a in p)p[a].destroy();s=c=e=q=p=null};return s.getState()===s.STATES.DIRTY?require(["io.ox/core/tk/dialogs"],function(c){(new c.ModalDialog).text(k("Do you really want to cancel editing this mail?")).addPrimaryButton("delete",k("Lose changes")).addAlternativeButton
("savedraft",k("Save as draft")).addButton("cancel",k("Cancel")).show().done(function(c){c==="delete"?(b(),a.resolve()):c==="savedraft"?s.saveDraft().done(function(){b(),a.resolve()}).fail(function(b){a.reject(b)}):a.reject()})}):(b(),a.resolve()),a}),s}return n={getApp:o},g.get({id:d.get("identifier")}).done(function(a){l=['"'+a.display_name+'"',a.email1]}).pipe(function(){return n})})