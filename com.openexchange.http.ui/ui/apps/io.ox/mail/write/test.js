define("io.ox/mail/write/test",["io.ox/mail/write/main","io.ox/mail/api","io.ox/core/api/user","io.ox/core/config","io.ox/core/extensions","io.ox/mail/write/test/html_send","io.ox/mail/write/test/text_send","io.ox/mail/write/test/html_reply","io.ox/mail/write/test/text_reply","io.ox/mail/write/test/html_forward","io.ox/mail/write/test/text_forward"],function(a,b,c,d,e){var f=ox.base+"/apps/io.ox/mail/write/test",g=5e3;"use strict";function h(){var a=function(){return a.value};return a.value=!1,a.
yep=function(){a.value=!0},a}function i(a){return $.trim((a+"").replace(/[\r\n]+/g,""))}e.point("test/suite").extend({id:"mail-compose",index:100,test:function(e){e.describe("Compose email",function(){var f,i,k=null,l=null,m=null;e.it("opens compose dialog in HTML mode",function(){var b=new h;e.waitsFor(b,"compose dialog",g),a.getApp().launch().done(function(){k=this,k.compose().done(function(){k.setFormat("html").done(function(){l=k.getEditor(),m=k.getWindow().nodes.main.find("form"),b.yep(),e.expect
(l).toBeDefined(),e.expect(m).toBeDefined(),e.expect(l.getMode()).toEqual("html")})})})}),e.it("adds recipient",function(){var a;m.find("input[data-type=to]").val("otto.xentner@io.ox").focus().trigger($.Event("keyup",{which:13})),a=m.find(".recipient-list input[type=hidden][name=to]"),e.expect(a.val()).toEqual('"otto.xentner" <otto.xentner@io.ox>')}),e.it("adds recipient with display name",function(){var a;m.find("input[data-type=to]").val('"Otto X." <otto.xentner@io.ox>').focus().trigger($.Event
("keyup",{which:13})),a=m.find(".recipient-list input[type=hidden][name=to]").last(),e.expect(a.val()).toEqual('"Otto X." <otto.xentner@io.ox>')}),e.it("adds recipient by focussing another element",function(){var a;m.find("input[data-type=to]").val('"Otto;must escape,this" <otto.xentner@io.ox>').focus().blur(),a=m.find(".recipient-list input[type=hidden][name=to]").last(),e.expect(a.val()).toEqual('"Otto;must escape,this" <otto.xentner@io.ox>')}),e.it("adds multiple recipients at once",function()
{var a;m.find("input[data-type=to]").val(' "Otto;must escape,this" <otto.xentner@io.ox>; "Hannes" <hannes@ox.io>, '+"Horst <horst@ox.io>;, ").focus().blur(),a=m.find(".recipient-list input[type=hidden][name=to]").slice(-3),e.expect(!0).toEqual(a.eq(0).val()==='"Otto;must escape,this" <otto.xentner@io.ox>'&&a.eq(1).val()==='"Hannes" <hannes@ox.io>'&&a.eq(2).val()==='"Horst" <horst@ox.io>')}),e.it("opens CC section",function(){var a;m.find("[data-section-link=cc]").trigger("click"),a=m.find("[data-section=cc]:visible"
),e.expect(a.length).toEqual(1)}),e.it("adds recipient to CC",function(){var a;m.find("input[data-type=cc]").val("otto.xentner@io.ox").focus().trigger($.Event("keyup",{which:13})),a=m.find(".recipient-list input[type=hidden][name=cc]"),e.expect(a.val()).toEqual('"otto.xentner" <otto.xentner@io.ox>')}),e.it("opens BCC section",function(){var a;m.find("[data-section-link=bcc]").trigger("click"),a=m.find("[data-section=bcc]:visible"),e.expect(a.length).toEqual(1)}),e.it("adds recipient to BCC",function(
){var a;m.find("input[data-type=bcc]").val("hannes@io.ox").focus().trigger($.Event("keyup",{which:13})),a=m.find(".recipient-list input[type=hidden][name=bcc]"),e.expect(a.val()).toEqual('"hannes" <hannes@io.ox>')}),e.it("removes recipient from BCC",function(){var a,b=m.find(".recipient-list input[type=hidden][name=bcc]");b.parent().find("a.remove").trigger("click"),a=m.find(".recipient-list input[type=hidden][name=bcc]"),e.expect(!0).toEqual(b.length===1&&a.length===0)}),e.it("closes BCC section"
,function(){var a;m.find("[data-section-label=bcc]").trigger("click"),a=m.find("[data-section=bcc]:visible"),e.expect(a.length).toEqual(0)}),e.it("sets high priority",function(){var a;m.find("input[name=priority]").eq(0).focus().prop("checked",!0).trigger("change").blur(),a=m.find(".priority-overlay"),e.expect(a.hasClass("high")).toEqual(!0)}),e.it("sets subject",function(){m.find("input.subject").val("TEST: Hello World"),e.expect(m.find("input[name=subject]").val()).toEqual("TEST: Hello World")}
),e.it("sets editor content",function(){l.setContent(" <p>Lorem ipsum</p>\r\n "),e.expect(l.getContent()).toEqual("<p>Lorem ipsum</p>")}),e.it("has correct mail body",function(){var a=k.getMail().data;e.expect(a.attachments&&a.attachments.length&&a.attachments[0].content_type==="text/html").toEqual(!0),e.expect(a.attachments[0].content).toEqual("<p>Lorem ipsum</p>")}),e.it("has correct mail props (bcc)",function(){var a=k.getMail().data;e.expect(_.isArray(a.bcc)&&a.bcc.length===0).toEqual(!0)}),e
.it("has correct mail props (cc)",function(){var a=k.getMail().data;e.expect(_.isArray(a.cc)&&a.cc.length===1&&a.cc[0][0]==='"otto.xentner"'&&a.cc[0][1]==="otto.xentner@io.ox").toEqual(!0)}),e.it("has correct mail props (delivery receipt)",function(){var a=k.getMail().data;e.expect(a.disp_notification_to===0).toEqual(!0)}),e.it("has correct mail props (from)",function(){var a=k.getMail().data;e.expect(_.isArray(a.from)&&a.from.length===1).toEqual(!0)}),e.it("has correct mail props (priority)",function(
){var a=k.getMail().data;e.expect(a.priority===1).toEqual(!0)}),e.it("has correct mail props (subject)",function(){var a=k.getMail().data;e.expect(a.subject==="TEST: Hello World").toEqual(!0)}),e.it("has correct mail props (to)",function(){var a=k.getMail().data;e.expect(_.isArray(a.to)&&a.to.length===6&&a.to[4][0]==='"Hannes"'&&a.to[4][1]==="hannes@ox.io").toEqual(!0)}),e.it("has correct mail props (vcard)",function(){var a=k.getMail().data;e.expect(a.vcard===0).toEqual(!0)}),f={},_.browser.IE||
(e.it("sends mail successfully",function(){var a=k.getMail().data,l=new h,m=d.get("identifier");e.waitsFor(l,"mail being send",g),c.get({id:m}).done(function(c){a.to=[['"'+c.display_name+'"',c.email1]],a.cc=[],a.bcc=[],i=a,b.send(a).always(function(a){l.yep(),f=String(a.data),e.expect(a.error).toBeUndefined()})})}),e.it("verifies that sent mail is ok",function(){var a=new h,c=i,d=f.split(/\/(\d+$)/);e.waitsFor(a,"mail being fetched",g),b.get({folder:d[0],id:d[1]}).done(function(b){a.yep(),e.expect
(_.isEqual(b.subject,c.subject)&&_.isEqual(b.from,c.from)&&_.isEqual(b.to,c.to)&&_.isEqual(b.cc,c.cc)&&_.isEqual(b.bcc,c.bcc)&&_.isEqual(b.priority,c.priority)&&_.isEqual(b.disp_notification_to||undefined,c.disp_notification_to||undefined)&&_.isEqual(b.vcard||undefined,c.vcard||undefined)).toEqual(!0)})})),e.it("closes compose dialog",function(){k.markClean(),k.quit(!0),e.expect(k.getEditor).toBeUndefined(),k=l=m=null})})}}),e.point("test/suite").extend({id:"mail-editor",index:200,test:function(b
){b.describe("Mail editor",function(){var c=null,d=null;b.it("opens compose dialog in TEXT mode",function(){var e=new h;b.waitsFor(e,"compose dialog",g),a.getApp().launch().done(function(){c=this,c.compose().done(function(){c.setFormat("text").done(function(){d=c.getEditor(),e.yep(),b.expect(d).toBeDefined(),b.expect(d.getMode()).toEqual("text")})})})}),b.it("sets TEXT content",function(){d.setContent("  Hallo Welt\nLine #1\nLine #3\n\nNext paragraph\n\n"),b.expect(d.getContent()).toEqual("Hallo Welt\nLine #1\nLine #3\n\nNext paragraph"
)}),b.it("appends TEXT content",function(){d.appendContent("---\nCould be a signature"),b.expect(d.getContent()).toEqual("Hallo Welt\nLine #1\nLine #3\n\nNext paragraph\n\n---\nCould be a signature")}),b.it("removes TEXT",function(){d.replaceParagraph("---\nCould be a signature",""),b.expect(d.getContent()).toEqual("Hallo Welt\nLine #1\nLine #3\n\nNext paragraph")}),b.it("clears all content",function(){d.clear(),b.expect(d.getContent()).toEqual("")}),b.it("scrolls to bottom",function(){d.setContent
((new Array(500)).join("All work and no play makes Bart a dull boy\n")),d.scrollTop("bottom"),b.expect(d.scrollTop()).toBeGreaterThan(0)}),b.it("scrolls back to top",function(){d.scrollTop("top"),b.expect(d.scrollTop()).toEqual(0)}),b.it("replaces TEXT properly",function(){d.setContent("All work and no play makes Bart a dull boy"),d.replaceParagraph("Bart","me"),b.expect(d.getContent()).toEqual("All work and no play makes me a dull boy")}),b.it("changes editor mode to HTML",function(){var a=new h
;b.waitsFor(a,"HTML mode",g),c.setFormat("html").done(function(){d=c.getEditor(),a.yep(),b.expect(d.getContent()).toEqual("<p>All work and no play makes me a dull boy</p>")})}),b.it("sets HTML content",function(){d.setContent("<p>Hello World<br>Line #2</p><p></p><p><br><p>"),b.expect(d.getContent()).toEqual("<p>Hello World<br>Line #2</p>")}),b.it("appends TEXT content in HTML mode properly",function(){d.appendContent("Yeah\nI am just plain text"),b.expect(d.getContent()).toEqual("<p>Hello World<br>Line #2</p><p>Yeah<br>I am just plain text</p>"
)}),b.it("removes a specific paragraph",function(){d.replaceParagraph("<p>Yeah<br>I am just plain text</p>",""),b.expect(d.getContent()).toEqual("<p>Hello World<br>Line #2</p>")}),b.it("appends HTML content in HTML mode properly",function(){d.appendContent("<p>Yeah<br>I am just plain text</p><p></p>"),b.expect(d.getContent()).toEqual("<p>Hello World<br>Line #2</p><p>Yeah<br>I am just plain text</p>")}),b.it("clears all content",function(){d.clear(),b.expect(d.getContent()).toEqual("")}),b.it("scrolls to bottom"
,function(){d.setContent((new Array(500)).join("All work and no play makes Bart a dull boy<br>")),d.scrollTop("bottom"),b.expect(d.scrollTop()).toBeGreaterThan(0)}),b.it("scrolls back to top",function(){d.scrollTop("top"),b.expect(d.scrollTop()).toEqual(0)}),b.it("replaces a specific paragraph",function(){d.setContent("<p>All work and no play makes me a dull boy</p>"),d.replaceParagraph("<p>All work and no play makes me a dull boy</p>","<p>YEAH</p>"),b.expect(d.getContent()).toEqual("<p>YEAH</p>"
)}),b.it("switches back to TEXT mode",function(){var a;d.setContent("<p><b>Paragraph &lt;#1&gt;</b><br>Line #2</p><h1>Headline</h1><p>Paragraph #2</p>"),a=new h,b.waitsFor(a,"TEXT mode",g),c.setFormat("text").done(function(){d=c.getEditor(),a.yep(),b.expect(d.getMode()).toEqual("text"),b.expect(d.getContent()).toEqual("Paragraph <#1>\nLine #2\n\nHeadline\n\nParagraph #2")})}),b.it("switches back to HTML mode",function(){var a=new h;b.waitsFor(a,"HTML mode",g),c.setFormat("html").done(function(){d=
c.getEditor(),a.yep(),b.expect(d.getContent()).toEqual("<p>Paragraph &lt;#1&gt;<br>Line #2</p><p>Headline</p><p>Paragraph #2</p>")})}),b.it("switches back and forth between TEXT and HTML mode (robustness test)",function(){var a,e;c.setFormat("text"),c.setFormat("html"),c.setFormat("html"),c.setFormat("text"),c.setFormat("text"),c.setFormat("html"),a=new h,b.waitsFor(a,"checkpoint #1",g),c.setFormat("text").done(function(){d=c.getEditor(),a.yep(),b.expect(d.getContent()).toEqual("Paragraph <#1>\nLine #2\n\nHeadline\n\nParagraph #2"
)}),e=new h,b.waitsFor(e,"checkpoint #2",g),c.setFormat("html").done(function(){d=c.getEditor(),e.yep(),b.expect(d.getContent()).toEqual("<p>Paragraph &lt;#1&gt;<br>Line #2</p><p>Headline</p><p>Paragraph #2</p>")})}),b.it("closes compose dialog",function(){c.quit(!0),b.expect(c.getEditor).toBeUndefined(),c=d=null})})}}),e.point("test/suite").extend({id:"mail-paste",index:300,test:function(b){b.describe("Paste HTML contents",function(){var c=null,d=null;b.it("opens compose dialog",function(){var e=new 
h;b.waitsFor(e,"compose dialog",g),a.getApp().launch().done(function(){c=this,c.compose().done(function(){c.setFormat("html").done(function(){d=c.getEditor(),e.yep(),b.expect(d).toBeDefined(),b.expect(d.getMode()).toEqual("html")})})})}),b.it("inserts simple example",function(){b.runs(function(){d.clear(),d.paste("<p>Hello World</p>"),b.expect(d.getContent()).toEqual("<p>Hello World</p>")})}),b.it("removes text color",function(){b.runs(function(){d.clear(),d.paste('<p style="color: red">Hello World</p>'
),b.expect(d.getContent()).toEqual("<p>Hello World</p>")})}),b.it("does not mess up paragraphs and line-breaks",function(){d.clear(),d.paste("<p>Hello<br />World</p><p>one empty line, then this one</p>"),b.expect(d.getContent()).toEqual("<p>Hello<br>World</p><p>one empty line, then this one</p>")}),b.it("handles complex HTML right #1",function(){var a=new h;b.waitsFor(a,"external test data",g),$.when($.get(f+"/test_1a.html"),$.get(f+"/test_1b.html")).done(function(c,e){a.yep(),d.clear(),d.paste(c
[0]),b.expect(d.getContent()).toEqual(i(e[0]))})}),b.it("handles complex HTML right #2",function(){var a=new h;b.waitsFor(a,"external test data",g),$.when($.get(f+"/test_2a.html"),$.get(f+"/test_2b.html")).done(function(c,e){a.yep(),d.clear(),d.paste(c[0]),b.expect(d.getContent()).toEqual(i(e[0]))})}),b.it("closes compose dialog",function(){c.quit(!0),b.expect(c.getEditor).toBeUndefined(),c=d=null})})}})})