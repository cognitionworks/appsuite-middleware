define("io.ox/mail/api",["io.ox/core/http","io.ox/core/config","io.ox/core/cache","io.ox/core/api/factory","io.ox/core/api/folder","io.ox/core/api/account"],function(a,b,c,d,e){var f,g,h,i,j,k,l={},m={},n={},o=b.get("modules.mail.defaultseparator","/"),p=function(a){var b=a.folder_id+"."+a.id;return b in l?l[b].length-1:0},q=function(a){var b=a.folder_id+"."+a.id;return b in n?n[b]:0},r=function(a){var b=a.folder_id+"."+a.id;return b in m?m[b]:""},s=function(a){var b=r(a);b in n&&(n[b]=Math.max(0
,n[b]-1))},t=function(a){var b=r(a);b in n&&n[b]++},u={},v=function(a){var b=a.folder_id+"."+a.id;return b in u&&("flags"in a&&(u[b].flags=a.flags),"color_label"in a&&(u[b].color_label=a.color_label)),a},w=function(a){if(a){var b=a.folder_id+"."+a.id,c;b in u&&(c=u[b],a.flags=c.flags,a.color_label=c.color_label)}return a},x=d({module:"mail",requests:{all:{folder:"default0/INBOX",columns:"601,600,611",sort:"610",order:"desc",deleted:"false",cache:!0},list:{action:"list",columns:"102,600,601,602,603,604,607,610,611,614"
},get:{action:"get",view:"noimg",embedded:"true"},getUnmodified:{action:"get",unseen:"true",view:"html",embedded:"true"},search:{action:"search",folder:"default0/INBOX",columns:"601,600",sort:"610",order:"desc",getData:function(a){return[{col:603,pattern:a},{col:607,pattern:a}]}}},fail:{get:function(a,b){a.code==="MSG-0032"&&x.remove([b],!0)}},filter:function(a){return a.folder_id!==undefined},pipe:{all:function(a,b){return e.setUnread(b.folder,a.unreadCount||0),a},allPost:function(a){return _(a)
.each(function(a){u[a.folder_id+"."+a.id]={flags:a.flags,color_label:a.color_label}}),a},listPost:function(a){return _(a).each(w),a},get:function(a){return u[a.folder_id+"."+a.id]={flags:a.flags,color_label:a.color_label},a.unseen&&(s(a),e.decUnread(a)),a},getPost:function(a){return w(a)}}});"use strict",x.SENDTYPE={NORMAL:1,REPLY:2,FORWARD:3,DRAFT:4},x.FLAGS={ANSWERD:1,DELETED:2,DRAFT:4,FLAGGED:8,RECENT:16,SEEN:32,USER:64,FORWARDED:128},x.COLORS={NONE:0,RED:1,BLUE:2,GREEN:3,GREY:4,BROWN:5,AQUA:6
,ORANGE:7,PINK:8,LIGHTBLUE:9,YELLOW:10},f={},x.getAllThreads=function(a,b){var c,d;return a=a||{},a=$.extend(a,{action:"threadedAll",columns:"601,600,611,102",sort:a.sort||"610",sortKey:"threaded-"+(a.sort||"610"),order:a.order||"desc",includeSent:!1}),console.log("time.pre","t1",(c=_.now())-ox.t0,new Date(_.now())),b==="auto"&&(b=a.cache=f[a.folder]!==!1),this.getAll(a,b).done(function(b){_(b).each(function(b){var c=b.folder_id+"."+b.id;l[c]=[a.order].concat(a.order==="desc"?b.thread:b.thread.slice
().reverse()),n[c]=b.unreadCount||0,_(b.thread).each(function(a){a=String(a).indexOf(".")>-1?a:b.folder_id+"."+a,m[a]=c})}),console.log("time.post","#",b.length,"t2",(d=_.now())-ox.t0,"took",d-c),f[a.folder]=!0})},x.getThread=function(a){var b,c,d,e,f,g,h;return typeof a=="string"?(b=a,a=a.split(/\./),a={folder_id:c=a[0],id:a[1]}):(b=(c=a.folder_id)+"."+a.id,a={folder_id:c,id:a.id}),b in l&&(e=l[b].slice()).length?(f=e.shift(),g=e.length,d=c.split(o,2)[0],h=_(e).map(function(a,e){var h=f==="desc"?
g-e:e+1,i=a.split(o);return c=i.length>1?d+o+i.slice(0,-1).join(o):c,a=i.slice(-1).join(""),{folder_id:c,id:a,threadKey:b,threadPosition:h,threadSize:g}})):(a.threadKey=b,a.threadPosition=1,a.threadSize=1,h=[a]),h},x.getThreadOrder=function(a){var b=typeof a=="string"?a:a.folder_id+"."+a.id;return b in l?l[b][0]:"desc"},x.getThreads=function(a){return this.getList(a).pipe(function(a){var b,c;a=_.deepClone(a),b=0;for(;c=a[b];b++)c.threadSize=p(c),c.unreadCount=q(c);return a})},g=function(b,c,d){b=
_.isArray(b)?b:[b],a.pause();var e="flags"in c&&"value"in c,f=function(a){if("flags"in a)return c.value?a.flags=a.flags|c.flags:a.flags=a.flags&~c.flags,v(a),$.when(x.caches.list.merge(a),x.caches.get.merge(a));else return $.when()};return e&&$.when.apply($,_(b).map(f)).done(function(){x.trigger("refresh.list")}),_(b).map(function(b){return a.PUT({module:"mail",params:{action:d,id:b.id,folder:b.folder||b.folder_id},data:c,appendColumns:!1}).pipe(function(){if(!e)return"color_label"in c&&(b.color_label=
c.color_label,v(b)),$.when(x.caches.get.remove(b),x.caches.list.remove(b))})}),a.resume().done(function(){e||x.trigger("refresh.list")})},h=function(a,b){return function(){var c=a.folder_id||a.folder;return $.when(x.caches.get.remove(a),x.caches.get.remove(c),x.caches.list.remove(a),x.caches.list.remove(c),x.caches.all.grepRemove(c+"\t"),x.caches.all.grepRemove(b+"\t"))}},i=function(a){$.when.apply($,a).done(function(){x.trigger("refresh.all refresh.list")})},x.update=function(a,b){return g(a,b,"update"
)};function y(a,b,c,d){return a.grepKeys(b+"\t").pipe(function(b){return $.when.apply($,_(b).each(function(b){return a.get(b).pipe(function(e){if(e)return _(e).each(function(a){var b=a.folder_id+"."+a.id;b in c&&(a.flags=a.flags&d)}),a.add(b,e);else return $.when()})}))})}function z(a,b,c,d,f){return x.getList(a).pipe(function(a){var g={},h={};return a=_(a).filter(function(a){if((a.flags&32)===b)return g[a.folder_id]=h[a.folder_id+"."+a.id]=!0;else return!1}),$.when.apply($,_(g).map(function(a,b)
{return y(x.caches.all,b,h,c)})).pipe(function(){return x.update(a,{flags:x.FLAGS.SEEN,value:d}).pipe(function(){return e[f](a),g=h=null,a})})})}x.markUnread=function(a){return z(a,32,~32,!1,"incUnread").done(function(a){_(a).each(t),x.trigger("refresh.list")})},x.markRead=function(a){return z(a,0,32,!0,"decUnread").done(function(a){_(a).each(s),x.trigger("refresh.list")})},x.move=function(a,b){return x.update(a,{folder_id:b}).pipe(function(){return a=_.isArray(a)?a:[a],_(a).map(function(a){return h
(a,b)()})}).done(i)},x.copy=function(a,b){return g(a,{folder_id:b},"copy").pipe(h(a,b)).done(i)},j=function(b,c,d){return a.PUT({module:"mail",params:{action:b||"",view:d||"text"},data:_([].concat(c)).map(function(a){return x.reduce(a)}),appendColumns:!1}).pipe(function(a){var b="",c="",e;return a.attachments&&a.attachments.length?a.attachments[0].content!==""&&(a.attachments[0].content_type==="text/plain"?($("<div>").html(a.attachments[0].content.replace(/<(?!br)/ig,"&lt;")).contents().each(function(
){this.tagName==="BR"?b+="\n":b+=$(this).text()}),b=$.trim(b),d==="html"?(b=b.replace(/</ig,"&lt;"),_(b.split(/\n/).concat("\n")).each(function(a){/^> /.test(a)?c+=a.substr(2)+"\n":(e+=(c!==""?"<blockquote><p>"+c+"</p></blockquote>":"")+a+"\n",c="")}),a.attachments[0].content=$.trim(e).replace(/\n/g,"<br>")):a.attachments[0].content=$.trim(b)):a.attachments[0].content_type==="text/html"&&(e=document.createElement("DIV"),e.innerHTML=a.attachments[0].content,_(e.getElementsByTagName("BLOCKQUOTE")).
each(function(a){a.removeAttribute("style")}),a.attachments[0].content=e.innerHTML,e=null)):(a.attachments=a.attachments||[{}],a.attachments[0].content=""),a})},x.getUnmodified=function(a){var b,c;if("folder_id"in a||"folder"in a)return this.get({action:"get",id:a.id,folder:a.folder||a.folder_id,view:"html"},!1);else if("parent"in a)return b=a.id,c=a.parent,this.get({action:"get",id:a.parent.id,folder:a.parent.folder||a.parent.folder_id,view:"html"},!1).pipe(function(a){return _.chain(a.nested_msgs
).filter(function(a){if(a.id===b)return a.parent=c,!0;else return!1}).first().value()});else return console.error("api.getUnmodified(). Invalid case.",a),$.Deferred().resolve(a)},x.getSource=function(a){return this.get({action:"get",id:a.id,src:1,folder:a.folder||a.folder_id,view:"html"},!1)},x.replyall=function(a,b){return j("replyall",a,b)},x.reply=function(a,b){return j("reply",a,b)},x.forward=function(a,b){return j("forward",a,b)},x.send=function(a,b){var c=$.Deferred();return Modernizr.file?
A(a,b,c):B(a,b,c),c};function A(b,c,d){var e=new FormData,f=function(a){return'"'+a[0].replace(/^["']+|["']+$/g,"")+'" <'+a[1]+">"};b=_.clone(b),b.from=_(b.from).map(f).join(", "),b.to=_(b.to).map(f).join(", "),b.cc=_(b.cc).map(f).join(", "),b.bcc=_(b.bcc).map(f).join(", "),e.append("json_0",JSON.stringify(b)),_(c).each(function(a,b){e.append("file_"+b,a)}),a.UPLOAD({module:"mail",params:{action:"new"},data:e,dataType:"text"}).done(function(a){var b=a.indexOf("{"),c=a.lastIndexOf("}");b>-1&&c>-1?
d.resolve(JSON.parse(a.substr(b,c-b+1))):d.resolve({}),setTimeout(function(){x.getAllThreads({},!1).done(function(){x.trigger("refresh.all")})},3e3)}).fail(d.reject)}function B(a,b,c){var d,e,f,g=$(".io-ox-mail-write form"),h=function(a){return'"'+a[0].replace(/^["']+|["']+$/g,"")+'" <'+a[1]+">"};a=_.clone(a),a.from=_(a.from).map(h).join(", "),a.to=_(a.to).map(h).join(", "),a.cc=_(a.cc).map(h).join(", "),a.bcc=_(a.bcc).map(h).join(", "),d=0,$(":input:enabled",g).each(function(a,b){var c=$(b);c.attr
("type")==="file"&&(c.attr("name","file_"+d),d++)}),$('input[name="json_0"]',g).length===0?$(g).append($("<input>",{type:"hidden",name:"json_0",value:JSON.stringify(a)})):$('input[name="json_0"]',g).val(JSON.stringify(a)),e="iframe_"+_.now(),f=$("<iframe>",{name:e,id:e,height:1,width:1}),$(".io-ox-mail-write").append(f),$(g).attr({method:"post",action:ox.apiRoot+"/mail?action=new&session="+ox.session,target:e}),$(g).submit(),window.callback_new=function(a){$("#"+e).remove(),c.resolve(a),window.callback_new=
null}}x.saveAttachments=function(c,d){return d=d||b.get("folder.infostore"),c=_.isArray(c)?c:[c],a.pause(),_(c).each(function(b){a.PUT({module:"mail",params:{action:"attachment",id:b.mail.id,folder:b.mail.folder_id,dest_folder:d,attachment:b.id},data:{folder_id:d,description:"Saved mail attachment"},appendColumns:!1})}),a.resume().done(function(){require(["io.ox/files/api"],function(a){a.caches.all.grepRemove(d+"\t"),a.trigger("refresh.all")})})},x.getUrl=function(a,b){var c,d=ox.apiRoot+"/mail";
if(b==="zip")return c=_(a).first(),d+"?"+$.param({action:"zip_attachments",folder:(c.parent||c.mail).folder_id,id:(c.parent||c.mail).id,attachment:_(a).pluck("id").join(","),session:ox.session});else{d+=(a.filename?"/"+encodeURIComponent(a.filename):"")+"?"+$.param({action:"attachment",folder:(a.parent||a.mail).folder_id,id:(a.parent||a.mail).id,attachment:a.id});switch(b){case"view":case"open":return d+"&delivery=view";case"download":return d+"&delivery=download";default:return d}}},k=0,x.refresh=
function(){ox.online&&(_(f).each(function(a,b){f[b]=!1}),a.GET({module:"mail",params:{action:"all",folder:"default0/INBOX",columns:"610",unseen:"true",deleted:"false",sort:"610",order:"desc"}}).done(function(a){var b;a.length&&(b=_(a).filter(function(a){return a.received_date>k}),b.length&&(x.trigger("new-mail",b),k=b[0].received_date),x.trigger("unseen-mail",a)),x.trigger("refresh.all")}))};function C(a,b){var c=x.caches.all;return c.grepKeys(a+"\t").pipe(function(a){return c.get(a).pipe(function(
d){if(d)return c.add(a,_(d).map(b));else return $.when()})})}return x.prepareRemove=function(a){return $.when.apply($,_(a).map(function(b,c){var d,e,f,g=b.threadKey;if(g in l){d=_.cid(g),e=l[g],f=_(e).indexOf(b.id),a.splice(c,1);if(f===1)return C(d.folder_id,function(a){return a.id===d.id&&(a.thread=_(a.thread).without(b.id),a.id=_(a.thread).first()),a});else return C(d.folder_id,function(a){return a.id===d.id&&(a.thread=_(a.thread).without(b.id)),a})}else return $.when()}))},x})