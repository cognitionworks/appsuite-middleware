define("io.ox/preview/main",["io.ox/core/extensions","gettext!io.ox/preview/preview"],function(a,b){var c,d,e,f=Modernizr.draganddrop&&_.browser.Chrome,g=$.noop,h=$.noop;"use strict",f?(g=function(a){a.on("dragstart",function(a){a.originalEvent.dataTransfer.setData("DownloadURL",this.dataset.downloadurl)})},h=function(a,b){var c=$("<a>",{draggable:!0}).attr("data-downloadurl",a.mimetype+":"+a.name+":"+ox.abs+a.dataURL+"&delivery=download");return b?c.on("click",b):c.attr({href:a.dataURL+"&delivery=view"
,target:"_blank"}),c}):h=function(a,b){var c=$("<a>",{href:a.dataURL+"&delivery=view",target:"_blank"});return b&&c.on("click",b),c},c={point:a.point("io.ox/preview/engine"),getByExtension:function(a){return this.point.chain().find(function(b){var c=b.metadata("supports");return c=_.isArray(c)?c:[c],_(c).contains(a)}).value()}},d=function(a){_.extend(this,a),a.omitDragoutAndClick||(this.draw=function(c){var d;a.omitClick?d=$("<div>"):(d=h(c),f?d.attr("title",b("Click to open. Drag to your desktop to download."
)):d.attr("title",b("Click to open."))),a.draw.apply(d,arguments),g(d,c),this.append(d)})},c.point.extend(new d({id:"image",index:10,supports:["png","jpg","jpeg","gif","bmp"],draw:function(a,b){var c={width:b.width||400,height:b.height||400,scaleType:b.scaleType||"contain",delivery:"view"};b.height==="auto"&&delete c.height,this.append($("<img>",{src:a.dataURL+"&"+$.param(c),alt:"Preview"}))}})),Modernizr.audio&&c.point.extend(new d({id:"audio",index:10,supports:function(){var a=[];return $.each(
Modernizr.audio,function(b){a.push(b)}),a}(),draw:function(a){$("<audio>").attr({controls:"controls",src:a.dataURL}).appendTo(this)}})),ox.serverConfig.previewExtensions&&c.point.extend(new d({id:"office",index:10,supports:ox.serverConfig.previewExtensions,draw:function(a){var b=h(a,function(b){b.preventDefault(),require(["io.ox/preview/officePreview"],function(b){b.draw(a)})});b.append($("<img>",{src:a.dataURL+"&format=preview_image&width=400&delivery=view",alt:"Preview"}).css({width:"400px",maxWidth
:"100%"}).addClass("io-ox-clickable")),g(b),this.append(b)},omitDragoutAndClick:!0})),c.point.extend(new d({id:"eml",supports:["eml","message/rfc822"],draw:function(a){var b=this;require(["io.ox/mail/view-detail"],function(c){var d=a.data.nested_message;b.append(c.draw(d).css("padding",0))})},omitClick:!0})),c.point.extend(new d({id:"text",supports:["txt","plain/text","asc","js","md"],draw:function(a){var b=this;$.ajax({url:a.dataURL,dataType:"text"}).done(function(a){b.css({fontFamily:"monospace"
,fontSize:"13px",width:"100%",padding:"13px",border:"1px dotted silver",boxSizing:"border-box",MozBoxSizing:"border-box",whiteSpace:"pre-wrap",MozUserSelect:"text",webkitUserSelect:"text",userSelect:"text",cursor:"auto"}).text(a)})},omitClick:!0})),e=function(a,b){var d=this;this.file=_.copy(a,!0),this.options=b||{},this.renderer=null,this.file.file_mimetype?this.file.mimetype=this.file.file_mimetype:this.file.mimetype||(this.file.mimetype="application/octet-stream"),this.file.filename&&(this.file
.name=this.file.filename),this.extension=function(){var a=String(d.file.name||"").match(/\.([a-z0-9]{2,})$/i);if(a&&a.length>0)return String(a[1]).toLowerCase();return""}();if(this.extension||this.file.mimetype)this.renderer=c.getByExtension(this.extension||this.file.mimetype)},e.prototype={getRenderer:function(){return this.renderer},supportsPreview:function(){return!!this.renderer},appendTo:function(a){this.supportsPreview()&&this.renderer.invoke("draw",a,this.file,this.options)}};function i(a)
{var b;_.extend(this,a),b=this,this.isEnabled||(this.isEnabled=function(c){var d;a.parseArguments&&(c=a.parseArguments.apply(b,arguments));if(!c)return!1;return d=new e(c,a),d.supportsPreview()}),this.draw||(this.draw=function(c){var d;a.parseArguments&&(c=a.parseArguments.apply(b,arguments));if(!c)return!1;d=new e(c,a),d.appendTo(this)})}return{Preview:e,Engine:d,Extension:i,protectedMethods:{clickableLink:h,dragOutHandler:g}}})