define("io.ox/core/commons",["io.ox/core/extPatterns/links"],function(a){var b={showWindow:function(a){return function(){var b=$.Deferred();return a.show(b.resolve),b}},multiSelection:function(){var b={};return function(c,d,e){if(e.length>1){d.idle().empty();var f=$("<div>");(b[c]||(b[c]=new a.InlineLinks({id:"inline-links",ref:c+"/links/inline"}))).draw.call(f,e),d.append($("<div>").addClass("io-ox-multi-selection").append($("<div>").addClass("summary").html("<b>"+e.length+"</b> elements selected"
),f.children().first()).center())}}}(),wireGridAndSelectionChange:function(a,c,d,e,f){var g="",h=function(a,b){_.cid(a.data.item)===_.cid(b)&&d(a.data.item)};f=f||$({}),a.selection.on("change",function(a,i){var j=i.length,k=JSON.stringify(_([].concat(i)).map(function(a){return{folder_id:String(a.folder_id||a.folder),id:String(a.id),recurrence_position:String(a.recurrence_position||0)}}));k!==g&&(f.off("update",h),j===1?(e.css("height",""),d(i[0]),f.on("update",{item:i[0]},h)):j>1?(e.css("height","100%"
),b.multiSelection(c,e,this.unfold())):e.css("height","").idle().empty(),g=k)})},wireGridAndAPI:function(a,b,c,d){a.setAllRequest(function(){return b[c||"getAll"]({folder:this.prop("folder")})}),a.setListRequest(function(a){return b[d||"getList"](a)})},wireGridAndWindow:function(a,b){var c=0;b.on("show idle",function(){a.selection.keyboard(!0),a.selection.get().length&&a.selection.retriggerUnlessEmpty()}).on("hide busy",function(){a.selection.keyboard(!1)}).on("beforeshow",function(){c!==null&&a.
scrollTop(c)}).on("beforehide",function(){c=a.scrollTop()}),b.app&&(b.app.getGrid=function(){return a})},wireFirstRefresh:function(a,b){a.getWindow().on("open",function(){b.needsRefresh(a.folder.get())&&b.trigger("refresh^",a.folder.get())})},wireGridAndRefresh:function(a,b,c){var d=function(){a.refresh(!0)},e=function(){console.log("refreshlist"),a.repaint().done(function(){a.selection.retrigger()})};c.on("show",function(){b.on("refresh.all",d).on("refresh.list",e).trigger("refresh.all")}).on("hide"
,function(){b.off("refresh.all",d).off("refresh.list",e)})},wireGridAndSearch:function(a,b,c){a.setAllRequest("search",function(){return c.search(b.search.query)}),a.setListRequest("search",function(a){return c.getList(a)}),b.on("search",function(){a.setMode("search")}),b.on("cancel-search",function(){a.setMode("all")})},addFolderSupport:function(a,b,c,d){a.folder.updateTitle(a.getWindow()).updateGrid(b).setType(c),b&&a.folder.updateGrid(b),a.getWindow().nodes.title.append($("<b>").addClass("caret"
)),a.getWindow().on("show",function(){b&&b.selection.retriggerUnlessEmpty(),_.url.hash("folder",a.folder.get())}),d=_.url.hash("folder")||d;if(d!==undefined)return a.folder.set(d);else return a.folder.setDefault();a.on("folder:change",function(){console.log("mmmh")})},addGridFolderSupport:function(a,b){a.folder.updateGrid(b),a.getWindow().on("show",function(){b.selection.retriggerUnlessEmpty()})},addFolderView:function(a,b){b=$.extend({width:330,rootFolderId:"1",type:undefined,view:"ApplicationFolderTree"
},b);var c,d=!1,e=!1,f=0,g,h,i,j,k,l,m;c=$("<div>").addClass("abs border-right").css({backgroundColor:"white",right:"auto",width:b.width+"px",zIndex:3}).hide().appendTo(a.getWindow().nodes.body),g=function(g,h){var i=h[0];i.module===b.type&&(a.folder.unset(),e?a.folder.set(i.id):(f=c.scrollTop(),c.fadeOut("fast",function(){a.folder.set(i.id)}),d=!1))},h=function(){return d||(c.show().scrollTop(f),d=!0),$.when()},i=function(){var b;e?(a.getWindow().nodes.body.css("left","0px"),c.css("left","0px"))
:(b=c.outerWidth(),a.getWindow().nodes.body.css("left",b+"px"),c.css("left",-b+"px")),e=!e},k=function(a){d?(f=c.scrollTop(),c.hide(),d=!1,e&&i()):(h(),a.altKey&&i())},j=function(a){a.isDefaultPrevented()||k(a)},m=function(d){var e=a.folderView=new d[b.view](c,{type:b.type,rootFolderId:b.rootFolderId});return e.selection.on("change",g),e.paint().done(function(){e.selection.set(a.folder.get(),!0),a.getWindow().nodes.title.on("click",j),c.idle(),m=l=null})},l=function(b){if(!b.isDefaultPrevented())
return c.busy(),k(b),a.showFolderView=h,a.getWindow().nodes.title.off("click",l),require(["io.ox/core/tk/folderviews"]).pipe(m)},a.showFolderView=l,a.folderView=null,a.getWindow().nodes.title.css("cursor","pointer").on("click",l)}};return"use strict",b})