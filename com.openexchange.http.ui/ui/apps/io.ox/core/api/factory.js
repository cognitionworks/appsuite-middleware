define("io.ox/core/api/factory",["io.ox/core/http","io.ox/core/cache","io.ox/core/event"],function(a,b,c){var d=function(a){var b=_.copy(a,!0);return b.folder=b.folder||b.folder_id,b},e="id: folder_id:folder folder: recurrence_position:".split(" ");return"use strict",function(f){var g,h,i;return f=$.extend(!0,{id:null,keyGenerator:null,module:"",requests:{all:{action:"all"},list:{action:"list"},get:{action:"get"},search:{action:"search"},remove:{action:"delete"}},done:{},fail:{},pipe:{},filter:null
},f||{}),f.id=f.id||f.module,g={all:new b.SimpleCache(f.id+"-all",!0),list:new b.ObjectCache(f.id+"-list",!0,f.keyGenerator),get:new b.ObjectCache(f.id+"-get",!0,f.keyGenerator)},h={},i={getAll:function(b,c,d){var e=$.extend({},f.requests.all,b||{}),j=e.folder+"\t"+(e.sortKey||e.sort)+"."+e.order+"."+e.limit;c=c===undefined?!0:!!c,d=d||g.all;var k=function(){return a.GET({module:f.module,params:e}).pipe(function(a){return(f.pipe.all||_.identity)(a,e)}).done(function(a){d.add(j,a)})},l=function(a)
{j in h||(h[j]=!0,setTimeout(function(){i.refresh()},3e3))};return(c?d.get(j,k,l):k()).pipe(f.pipe.allPost).done(f.done.all||$.noop)},getList:function(b,c){b=b?[].concat(b):[],f.filter&&(b=_(b).filter(f.filter)),c=c===undefined?!0:!!c;var d=function(){return a.fixList(b,a.PUT({module:f.module,params:f.requests.list,data:a.simplify(b)})).pipe(function(a){return(f.pipe.list||_.identity)(a)}).done(function(a){g.list.add(a),g.get.merge(a)})};if(b.length===0)return $.Deferred().resolve([]).done(f.done
.list||$.noop);else return(c?g.list.get(b,d):d()).pipe(f.pipe.listPost).done(f.done.list||$.noop)},get:function(b,c){var e=$.extend({},f.requests.get,b);c=c===undefined?!0:!!c;var h=function(){return a.GET({module:f.module,params:d(e)}).pipe(function(a){return(f.pipe.get||_.identity)(a,e)}).done(function(a){g.get.add(a),g.list.merge(a).done(function(b){b&&i.trigger("refresh.list",a)})}).fail(function(a){_.call(f.fail.get,a,e,f)})};return(c?g.get.get(e,h):h()).pipe(f.pipe.getPost).done(f.done.get||
$.noop)},updateCachesAfterRemove:function(a){a=a||[],a=_.isArray(a)?a:[a];var c={},d={},e=b.defaultKeyGenerator;_(a).each(function(a){c[e(a)]=d[a.folder_id]=!0}),console.log("updateCachesAfterRemove",a,c);var f=_(d).map(function(a,b){var d=g.all;return d.grepKeys(b+"\t").pipe(function(a){return d.get(a).pipe(function(b){if(b)return d.add(a,_(b).filter(function(a){return c[e(a)]!==!0}));else return $.when()})})});return a.length&&(f.push(g.list.remove(a)),f.push(g.get.remove(a))),$.when.apply($,f)
.done(function(){c=d=f=null})},prepareRemove:function(a){return $.when()},remove:function(b,c){b=b||[],b=_.isArray(b)?b:[b];var d=$.extend({},f.requests.remove,{timestamp:_.now()}),e=a.simplify(b),g=function(){i.trigger("delete",b)};return i.trigger("beforedelete",b),i.prepareRemove(b).pipe(function(){return console.log("remove -> updateCachesAfterRemove",b),i.updateCachesAfterRemove(b).pipe(function(){i.trigger("refresh.all");if(c!==!0)return a.PUT({module:f.module,params:d,data:e,appendColumns:!1
}).done(g);else return g()})})},needsRefresh:function(a,b,c){return g.all.keys(a+"\t"+b+"."+c).pipe(function(a){return a!==null})},reduce:function(a){return a?_(e).reduce(function(b,c){var d=c.split(":"),e=d[0],f=d[1]||d[0];return e in a&&(b[f]=a[e]),b},{}):a},caches:g},f.requests.search&&(i.search=function(b,c){var d=$.extend({},f.requests.search,c||{}),e=d.getData;return delete d.getData,a.PUT({module:f.module,params:d,data:e(b)})}),c.extend(i),i.refresh=function(){ox.online&&(i.caches.all.clear
(),i.caches.list.clear(),i.trigger("refresh.all"))},ox.on("refresh^",function(){i.refresh()}),i}})