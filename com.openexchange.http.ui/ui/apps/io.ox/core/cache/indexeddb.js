define("io.ox/core/cache/indexeddb",function(){var a,b,c,d="oxcache",e=String(ox.base).split("=")[1].split(".").join(""),f=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB,g=window.IDBDatabase||window.mozIDBDatabase||window.webkitIDBDatabase,h=window.IDBKeyRange||window.webkitIDBKeyRange,i=window.IDBTransaction||window.webkitIDBTransaction,j=[],k={},l=30*60*1e3,m=2*24*60*60*1e3;"use strict";function n(a){var c,d=a.db;d.objectStoreNames.contains(b)&&d.deleteObjectStore(b),c=d.createObjectStore
(b,{keyPath:"key"},!0),c.createIndex("accesstime","data.accesstime",{unique:!1}),d.transaction([],i.VERSION_CHANGE)}function o(a){var b,c=$.Deferred();try{_.isFunction(g.prototype.setVersion)?b=f.open(a):b=f.open(a,e,n),b.onsuccess=function(b){var d=b.target.result;j[a]=d,d.onversionchange=function(){d.close(),j[a]=d=null},c.resolve(d)},b.onerror=function(a){console.log("indexedDB.open error",a),c.reject(a)}}catch(d){console.log("opendb EXCEPTION",d),c.reject(d)}return c}function p(a){var b=new $
.Deferred;return!j[a]||j[a].constuctor!==window.IDBDatabase?o(a).done(function(a){b.resolve(a)}).fail(function(a){console.log("getConnection reject",a),b.reject(a)}):b.resolve(j[a]),b}function q(a,b){var c=new $.Deferred;return p(a).done(function(a){var d;!a.version||""+a.version!=""+e||!a.objectStoreNames.contains(b)?_.isFunction(a.setVersion)?(d=a.setVersion(e),d.onsuccess=function(){var d;a.objectStoreNames.contains(b)&&a.deleteObjectStore(b),d=a.createObjectStore(b,{keyPath:"key"},!0),d.createIndex
("accesstime","accesstime",{unique:!1}),c.resolve(a)},d.onerror=function(a){console.log("checkStore requestV error",a),c.reject(a)},d.onblocked=function(a){console.log("checkStore requestV block",a),c.reject(a)}):c.resolve(a):c.resolve(a)}).fail(function(a){console.log("checkStore reject",a),c.reject(a)}),c}function r(a,b){var c=new $.Deferred;return q(a,b).done(function(a){var d,e,f;try{d=(new Date).getTime(),e=a.transaction(b,i.READ_WRITE),e.oncomplete=function(){var a=(new Date).getTime()},e.onabort=
function(){var a=(new Date).getTime()},e.onerror=function(){var a=(new Date).getTime()},f=e.objectStore(b),c.resolve(f)}catch(g){console.log("getStore inner reject",g),c.reject(g)}}).fail(function(a){console.log("getStore reject",a),c.reject(a)}),c}function s(){return r("oxcache",b)}return c={setId:function(c){a=c,b="cache_"+a},getId:function(){return a},getStorageLayerName:function(){return"cache/indexeddb"},isUsable:function(){return Modernizr.indexeddb},gc:function(){return s().pipe(function(a
){var b=k[a.name],c=_.now();if(_(b).isUndefined()||c>b+l){k[a.name]=c,console.log("GC RUN",a.name);var d=h.upperBound(c-m),e=a.index("accesstime"),f=e.openKeyCursor(d);return f.onsuccess=function(b){var c=b.target.result;c&&(console.log("DELETE",c.primaryKey),a["delete"](c.primaryKey),c["continue"]())},f.onerror=function(a){console.log("cursor error",a)},f}else return null})},clear:function(){return s().pipe(function(a){var b=new $.Deferred,c=a.clear();return c.onsuccess=function(a){b.resolve()},
c.onerror=function(){b.reject()},b})},get:function(a){return c.gc(),s().pipe(function(b){var d=new $.Deferred;try{var e=b.get(a);e.onsuccess=function(b){_.isUndefined(b.target.result)||_.isUndefined(b.target.result.data)?d.resolve(null):(c.set(a,null,!0),d.resolve(b.target.result.data))},e.onerror=function(a){d.reject(a)}}catch(f){console.error("get exception > ",f)}return d})},set:function(a,b,d){return c.gc(),s().pipe(function(c){var e=$.Deferred(),f=c.get(a);return f.onsuccess=function(f){var g=
f.target.result;if(_.isUndefined(g))if(d===!0)e.reject();else{var h=c.add({key:a,data:b,accesstime:_.now()});h.onsuccess=function(a){e.resolve(a.target.result)},h.onerror=function(a){e.reject(a)}}else{d===!0&&(b=g.data);var i=c.put({key:a,data:b,accesstime:_.now()});i.onsuccess=function(a){e.resolve(a.target.result)},i.onerror=function(a){e.reject(a)}}},f.onerror=function(a){e.reject(a)},e})},remove:function(a){return s().pipe(function(b){var c=new $.Deferred,d=b["delete"](a);return d.onsuccess=function(
a){c.resolve()},d.onerror=function(){c.reject()},c})},keys:function(){return c.gc(),s().pipe(function(a){var b=new $.Deferred;if(_.isFunction(a.getAll)){var c=a.getAll();c.onsuccess=function(a){var c=_.chain(a.target.result).pluck("key").value();b.resolve(c)},c.onerror=function(a){b.reject()}}else{var d=[],e=a.openCursor();e.onsuccess=function(a){var c=a.target.result;c?(d.push(c.key),c["continue"]()):b.resolve(d)},e.onerror=function(a){b.reject(a)}}return b})}},c})