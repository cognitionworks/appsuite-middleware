define("io.ox/core/tk/foldertree",["io.ox/core/tk/selection","io.ox/core/api/folder","io.ox/core/extensions","io.ox/core/event"],function(a,b,c,d){var e=ox.base+"/apps/themes/default/icons/",f=e+"folder-default.png",g="url("+e+"folder-open.png)",h="url("+e+"folder-close.png)",i=$("<div>").addClass("folder selectable").css("paddingLeft","13px"),j=$("<div>").addClass("subfolders").hide(),k={};"use strict";function l(a,c,d,m){var n,o=b.get({folder:c}),p={},q=null,r=!1,s=this,t={},u=function(){return a
.root===s&&a.options.skipRoot},v=function(){return t.subfolders||t.subscr_subflds},w=function(){return n===undefined&&(n=t.module==="system"||t.module===a.options.type),v()&&(u()||n)},x=function(a,b){return s.loadChildren(a).pipe(function(a){return $.when.apply(null,_(a).invoke(b,p.sub.busy().show()))})},y=function(){return x(!1,"paint")},z=function(){return x(!0,"repaint")},A=function(){var a=v()?w()?h:g:"none";p.arrow.css("backgroundImage",a)},B=function(a){a.preventDefault(),v()&&(n?(n=!1,p.sub
.hide(),A()):(n=!0,p.sub.show(),A(),q===null&&y()))};this.id=c,this.getChildren=function(){return q},this.reload=function(){o=b.get({folder:c})},this.loadChildren=function(d){var e,f={};if(q===null||d===!0)return q!==null&&d===!0&&_(q).each(function(a){f[a.id]=a.detach()}),e=k[c]===undefined&&b.needsRefresh(c),b.getSubFolders({folder:c}).done(function(a){e&&_.defer(function(){b.getSubFolders({folder:c,cache:!1}).done(function(b){_.isEqual(a,b)||(s.reload(),_(q).invoke("reload"),s.repaint()),k[c]=!1
})})}).pipe(function(b){return q=_.chain(b).select(function(a){return a.module!=="system"||a.subfolders}).map(function(b){var c;if(d&&f[b.id]!==undefined)return c=f[b.id],delete f[b.id],c;else return new l(a,b.id,p.sub,u()?m:m+1)}).value(),_(f).each(function(a){a.destroy()}),f=null,q});else return $.Deferred().resolve(q)},this.customize=function(b,c){var d;switch(c.id){case"default0/INBOX":d=e+"inbox.png";break;case"default0/INBOX/Trash":d=e+"trash.png";break;case"default0/INBOX/Sent Items":d=e+"outbox.png"
;break;case"6":d=e+"user.png";break;default:d=f}a.options.type&&a.options.type!==c.module&&b.folder.addClass("greyed-out"),b.icon.attr("src",d),b.label.text(c.title+""),a.options.type==="mail"&&c.total!==undefined?b.counter.text(c.total||""):b.counter.hide()},this.detach=function(){return p.folder.detach(),p.sub.detach(),this},this.destroy=function(){_(p).each(function(a){a.remove()}),_(q).each(function(a){a.destroy()}),o=q=p=a=s=d=t=null},this.repaint=function(){if(r)return d.append(p.folder,p.sub
),o.pipe(function(b){t=b,a.selection.addToIndex(t),s.customize(p,t),A();if(w())return z();else return p.sub.empty().hide(),$.when()}).done(function(){d.idle()});else return this.paint()},this.paint=function(){return p.folder=i.clone().on("dblclick",B),m>0&&p.folder.css("paddingLeft",13+m*22+"px"),p.sub=j.clone(),u()&&p.folder.hide(),d.append(p.folder,p.sub),o.pipe(function(b){var c;return t=b,p.arrow=$("<div>").addClass("folder-arrow").on("click",B),p.icon=$("<img>",{src:"",alt:""}).addClass("folder-icon"
),p.label=$("<span>").addClass("folder-label"),p.counter=$("<span>").addClass("folder-counter"),p.folder.attr("data-obj-id",t.id),a.selection.addToIndex(t),s.customize(p,t),c=w()?y():$.when(),A(),p.folder.append(p.arrow,p.icon,p.counter,p.label),c}).done(function(){d.idle(),r=!0})}}function m(b,c){var e,f;this.options=_.extend({id:"default",rootFolderId:"1",skipRoot:!0,type:null},c),e=null,f=this,$(b).addClass("io-ox-foldertree").append(this.container=$("<div>")),this.root=new l(this,this.options
.rootFolderId,this.container,0),a.extend(this,b).setMultiple(!1).setSerializer(function(a){return String(a.id)}),d.extend(this),this.paint=function(){return e===null&&(this.trigger("beforepaint"),this.selection.clearIndex(),e=this.root.paint(),e.always(function(){f.selection.update(),f.trigger("paint"),e=null})),e||$.when()},this.repaint=function(){return e===null&&(this.trigger("beforerepaint"),this.selection.clearIndex(),e=this.root.repaint(),e.always(function(){f.selection.update(),f.trigger("repaint"
),e=null})),e||$.when()},this.busy=function(){return this.container.parent().busy().children().hide(),this.trigger("busy"),this},this.idle=function(){return this.container.parent().idle().children().show(),this.trigger("idle"),this},this.destroy=function(){this.events.destroy(),this.selection.destroy(),b.empty(),b=this.container=this.selection=null}}function n(a){a.preventDefault(),require(["io.ox/core/tk/dialogs"],function(c){(new c.ModalDialog({width:400,easyOut:!0})).header($("<h4>").text("Add new folder"
)).append($("<input>",{placeholder:"Folder name",value:""}).addClass("nice-input")).addButton("cancel","Cancel").addPrimaryButton("add","Add folder").show(function(){this.find("input").focus()}).done(function(c){c==="add"&&(a.data.tree.busy(),b.create({folder:a.data.folder,data:{module:"mail",title:"New folder "+_.now()}}).done(function(b){a.data.tree.idle().repaint().done(function(){a.data.tree.selection.set(String(b)),a.data=null})}))})})}function o(a,b){m.call(this,a,b),$(a).append(this.links=
$("<div>").addClass("foldertree-links")),this.on("paint",function(){c.point("io.ox/application-foldertree/links").invoke("draw",this.links,{rootFolderId:this.options.rootFolderId,tree:this})})}return c.point("io.ox/application-foldertree/links").extend({index:100,id:"create-folder",draw:function(a){this.append($("<div>").append($("<a>",{href:"#"}).addClass("action-link").text("Add new folder ...").on("click",{folder:a.rootFolderId,tree:a.tree},n)))}}),{FolderTree:m,ApplicationFolderTree:o}})