define("io.ox/core/tk/vgrid",["io.ox/core/tk/selection","io.ox/core/event","gettext!io.ox/core"],function(a,b,c){var d,e=$.when();"use strict";function f(){var a=[],b=_.extend({tagName:"div",defaultClassName:"vgrid-cell"}),c=function(a){a.css("visibility","hidden").show().appendTo(document.body);var b=Math.max(1,a.outerHeight(!0));return a.remove(),b},d=!0;this.node=$("<"+b.tagName+">").addClass(b.defaultClassName),this.add=function(b){b&&b.build&&(a.push(b),d=!1)},this.isEmpty=function(){return d
},this.getHeight=function(){return d?0:c(this.getClone().node)},this.getDefaultClassName=function(){return b.defaultClassName};function f(a){this.node=a,this.fields={},this.set=[],this.detached=!0}f.prototype.update=function(a,b,c,d){var f=0,g=this.set,h=g.length,i=[];for(;f<h;f++)i.push(g[f].call(this.node,a,this.fields,b,d)||e);return c!==undefined&&this.node.attr("data-obj-id",c),i},f.prototype.appendTo=function(a){return this.detached&&(this.node.appendTo(a),this.detached=!1),this},f.prototype
.detach=function(){return this.node.detach(),this.node.removeAttr("data-obj-id"),this.detached=!0,this},this.getClone=function(){var c,d=0,e=a.length,g=new f(this.node.clone());for(;d<e;d++)c=a[d],_.extend(g.fields,c.build.call(g.node)||{}),g.set.push(c.set||$.noop);return g.node.add(g.node.find("div, span, p, td")).each(function(){var a=$(this);a.children().length===0&&a.text()===""&&a.text("Â ")}),g.node.find("img").each(function(){if(this.style.width===""||this.style.height==="")console.error("Image has no width/height. Set to (0, 0):"
,this),this.style.width=this.style.height="0px"}),b.defaultClassName=g.node[0].className,g}}return d=function(d){var g=$(d).empty().addClass("vgrid"),h=this,i=!1,j=!0,k=!0,l=!1,m=$("<div>").addClass("abs vgrid-scrollpane").appendTo(g),n=$("<div>").css({position:"relative",top:"0px"}).appendTo(m),o=function(a){a.preventDefault();var b=a.data.grid;b.setEditable(!b.getEditable())},p=$("<div>").addClass("vgrid-toolbar").append($("<a>",{href:"#"}).css("float","left").append($('<i class="icon-th-list">'
)).on("click",{grid:this},o)).appendTo(g),q=new f,r=new f,s=[],t=0,u=0,v=20,w=0,x=0,y=0,z="all",A={all:function(a){return $.Deferred().resolve([])}},B={all:function(a){return $.Deferred().resolve(a)}},C=[],D={nodes:$()},E={top:0,bottom:0},F=Modernizr.touch?6:3,G={},H=_.isArray,I=!1,J,K,L,M,N,O=null,P,Q,R,S,T,U,V,W,X,Y;q.node.addClass("selectable"),r.node.addClass("vgrid-label"),Modernizr.touch&&n.css("webkitTransform","translate3d(0, 0, 0)"),b.extend(this),a.extend(this,m),J=function(a){var b=D.list
[a];b!==undefined&&m.stop().animate({scrollTop:b.top},250,function(){h.selection.set(C[b.pos]),b=null})},K=function(a){var b=$(this).data("label-index")||0,c=a.type==="dblclick"?1:0;J(b+c)},L=function(){var a=0,b=D.list.length,c=null,d,e=0,f="",g=[];for(;a<b;a++)d=D.list[a],c=r.getClone(),c.node.addClass("vgrid-label").data("label-index",a),g.concat(c.update(C[d.pos],d.pos,"",C[d.pos-1]||{})),f=c.node.text(),D.nodes=D.nodes.add(c.node.appendTo(n)),d.text=f,D.index[d.pos]=a,D.textIndex[f]=a;return $
.when.apply($,g).pipe(function(){var a,d,f;for(a=0;a<b;a++)d=D.list[a],f=D.nodes.eq(a),d.top=e+d.pos*t,f.css({top:d.top+"px"}),e+=d.height=f.outerHeight(!0)||u;return f=c=g=null,e})},N=function(){var a=0,b=function(){var b="grid_cb_"+a++;return $("<div>").addClass("vgrid-cell-checkbox").append($("<label>",{"for":b}).append($("<input>",{type:"checkbox",id:b}).addClass("reflect-selection")))};return function(a){var c=a.getClone();return c.node.prepend(b()),c}}(),M=function(){D.nodes.remove(),D={nodes
:$(),list:[],index:{},textIndex:{}},y=0;var a=0,b=C.length,c,d="";for(;a<b;a++)d=h.requiresLabel(a,C[a],c),d!==!1&&(D.list.push({top:0,text:"",pos:a}),y++,c=d)},P=function(a){if(!i)return;a=Math.max(a,0);if(a===O)return e;else O=a;var b;if(P.pending)return P.pending=[a,b=$.Deferred()],b;else P.pending=!0;var c=function(c){if(H(P.pending)){a=P.pending[0],b=P.pending[1],P.pending=!1,P(a).done(b.resolve);return}else P.pending=!1;var d,e,f=0,g="",i,j=q.getDefaultClassName(),k=new Array(c.length),l,m;
for(g in D.index)a>g&&(m=D.index[g],f+=D.list[m].height||u);for(d=0,e=c.length;d<e;d++)m=D.index[a+d],m!==undefined&&(f+=D.list[m].height||u),c[d]||(s[d]=N(q)),i=s[d],i.appendTo(n),l=i.node[0],l.className=j+" "+((a+d)%2?"odd":"even"),c[d]&&i.update(c[d],a+d,h.selection.serialize(c[d]),c[d-1]||{}),l.style.top=f+(a+d)*t+"px",k[d]=i.node;if(e<x)for(;d<x;d++)s[d].detach(),s[d].node[0].className=j;h.selection.update(),k=null,E.top=a,E.bottom=a+x},d=B[z]||B.all,f=C.slice(a,a+x);return d.call(h,f).done(
c).fail(function(){c(new Array(f.length))})},Q=function(){w=Math.max(1,(g.height()/t>>0)+2),x=Math.max(w*F>>0,v);var a=0,b,c=document.createDocumentFragment();for(;a<x;a++)a>=s.length?(b=N(q),c.appendChild(b.node[0]),s.push(b)):c.appendChild(s[a].node[0]);for(;a<s.length;a++)s[a].node.detach();n[0].appendChild(c),c=null};function Z(){return M(),L().done(function(a){n.css({height:a+C.length*t+"px"})})}function ba(a,b){if(a.length!==C.length||!_.isEqual(C,a))C=a,O=null,h.selection.init(C),Z();m.find
(".io-ox-center").remove().end(),a.length===0&&m.append($.fail(Y?Y(h.getMode()):c("Empty"))),b||h.trigger("change:ids",C);var d=O||V(g.scrollTop())-(x-w);return P(d)}X=function(a){var b=a.split(/\./);return{folder_id:b[0],id:b[1],recurrence_position:b[2]}},R=function(){if(l)return $.when();C.length===0&&(m.find(".io-ox-center").remove().end(),n.css({visibility:"hidden"}).parent().busy());function a(){ba([]),n.hide().parent().idle().find(".io-ox-fail").parent().remove().end().end().append($.fail(c
("Could not load this list"),function(){n.show(),R()}))}var b=A[z]||A.all,d=$.Deferred(),e;return b.call(h).done(function(a){H(a)?(e=a.length!==C.length||!_.isEqual(C,a),ba(a).always(function(){n.css({visibility:""}).parent().idle()}).done(function(){if(_.url.hash("id")!==undefined){var a=_.url.hash("id").split(/,/),b,c,d;a=_(a).map(X),d=!h.selection.equals(a),d&&(h.selection.set(a),k=!1);if(d||e)b=_(a).first(),c=h.selection.getIndex(b)||0,T(c)||U(c-2)}else k&&(h.selection.selectSmart(),k=!1)}).done
(d.resolve).fail(d.reject)):(console.warn("VGrid.all() must provide an array!"),d.fail(d.reject))}).fail(a),d},S=function(){return t=q.getHeight(),u=r.getHeight(),Q(),i=!0,R()},T=function(a){var b=m.scrollTop(),c=m.height();return a>=V(b)&&a<V(b+c)-1},U=function(a){var b=0,c=Math.min(Math.max(0,a),C.length),d=0,e=0,f;for(;b<c;b++)f=D.list[d],f&&f.pos===b&&(e+=f.height||u,d++),e+=t;m.scrollTop(e)},V=function(a){var b=0,c=C.length,d=0,e=0,f;for(;b<c&&e<a;b++)f=D.list[d],f&&f.pos===b&&(e+=f.height||
u,d++),e+=t;return b},W=_.throttle(function(){if(P.pending===!1){var a=m.scrollTop(),b=V(a);b>=E.bottom-w-2?P(b-(w>>1)):b<E.top+2&&E.top!==0&&P(b-w*1.5,"above")}},100),this.selection.on("change",function(a,b){var c=_(b).map(function(a){return h.selection.serialize(a)}).join(",");_.url.hash("id",c!==""?c:null)}).on("select:first",function(){U(0)}).on("select:last",function(){U(C.length-1)}),this.setAllRequest=function(a,b){_.isFunction(a)&&(b=a,a="all"),A[a]=b},this.setListRequest=function(a,b){_.
isFunction(a)&&(b=a,a="all"),B[a]=b},this.addTemplate=function(a){q.add(a)},this.addLabelTemplate=function(a){r.add(a)},this.requiresLabel=function(){return!1},this.paint=function(){return j&&(m.on("selectstart",!1).on("scroll",W).on("click dblclick",".vgrid-label",K),j=!1),S()},this.repaintLabels=function(){return Z()},this.repaint=function(){var a=O||0;return O=null,P(a)},this.clear=function(){return l?$.when():ba([],!0)},this.refresh=function(a){return j?a===!0?this.paint():e:R()},this.getMode=
function(){return z},this.setMode=function(a){return z=a,_.url.hash("id",null),k=!0,this.refresh()},this.getId=function(a){return{folder_id:a.folder_id,id:a.id}},this.getData=function(a){return a!==undefined?C[a]:C},this.contains=function(a){var b=this.selection,c=b.serialize(a),d=0,e=(C||[]).length;for(;d<e;d++)if(c===b.serialize(C[d]))return!0;return!1},this.getLabels=function(){return D},this.scrollToLabelText=function(a){var b=a.data?a.data.text:a,c=D.textIndex[b];c!==undefined&&J(c)},this.scrollTop=
function(){return m.scrollTop()},this.keyboard=function(a){this.selection.keyboard(a)},this.getToolbar=function(){return p},this.getEditable=function(){return I},this.setEditable=function(a){a?(g.addClass("editable"),this.selection.setEditable(!0),I=!0):(g.removeClass("editable"),this.selection.setEditable(!1),I=!1)},this.setMultiple=function(a){this.selection.setMultiple(a),p[a?"show":"detach"]()},this.prop=function(a,b){if(a!==undefined)if(b!==undefined)return G[a]=b,this.trigger("change:prop",
a,b),this.trigger("change:prop:"+a,b),this;else return G[a];else return G},this.scrollTop=function(a){return a!==undefined?m.scrollTop(a):m.scrollTop()},this.getContainer=function(){return n},this.setDeserialize=function(a){_.isFunction(a)&&(X=a)},this.pause=function(){return l=!0,h},this.resume=function(){return l=!1,h},this.isVisible=T,this.setIndex=U,this.getIndex=V,this.setEmptyMessage=function(a){Y=a}},d.Template=f,d})