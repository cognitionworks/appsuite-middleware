define("io.ox/calendar/api",["io.ox/core/http","io.ox/core/event"],function(a,b){var c={},d={},e=6e4*60*24,f={get:function(b){b=b||{};var c={action:"get",id:b.id,folder:b.folder||b.folder_id};b.recurrence_position!==null&&(c.recurrence_position=b.recurrence_position);var e=(b.folder||b.folder_id)+"."+b.id+"."+(b.recurrence_position||0);if(d[e]===undefined)return a.GET({module:"calendar",params:c}).done(function(a){d[e]=a});else return $.Deferred().resolve(d[e])},getAll:function(b){b=$.extend({start
:_.now(),end:_.now()+28*1*e},b||{}),b.start=(b.start/e>>0)*e,b.end=(b.end/e>>0)*e;var d=b.folder+"."+b.start+"."+b.end,f={action:"all",columns:"1,20,207,201,200,202,400,402",start:b.start,end:b.end,showPrivate:!0,recurrence_master:!1,sort:"201",order:"asc"};b.folder!==undefined&&(f.folder=b.folder);if(c[d]===undefined)return a.GET({module:"calendar",params:f}).done(function(a){c[d]=a});else return $.Deferred().resolve(c[d])},getList:function(b){return a.fixList(b,a.PUT({module:"calendar",params:{
action:"list"},data:a.simplify(b)}))},search:function(b){return a.PUT({module:"calendar",params:{action:"search",sort:"201",order:"desc"},data:{pattern:b}})},searchParticipants:function(b){var c="20,1,500,501,502,505,520,555,556,557,569,602,606";return a.PUT({module:"multiple","continue":!0,data:[{module:"user",action:"search",columns:c,sort:"500",order:"asc",data:{pattern:b}},{module:"group",action:"search",data:{pattern:b}},{module:"resource",action:"search",data:{pattern:b}},{module:"contacts"
,action:"search",columns:"1,20,500,555,602,524,556,557,501,502",sort:"500",order:"asc",data:{display_name:b,email1:b,email2:b,email3:b,last_name:b,first_name:b,orSearch:!0}}]}).pipe(function(b){b[0].data=_(b[0].data).map(function(b){var d=a.makeObject(b,"user",c.split(","));return console.log("mapped",d,b,c.split(",")),d}),console.log("searched",b),_(b).each(function(a,b){_(a.data).each(function(a){switch(b){case 0:a.type=1;break;case 1:a.type=2;break;case 2:a.type=3;break;case 3:a.type=5}})});var d=
[];return d=b[0].data.concat(b[1].data,b[2].data,b[3].data),d=_(d).sortBy(function(a){return a.display_name}),d})},needsRefresh:function(a){return c[a]!==undefined},update:function(b){var e=b.folder_id+"."+b.id+"."+(b.recurrence_position||0);if(_.isEmpty(b))return $.when();else return a.PUT({module:"calendar",params:{action:"update",id:b.id,folder:b.folder_id,timestamp:_.now()},data:b}).pipe(function(a){var g={};if(!_.isUndefined(a.conflicts)){var h=new $.Deferred;return h.reject(a),h}return g.id=
b.id,g.folder=b.folder_id,b.recurrence_position!==null&&(g.recurrence_position=b.recurrence_position),c={},delete d[e],f.get(g).pipe(function(a){return f.trigger("refresh.all"),f.trigger("update",a),a})})},create:function(b){return a.PUT({module:"calendar",params:{action:"new"},data:b}).pipe(function(a){var d={};if(!_.isUndefined(a.conflicts)){var e=new $.Deferred;return e.reject(a),e}return d.id=a.id,d.folder=b.folder_id,b.recurrence_position!==null&&(d.recurrence_position=b.recurrence_position)
,c={},f.get(d).pipe(function(a){return f.trigger("refresh.all"),f.trigger("created",d),a})})},remove:function(b){return a.PUT({module:"calendar",params:{action:"delete",timestamp:_.now()},data:b.data}).done(function(a){c={},f.trigger("refresh.all")})}};return"use strict",b.extend(f),f.refresh=function(){c={},f.trigger("refresh.all")},f})