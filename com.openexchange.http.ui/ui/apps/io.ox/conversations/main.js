define("io.ox/conversations/main",["io.ox/mail/util","io.ox/conversations/api","io.ox/core/tk/vgrid","io.ox/core/api/user","io.ox/core/config","io.ox/core/extensions","io.ox/core/date","less!io.ox/conversations/style.css","io.ox/conversations/actions"],function(a,b,c,d,e,f,g){var h,i,j,k,l=ox.ui.createApp({name:"io.ox/conversations"}),m=330,n=window.webkitNotifications,o=!1;return"use strict",l.setLauncher(function(){var a,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M;h=ox.ui.createWindow({name
:"io.ox/conversations",title:"Conversations",titleWidth:m+27+"px",toolbar:!0}),h.addClass("io-ox-conversations-main"),l.setWindow(h),n&&document.webkitHidden!==undefined&&(a=n.checkPermission(),a===1?h.addButton({label:"Use notifications",action:function(){n.requestPermission(function(){o=!0})}}):a===0&&(o=!0)),j=$("<div/>").addClass("leftside border-right").css({width:m+"px"}).appendTo(h.nodes.main),k=$("<div/>").css({left:m+1+"px"}).addClass("rightside io-ox-conversation").appendTo(h.nodes.main
),i=new c(j),i.addTemplate({build:function(){var a,b;return this.addClass("conversation").append(a=$("<div>").addClass("subject")).append(b=$("<div>").addClass("members")),{subject:a,members:b}},set:function(a,b){b.subject.text(a.subject||"Â "),b.members.text(_(a.members).map(function(a){return a.name}).join(", "))}}),i.setAllRequest(function(){return b.getAll()}),i.setListRequest(function(a){return b.getList(a)}),p=null,q="",r=null,s=0,t=null,u=!0,v=2e3,w=String(e.get("identifier")),J=function(a)
{f.point("io.ox/core/person:action").each(function(b){_.call(b.action,a.data,a)})},A=function(){t!==null&&(clearInterval(t),t=null)},C=function(){t===null&&p!==null&&(t=setInterval(E,v))},B=function(a){A(),p=a,r=null,s=0,u=!0,E(),C()},D=function(){A(),E(),C()},F=function(a){var b,c=_(a).last()||{id:null,timestamp:0};c.id!==null&&c.id!==r&&(r=c.id,s=c.timestamp,H(a),!u&&o&&ox.windowState==="background"&&(b=c.from||{name:""},d.getPictureURL(b.id).done(function(a){var d=n.createNotification(a,b.name
,c.text);d.show(),setTimeout(function(){d.cancel()},5e3)})),u=!1)},E=function(){ox.session&&b.getMessages(p,s).done(F)},K={":D":"bigsmile",":)":"smile","(y)":"yes"},G=function(a){return'<img src="'+ox.base+"/apps/io.ox/conversations/images/"+K[a]+'.gif" class="emoticon">'},L=function(a){var b=g.TIME,c=new g.Local(g.Local.utc(a));return c.getDays()===(new g.Local).getDays()&&(b+=g.DATE),c.format(b)},H=function(a){_(a).each(function(a){var b=String(a.text).replace(/</g,"&lt;").replace(/(\:D|\:\)|\(y\))/g
,G).replace(/\*(\w[^\*]*\w)\*/g,"<b>$1</b>").replace(/(http:\/\/\S+)/ig,'<a href="$1" target="_blank">$1</a>'),c=a.from||{};x.append($("<div>").addClass("message").append(d.getPicture(c.id).addClass("picture")).append($("<div>").addClass("timestamp").text(L(a.timestamp))).append($("<a>").addClass("from"+(c.id===w?" me":"")).on("click",{user_id:c.id},J).text(c.name)).append($("<div>").addClass("text").html(b)))}),x.parent().scrollTop(x.height()+100)},I=function(){var a=$.trim(z.val());a!==""&&(z.attr
("disabled","disabled"),b.sendMessage(p,a).done(function(){q=a,z.val(""),D()}).always(function(){z.removeAttr("disabled").focus()}))},$("<div>").addClass("abs conversation default-content-padding").css({overflow:"auto",paddingBottom:"0"}).append(x=$("<div>").addClass("centered-box")).appendTo(k),z=$("<textarea>").attr({id:"message-text",placeholder:"Type your message here...",tabindex:"1"}).css("resize","none").on("keydown",function(a){var b;a.stopPropagation(),a.which===13?I():a.which===38&&(b=$
(this),b.val()===""&&b.val(q).select())}),y=$("<div>").addClass("abs controls").append($("<form>").addClass("centered-box form-inline").append($("<label>",{"for":"message-text"}).append(z)).append($("<a>",{href:"#",tabindex:"2"}).addClass("btn btn-primary").text("Send").on("click",I))).appendTo(k),M=function(a){x.idle().empty(),x.append($.inlineEdit().text(a.subject||"No subject").addClass("subject").on("update",function(c,d){b.update(a.id,{subject:d})})),z.val("").focus(),B(a.id)},i.selection.on
("change",function(a,c){c.length===1?(x.busy(),b.get({id:c[0].id}).done(_.lfo(M))):x.empty()}),h.on("show",function(){i.selection.keyboard(!0),C()}),h.on("hide",function(){i.selection.keyboard(!1),A()}),b.on("refresh.all",function(){i.refresh()}),b.on("refresh.list",function(){i.repaint()}),h.show(function(){i.paint()})}),{getApp:l.getInstance}})