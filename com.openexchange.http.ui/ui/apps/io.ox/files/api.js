define("io.ox/files/api",["io.ox/core/http","io.ox/core/api/factory","io.ox/core/config","io.ox/core/cache"],function(a,b,c,d){var e=b({module:"infostore",requests:{all:{action:"all",folder:c.get("folder.infostore"),columns:"20,1",sort:"700",order:"asc"},list:{action:"list",columns:"20,1,700,701,702,703,704,705,706,707,709,711"},get:{action:"get"},search:{action:"search",columns:"20,1",sort:"700",order:"asc",getData:function(a){return{pattern:a}}}}});return"use strict",e.caches.versions=new d.SimpleCache
("infostore-versions",!0),e.uploadFile=function(b){var d;return b=$.extend({folder:c.get("folder.infostore")},b||{}),d=new FormData,"filename"in b?d.append("file",b.file,b.filename):d.append("file",b.file),b.json&&!$.isEmptyObject(b.json)?b.json.folder_id||(b.json.folder_id=b.folder):b.json={folder_id:b.folder},d.append("json",JSON.stringify(b.json)),a.UPLOAD({module:"infostore",params:{action:"new"},data:d,fixPost:!0}).pipe(function(a){return e.caches.all.grepRemove(b.json.folder_id+"\t").pipe(function(
){return e.trigger("create.file refresh.all"),{folder_id:String(b.json.folder_id),id:parseInt(a.data,10)}})})},e.uploadNewVersion=function(b){var d;return b=$.extend({folder:c.get("folder.infostore")},b||{}),d=new FormData,"filename"in b?d.append("file",b.file,b.filename):d.append("file",b.file),b.json&&!$.isEmptyObject(b.json)?b.json.folder_id||(b.json.folder_id=b.folder):b.json={folder_id:b.folder},d.append("json",JSON.stringify(b.json)),a.UPLOAD({module:"infostore",params:{action:"update",timestamp
:_.now(),id:b.id},data:d,fixPost:!0}).pipe(function(a){var c=b.json.id||b.id;return $.when(e.caches.all.grepRemove(b.json.folder_id+"\t"),e.caches.get.remove(b.json),e.caches.versions.remove(c)).pipe(function(){return e.trigger("create.version update refresh.all",{id:c,folder:b.json.folder_id}),{folder_id:String(b.json.folder_id),id:c,timestamp:a.timestamp}})})},e.update=function(b){var c={id:b.id,folder:b.folder_id};return a.PUT({module:"infostore",params:{action:"update",id:b.id,timestamp:_.now
()},data:b,appendColumns:!1}).pipe(function(){return e.caches.all.grepRemove(b.folder_id+"\t")}).pipe(function(){return e.get(c,!1)}).done(function(){e.trigger("update refresh.all",c)})},e.create=function(b){return b=$.extend({folder:c.get("folder.infostore")},b||{}),b.json.folder_id||(b.json.folder_id=b.folder),a.PUT({module:"infostore",params:{action:"new"},data:b.json,appendColumns:!1}).pipe(function(a){return e.caches.all.grepRemove(b.folder).pipe(function(){return e.trigger("create.file",{id
:a,folder:b.folder}),{folder_id:String(b.folder),id:String(a?a:0)}})})},e.versions=function(b){var c={action:"versions"};b=b||{};if(!b.id)throw new Error("Please specify an id for which to fetch versions");return c.id=b.id,e.caches.versions.get(b.id).pipe(function(d){if(d!==null)return d;else return a.GET({module:"infostore",params:c,appendColumns:!0}).pipe(function(a){return e.caches.versions.add(b.id,a),a})})},e.getUrl=function(a,b){var c=ox.apiRoot+"/infostore?action=document&id="+a.id+"&folder="+
a.folder_id+"&version="+a.version;switch(b){case"open":return c+"&delivery=view";case"download":return c+"&delivery=download";default:return c}},e.detach=function(b){return a.PUT({module:"infostore",params:{action:"detach",id:b.id,folder:b.folder,timestamp:_.now()},data:[b.version],appendColumns:!1}).pipe(function(){return $.when(e.caches.all.grepRemove(b.folder+"\t"),e.caches.list.remove({id:b.id,folder:b.folder}),e.caches.get.remove({id:b.id,folder:b.folder}),e.caches.versions.remove(b.id))}).done
(function(){e.trigger("delete.version update refresh.all",{id:b.id,folder:b.folder,version:b.version})})},e})