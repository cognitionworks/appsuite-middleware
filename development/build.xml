<project name="Open-Xchange Development Config" default="default" basedir=".">

    <description>
        Open-Xchange Collaboration Suite Server Development Configuration
    </description>

    <!-- Directories -->
    <property name="tmp.dir" value="tmp"/>
    <property name="commonTmpDir" value="commonTmp"/>
    <property name="adminTmpDir" value="adminTmp"/>
    <property name="conf.dir" value="conf"/>
    <property name="commonConfDir" location="commonConf"/>
    <property name="adminConfDir" value="adminConf"/>

    <!-- Replacements -->
    <property name="conf.install.dir" value="${basedir}/${tmp.dir}"/>

    <!-- Data Retention property file -->
    <property name="dataretention.properties" value="${basedir}/${tmp.dir}/dataretention.properties"/>

    <target name="prepare">
        <mkdir dir="${tmp.dir}"/>
        <mkdir dir="${commonTmpDir}"/>
        <mkdir dir="${adminTmpDir}"/>
    </target>

    <target name="patchConfig" depends="prepare">
        <property name="patch.conf.dir" value="${tmp.dir}"/>
        <copy todir="${patch.conf.dir}" overwrite="true">
            <fileset dir="${conf.dir}"/>
        </copy>
        <antcall target="patchConfigFiles">
            <param name="conf.subst.patch" value="${conf.install.dir}"/>
        </antcall>
    </target>

    <target name="patchCommonConfig" depends="prepare">
        <property name="patchConfDir" value="${commonTmpDir}"/>
        <copy todir="${patchConfDir}" overwrite="true">
            <fileset dir="${commonConfDir}"/>
        </copy>
    </target>

    <target name="patchAdminConfig" depends="prepare">
        <property name="patchConfDir" value="${adminTmpDir}"/>
        <copy todir="${patchConfDir}" overwrite="true">
            <fileset dir="${adminConfDir}"/>
        </copy>
        <antcall target="patchAdminConfigFiles">
            <param name="confAdminSubstPatch" value="${basedir}/${adminTmpDir}"/>
            <param name="confGroupSubstPatch" value="${basedir}/${tmp.dir}"/>
        </antcall>
    </target>

    <target name="install">
        <antcall target="patchConfig"/>
        <antcall target="patchConfig"/>
        <antcall target="patchAdminConfig"/>
    </target>

    <target name="default" depends="install"/>

    <target name="clean">
        <delete dir="${tmp.dir}"/>
    </target>

    <target name="patchConfigFiles">
        <fail message="Define conf.subst.patch." unless="conf.subst.patch"/>
        <antcall target="patchSessiondProperties"/>
        <antcall target="patchPath"/>
        <antcall target="patchDataRetentionProperties"/>
    </target>

    <target name="patchAdminConfigFiles">
        <fail message="Define confGroupSubstPatch." unless="confGroupSubstPatch"/>
        <fail message="Define confAdminSubstPatch." unless="confAdminSubstPatch"/>
        <antcall target="patchAdminPath"/>
    </target>

    <target name="patchSessiondProperties">
        <move tofile="${patch.conf.dir}/sessiond.properties" file="${patch.conf.dir}/sessiond.properties.in" overwrite="true"/>
        <replace file="${patch.conf.dir}/sessiond.properties">
            <replacefilter token="@sessiondport@" value="33333"/>
        </replace>
    </target>

    <target name="patchPath">
        <move todir="${patch.conf.dir}" includeemptydirs="false">
            <fileset dir="${patch.conf.dir}">
                <include name="*.in"/>
            </fileset>
            <mapper type="glob" from="*.in" to="*"/>
        </move>
        <replace dir="${patch.conf.dir}">
            <replacefilter token="@oxgroupwaresysconfdir@" value="${conf.subst.patch}"/>
        </replace>
    </target>

    <target name="patchAdminPath">
        <move todir="${patchConfDir}" includeemptydirs="false">
            <fileset dir="${patchConfDir}">
                <include name="*.in"/>
            </fileset>
            <mapper type="glob" from="*.in" to="*"/>
        </move>
        <replace dir="${patchConfDir}">
            <replacefilter token="$PWD/" value=""/>
            <replacefilter token="INITIAL_OX_SQL_DIR=@oxconfdir@" value="INITIAL_OX_SQL_DIR=${basedir}/../open-xchange-admin/etc"/>
            <replacefilter token="@oxconfdir@" value="${confAdminSubstPatch}"/>
            <replacefilter token="@serverconfdir@" value="${confGroupSubstPatch}"/>
            <replacefilter token="@oxgroupwaresysconfdir@" value="${confGroupSubstPatch}"/>
        </replace>
    </target>

    <target name="patchDataRetentionProperties">
        <replace file="${dataretention.properties}" token="com.openexchange.dataretention.dir=/var/log/open-xchange" value="com.openexchange.dataretention.dir=${conf.install.dir}">
        </replace>
    </target>

</project>