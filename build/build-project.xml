<?xml version="1.0" encoding="UTF-8"?>
<project name="Build bundle">

    <!-- Constants -->
	<property name="mainSrcDir" value="src"/>
    <property name="mainBinDir" value="build"/>
    <property name="simSrcDir" value="sim"/>
    <property name="simBinDir" value="sim-build"/>
    <property name="testSrcDir" value="test"/>
    <property name="testBinDir" value="test-build"/>
    <property name="jarsDir" value="jars"/>
    <property file="META-INF/MANIFEST.MF"/>
    <property file="build.properties"/>
    <property name="testJarFile" value="${bundlesDir}/${Bundle-SymbolicName}-test.jar"/>

    <target name="prepareClasspath" depends="testForMainBuild">
        <!-- propertycopy name="reqClasspath" from="${projectName}.requiredClasspath" override="true"/>
        <echo message="${reqClasspath}"/ -->
        <setProjectDependencies projectName="${projectName}" binDir="${mainBinDir}" pathId="mainDependencies" deepPathId="mainDeepDependencies"/>
        <setProjectDependencies projectName="${projectName}" binDir="${simBinDir}" pathId="simDependencies" deepPathId="simDeepDependencies"/>
        <setProjectDependencies projectName="${projectName}" binDir="${testBinDir}" pathId="testDependencies" deepPathId="testDeepDependencies"/>
        <path id="mainCompileClasspath">
            <path refid="mainDependencies"/>
        </path>
        <!-- property name="printablePath" refid="mainBinClasses"/>
        <echo message="${printablePath}"/ -->
        <path id="simCompileClasspath">
            <path refid="mainCompileClasspath"/>
            <path refid="simDependencies"/>
            <path refid="mainBinClasses"/>
        </path>
        <!-- property name="printablePath" refid="simCompileClasspath"/>
        <echo message="${printablePath}"/ -->
        <path id="testCompileClasspath">
            <path refid="simCompileClasspath"/>
            <path refid="testDependencies"/>
            <pathelement location="${simBinDir}"/>
        </path>
        <!-- property name="printablePath" refid="testCompileClasspath"/>
        <echo message="${printablePath}"/ -->
        <path id="testRunClasspath">
            <path refid="testCompileClasspath"/>
            <path refid="testDeepDependencies"/>
            <pathelement location="${bundlesDir}/${Bundle-SymbolicName}-test.jar"/>
        </path>
    </target>

    <target name="compile">
        <mkdir dir="${binDir}"/>
        <javac srcdir="${srcDir}" destdir="${binDir}" debug="true" encoding="US-ASCII" source="1.5" target="1.5" includeAntRuntime="false">
            <classpath refid="${compileClasspath}"/>
        </javac>
    </target>

    <target name="bundleJar">
        <jar jarfile="${jarsDir}/${Bundle-SymbolicName}.jar" manifest="META-INF/MANIFEST.MF">
            <fileset dir="${binDir}"/>
        </jar>
    </target>

    <target name="installJar">
        <mkdir dir="${destDir}/${bundlesDir}"/>
        <copy todir="${destDir}/${bundlesDir}">
            <fileset dir="${jarsDir}">
                <include name="*.jar"/>
            </fileset>
        </copy>
    </target>

    <target name="makeIni">
        <!-- TODO fragment without @start -->
        <propertyregex property="bundle.name" input="${jar}" regexp=".*/(.*)\.jar" select="\1"/>
        <echo file="${destDir}/${bundle.dDir}/${bundle.name}.ini" message="${bundlesDir}/${bundle.name}.jar@start${line.separator}"/>
    </target>

    <target name="installConfig">
        <mkdir dir="${destDir}/${bundle.dDir}"/>
        <foreach target="makeIni" param="jar" inheritAll="true">
            <path>
                <fileset dir="${jarsDir}" includes="*.jar"/>
            </path>
        </foreach>
    </target>

    <target name="install" depends="installJar,installConfig"/>

    <target name="testForMainBuild">
        <if>
            <and>
                <equals arg1="${buildType}" arg2="bundle"/>
                <available file="${mainSrcDir}" type="dir"/>
            </and>
            <then>
                <property name="buildMain" value="true"/>
                <path id="mainBinClasses">
                    <pathelement location="${mainBinDir}"/>
                </path>
            </then>
            <else>
                <path id="mainBinClasses">
                    <pathelement location="${bundlesDir}/${projectName}.jar"/>
                </path>
            </else>
        </if>
    </target>

    <target name="buildMain" depends="testForMainBuild" if="buildMain">
        <antcall target="compile" inheritrefs="true">
            <param name="srcDir" value="${mainSrcDir}"/>
            <param name="binDir" value="${mainBinDir}"/>
            <param name="compileClasspath" value="mainCompileClasspath"/>
        </antcall>
    </target>

    <target name="testForMainJar">
        <condition property="mainJar">
            <and>
                <equals arg1="${buildType}" arg2="bundle"/>
                <available file="${mainBinDir}" type="dir"/>
            </and>
        </condition>
    </target>

    <target name="mainJar" depends="testForMainJar" if="mainJar">
        <antcall target="bundleJar" inheritrefs="true">
            <param name="binDir" value="${mainBinDir}"/>
        </antcall>
    </target>

    <target name="testForMainInstall">
        <condition property="installMain">
            <and>
                <equals arg1="${buildType}" arg2="bundle"/>
                <available file="${jarsDir}" type="dir"/>
            </and>
        </condition>
    </target>

    <target name="installMain" depends="testForMainInstall" if="installMain">
        <antcall target="install" inheritrefs="true">
            <param name="binDir" value="${mainBinDir}"/>
        </antcall>
    </target>

    <target name="testForSimBuild">
        <condition property="buildSim">
            <and>
                <equals arg1="${buildType}" arg2="tests"/>
                <available file="${simSrcDir}" type="dir"/>
            </and>
        </condition>
    </target>

    <target name="buildSim" depends="testForSimBuild" if="buildSim">
        <antcall target="compile" inheritrefs="true">
            <param name="srcDir" value="${simSrcDir}"/>
            <param name="binDir" value="${simBinDir}"/>
            <param name="compileClasspath" value="simCompileClasspath"/>
        </antcall>
    </target>

    <target name="testForTestBuild">
        <condition property="buildTest">
            <and>
                <equals arg1="${buildType}" arg2="tests"/>
                <available file="${testSrcDir}" type="dir"/>
            </and>
        </condition>
    </target>

    <target name="buildTest" depends="testForTestBuild" if="buildTest">
        <antcall target="compile" inheritrefs="true">
            <param name="srcDir" value="${testSrcDir}"/>
            <param name="binDir" value="${testBinDir}"/>
            <param name="compileClasspath" value="testCompileClasspath"/>
        </antcall>
    </target>

    <target name="testForTestJar">
        <condition property="testJar">
            <and>
                <equals arg1="${buildType}" arg2="tests"/>
                <or>
                    <available file="${simSrcDir}" type="dir"/>
                    <available file="${testSrcDir}" type="dir"/>
                </or>
            </and>
        </condition>
    </target>

    <target name="addSimToJar" if="buildSim">
        <jar jarfile="${testJarFile}">
            <fileset dir="${simBinDir}"/>
        </jar>
    </target>

    <target name="addTestToJar" if="buildTest">
        <jar jarfile="${testJarFile}" update="true">
            <fileset dir="${testBinDir}"/>
        </jar>
    </target>

    <target name="testJar" depends="testForTestJar,addSimToJar,addTestToJar" if="testJar">
        <fail message="not implemented"/>
    </target>

    <target name="testForTestRun">
        <condition property="runTests">
            <and>
                <equals arg1="${buildType}" arg2="tests"/>
                <or>
                    <available file="${simSrcDir}" type="dir"/>
                    <available file="${testSrcDir}" type="dir"/>
                </or>
            </and>
        </condition>
    </target>

    <target name="runTests" depends="testForTestRun" if="runTests">
        <mkdir dir="${logDir}"/>
        <junit errorProperty="testFailed" failureProperty="testFailed" showoutput="yes" printsummary="yes" fork="yes" dir="${basedir}">
            <classpath>
                <path refid="testRunClasspath"/>
                <!-- Code coverage with emma -->
            </classpath>
            <formatter type="brief" usefile="false"/>
            <formatter type="xml"/>
            <batchtest todir="${logDir}">
                <zipfileset src="${testJarFile}" includes="**/UnitTests.class"/>
            </batchtest>
        </junit>
    </target>

    <target name="build" depends="prepareClasspath,buildMain,mainJar,installMain,buildSim,buildTest,testJar,runTests"/>

	<target name="dist">
		<property name="destDir" value="${distDir}/${packageName}/${projectName}"/>
        <mkdir dir="${destDir}"/>
        <copy todir="${destDir}">
            <fileset dir=".">
                <exclude name="**${distDir}/**"/>
                <exclude name="Todo"/>
            </fileset>
        </copy>
	</target>

    <target name="clean">
        <delete dir="${mainBinDir}"/>
        <delete dir="${simBinDir}"/>
        <delete dir="${testBinDir}"/>
        <delete file="${testJarFile}"/>
    </target>

</project>
