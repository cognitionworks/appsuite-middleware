<project name="openexchange-test" default="default" basedir=".">

    <!-- Customizable values -->
    <property name="destdir" value=""/>
    <property name="prefix" value="/opt/open-xchange"/>

    <!-- Constants -->
    <property name="conf.dir" value="conf"/>
    <property name="tmp.dir" value="tmp"/>

    <property file="META-INF/MANIFEST.MF"/>
    <property file="build.properties"/>

    <property name="version" value="${Bundle-Version}"/>
    <property name="bundle.name" value="${Bundle-SymbolicName}_${Bundle-Version}.jar"/>
    <property name="composite.name" value="open-xchange-global-${version}" />

    <!-- Install Constants -->
    <property name="bundlesdir" value="${prefix}/bundles"/>

       <!-- Compile Constants -->
    <property name="src.common" value="common"/>
    <property name="src.iface" value="src"/>
    <property name="src.unit" value="unittests"/>
    <property name="build" value="bin"/>
    <property name="lib" value="lib"/>

    <!-- Runtime constants -->
    <property name="test.xml.dir" location="test-results" />

    <!-- Classpath -->
    <path id="project.classpath">
        <fileset dir="${bundlesdir}">
            <include name="**/*.jar"/>
            <exclude name="**/xerces.jar"/>
        </fileset>
        <fileset dir="${lib}">
            <include name="*.jar" />
        </fileset>
    </path>

    <target name="default" depends="interface-jar, unit-jar" />

    <target name="clean">
        <echo message="Dir: ${basedir},${build}" />
        <echo message="Conf: ${conf.dir}/test.properties" />
        <delete dir="${build}" />
        <delete dir="${test.xml.dir}" />
        <delete file="open-xchange-iface-tests.jar" />
        <delete file="open-xchange-unit-tests.jar" />
    </target>

    <target name="compile-common">
        <mkdir dir="${build}"/>
        <javac srcdir="${src.common}" destdir="${build}" optimize="no" debug="yes" encoding="UTF-8">
            <classpath>
                <path refid="project.classpath" />
            </classpath>
        </javac>
    </target>

    <target name="compile-specific">
         <mkdir dir="${build}"/>
        <javac srcdir="${test.src}" destdir="${build}" optimize="no" debug="yes" encoding="UTF-8">
            <classpath>
                <path refid="project.classpath" />
                <pathelement location="${build}" />
            </classpath>
        </javac>
    </target>

    <target name="compile-interface-tests" depends="compile-common">
        <antcall target="compile-specific">
            <param name="test.src" value="${src.iface}" />
        </antcall>
    </target>

    <target name="compile-unit-tests" depends="compile-common">
        <antcall target="compile-specific">
            <param name="test.src" value="${src.unit}" />
        </antcall>
    </target>

    <target name="interface-jar" depends="compile-interface-tests">
        <jar jarfile="open-xchange-iface-tests.jar" basedir="${build}" includes="**"/>
    </target>

    <target name="unit-jar" depends="compile-unit-tests">
        <jar jarfile="open-xchange-unit-tests.jar" basedir="${build}" includes="**"/>
    </target>

    <target name="run-mail-tests" depends="interface-jar">
        <delete dir="${test.xml.dir}"/>
        <mkdir dir="${test.xml.dir}"/>
        <junit errorProperty="test.failed" failureProperty="test.failed"  showoutput="yes" printsummary="yes">
            <classpath>
                <path refid="project.classpath" />
                <pathelement location="open-xchange-iface-tests.jar"/>
                <pathelement location="test-common.jar" />
            </classpath>

            <test name="com.openexchange.ajax.mail.MailTestSuite" todir="${test.xml.dir}" />

            <formatter type="brief" usefile="false" />
            <formatter type="xml" />
            <sysproperty key="test.propfile" value="${conf.dir}/test.properties" />
        </junit>

        <fail message="Tests failed!" if="test.failed" />
    </target>

    <target name="run-interface-tests" depends="interface-jar">
        <delete dir="${test.xml.dir}"/>
        <mkdir dir="${test.xml.dir}"/>
        <junit errorProperty="test.failed" failureProperty="test.failed" showoutput="yes" printsummary="yes">
            <classpath>
                <path refid="project.classpath" />
                <pathelement location="open-xchange-iface-tests.jar"/>
                <pathelement location="test-common.jar" />
            </classpath>
            <test name="com.openexchange.SmokeTestSuite" todir="${test.xml.dir}" />

            <test name="com.openexchange.ajax.FolderTest" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.LinkTest" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.MultipleTest" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.ResourceTest" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.UserTest" todir="${test.xml.dir}" />

            <test name="com.openexchange.ajax.appointment.AppointmentAJAXSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.attach.SimpleAttachmentTest" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.attach.TaskAttachmentTest" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.config.ConfigTestSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.contact.ContactAJAXSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.group.GroupTestSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.infostore.InfostoreAJAXSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.links.LinksTestSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.reminder.ReminderAJAXSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.session.SessionTestSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.ajax.task.TaskTestSuite" todir="${test.xml.dir}" />

            <test name="com.openexchange.webdav.xml.appointment.AppointmentWebdavSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.webdav.xml.contact.ContactWebdavSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.webdav.xml.folder.FolderWebdavSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.webdav.xml.task.TaskWebdavSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.webdav.xml.attachment.AttachmentWebdavSuite" todir="${test.xml.dir}" />
            <test name="com.openexchange.webdav.xml.GroupUserTest" todir="${test.xml.dir}" />
            <test name="com.openexchange.webdav.client.NaughtyClientTest" todir="${test.xml.dir}" />

            <test name="com.openexchange.ajax.importexport.ImportExportServerSuite" todir="${test.xml.dir}" />

            <test name="com.openexchange.ajax.mail.filter.MailFilterTestSuite" todir="${test.xml.dir}" />
        	
            <formatter type="brief" usefile="false" />
            <formatter type="xml" />
            <sysproperty key="test.propfile" value="${conf.dir}/test.properties" />
        </junit>
        <fail message="Tests failed!" if="test.failed" />
    </target>

    <target name="run-unit-tests" depends="unit-jar">
        <antcall target="run-tests">
            <param name="test.jar" value="open-xchange-unit-tests.jar" />
            <param name="test.class" value="com.openexchange.test.UnitTests" />
        </antcall>
    </target>

    <target name="run-tests">
        <delete dir="${test.xml.dir}"/>
        <mkdir dir="${test.xml.dir}"/>
        <junit errorProperty="test.failed" failureProperty="test.failed" showoutput="yes" printsummary="yes">
            <classpath>
                <path refid="project.classpath" />
                <pathelement location="${test.jar}"/>
                <pathelement location="test-common.jar" />
            </classpath>

            <test name="${test.class}" todir="${test.xml.dir}" />

            <formatter type="brief" usefile="false" />
            <formatter type="xml" />
            <sysproperty key="test.propfile" value="${conf.dir}/test.properties" />
        </junit>

        <fail message="Tests failed!" if="test.failed" />
    </target>

</project>
