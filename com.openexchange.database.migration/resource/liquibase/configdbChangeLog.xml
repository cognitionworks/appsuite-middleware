<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="urn:liquibase"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="urn:liquibase /liquibase/dbchangelog-3.0.xsd"
	logicalFilePath="configdbChangeLog">


	<!-- ******************************************************* -->
	<!-- ************** Release 7.6.1 starts here ************** -->
	<!-- ******************************************************* -->

	<changeSet id="7.6.1-milestone" author="martin.schneider@open-xchange.com">
		<tagDatabase tag="7.6.1-milestone" />
	</changeSet>

	<changeSet id="7.6.1:login2context:login_info" author="martin.schneider@open-xchange.com">
		<preConditions onFail="MARK_RAN">
			<customPrecondition
				className="liquibase.precondition.ext.ColumnSizePrecondition">
				<param name="expectedSize" value="255" />
				<param name="tableName" value="login2context" />
				<param name="columnName" value="login_info" />
			</customPrecondition>
		</preConditions>
		<comment>Fix for bug 33418: enhances the login_info column to 255
			characters</comment>
		<modifyDataType columnName="login_info" newDataType="varchar(255)"
			tableName="login2context" />
		<dropDefaultValue columnDataType="varchar(255)"
			columnName="login_info" tableName="login2context" />
		<rollback>
			<dropDefaultValue tableName="login2context"
				columnName="login_info" />
			<modifyDataType tableName="login2context" columnName="login_info"
				newDataType="varchar(128)" />
			<dropDefaultValue columnDataType="varchar(128)"
				columnName="login_info" tableName="login2context" />
		</rollback>
	</changeSet>

	<!-- ******************************************************* -->
	<!-- ************** Release 7.8.0 starts here ************** -->
	<!-- ******************************************************* -->

	<changeSet id="7.8.0-milestone" author="martin.schneider@open-xchange.com">
		<tagDatabase tag="7.8.0-milestone" />
	</changeSet>

<!-- Possible table names: guest, login_address, user_address -->

	<changeSet id="7.8.0:guest:create" author="martin.schneider@open-xchange.com">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="guest" schemaName="configdb" />
			</not>
		</preConditions>
		<comment>
			Add table 'guest' to save known login addresses.
		</comment>
		<sql>
			CREATE TABLE guest (
				id INT4 UNSIGNED NOT NULL AUTO_INCREMENT,
				mail_address VARCHAR(255) NOT NULL,
				PRIMARY KEY (id),
				INDEX (mail_address),
				UNIQUE (mail_address)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
		</sql>
		<!--
		<createTable schemaName="configdb" tableName="guest">
			<column name="id" type="int" autoIncrement="true" >
           		<constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="mail_address" type="varchar(255)">
           		<constraints nullable="false"/>
            </column>
		</createTable>
		-->
		<rollback>
			<dropTable tableName="guest"/>
		</rollback>
	</changeSet>

	<changeSet id="7.8.0:guest2context:create" author="martin.schneider@open-xchange.com">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="guest2context" schemaName="configdb" />
			</not>
		</preConditions>
		<comment>
			Add table 'guest2context' to save known login addresses.
		</comment>
		<sql>
			CREATE TABLE guest2context (
			    guest_id INT4 UNSIGNED NOT NULL,
			    cid INT4 UNSIGNED NOT NULL,
			    uid INT4 UNSIGNED NOT NULL,
			    PRIMARY KEY(`guest_id`, `cid`,`uid`),
			    FOREIGN KEY(`cid`) REFERENCES context (`cid`),
			    FOREIGN KEY(`guest_id`) REFERENCES guest (`id`),
			    INDEX (guest_id)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
		</sql>
		<!--
		<createTable schemaName="configdb" tableName="guest2context">
			<column name="id" type="int"/>
            <column name="cid" type="int"/>
            <column name="userid" type="int"/>
		</createTable>
		 -->
		<rollback>
			<dropTable tableName="guest2context"/>
		</rollback>
	</changeSet>

</databaseChangeLog>
