<project name="com.openexchange.mail.filter" default="jar" basedir=".">

    <!-- Customizable values -->
	<property name="destdir" value=""/>
    <property name="prefix" value="/opt/open-xchange"/>

    <!-- Constants -->
    <property file="META-INF/MANIFEST.MF"/>
    <property name="version" value="${Bundle-Version}"/>
    <property name="bundle.name" value="${Bundle-SymbolicName}.jar"/>
    <property name="bundletest.name" value="${Bundle-SymbolicName}-test.jar"/>
	<property name="composite.name" value="open-xchange-mailfilter-${version}"/>
    <property name="test.xml.dir" value="test-results" />
	<property name="serverconfdir" value="etc/groupware"/>
    <property name="bundle.d" value="${prefix}/${serverconfdir}/osgi/bundle.d"/>
    <property name="javacc.dir" value="${basedir}/javacc"/>
    <property name="src" value="${basedir}/src"/>
    <property name="jsieveprefix" value="/org/apache"/>
    <property name="jsievejavaprefix" value="org.apache"/>
    <!-- This is the location for Ubuntu only it may differ on other distributions -->
    <property name="javacc.jar" value="lib/javacc.jar"/>

    <!-- Bundle dependencies -->
    <property name="commonBundle" value="com.openexchange.common"/>
    <property name="configreadBundle" value="com.openexchange.configread"/>

	<!-- Install Constants -->
    <property name="bundlesdir" value="${prefix}/bundles"/>

	<!-- required osgi bundles -->
    <property name="osgibundle"           value="org.eclipse.osgi_3.6.1.R36x_v20100806.jar"/>
    <property name="osgiservicesbundle"   value="org.eclipse.osgi.services_3.1.200.v20070605.jar"/>
	<property name="commonsloggingbundle" value="org.apache.commons.logging_1.0.4.v200706111724.jar"/>
	<property name="servletbundle"        value="javax.servlet_2.4.0.v200706111738.jar"/>
	<property name="serverbundle"         value="com.openexchange.server.jar"/>
	<property name="globalbundle"         value="com.openexchange.global.jar"/>
	<property name="configbundle"         value="com.openexchange.configread.jar"/>
	<property name="commonjar"            value="common.jar"/>

	<!-- non-osgi jars -->
	<property name="mail"     value="mail-1.4.3.jar"/>
	<property name="jsonjar"  value="json.jar" />

	<path id="project.classpath">
        <pathelement location="${bundlesdir}/${osgibundle}"/>
        <pathelement location="${bundlesdir}/${osgiservicesbundle}"/>
		<pathelement location="${bundlesdir}/${commonsloggingbundle}" />
		<pathelement location="${bundlesdir}/${serverbundle}"/>
		<pathelement location="${bundlesdir}/${globalbundle}"/>
		<pathelement location="${bundlesdir}/${configreadBundle}/${configbundle}"/>
		<pathelement location="${bundlesdir}/${servletbundle}"/>
        <pathelement location="${bundlesdir}/${commonBundle}/lib/${mail}"/>
    	<pathelement location="${bundlesdir}/${commonBundle}/lib/${jsonjar}"/>
		<pathelement location="${bundlesdir}/${commonBundle}/${commonjar}"/>
    </path>

	<!-- jars for tests -->
    <property name="httpunit" value="../openexchange-test/lib/httpunit-1.6.2.jar"/>
    <property name="junit" value="/usr/share/java/junit4.jar"/>

	<path id="projecttest.classpath">
        <pathelement location="${bundlesdir}/${osgibundle}"/>
        <pathelement location="${bundlesdir}/${osgiservicesbundle}"/>
		<pathelement location="${bundlesdir}/${commonsloggingbundle}" />
		<pathelement location="${bundlesdir}/${serverbundle}"/>
		<pathelement location="${bundlesdir}/${globalbundle}"/>
		<pathelement location="${bundlesdir}/${configbundle}"/>
		<pathelement location="${bundlesdir}/${servletbundle}"/>
        <pathelement location="${bundlesdir}/${commonBundle}/lib/${mail}"/>
    	<pathelement location="${bundlesdir}/${commonBundle}/lib/${jsonjar}"/>
    	<pathelement location="${httpunit}"/>
    	<pathelement location="${junit}"/>
    	<pathelement location="jar/${bundle.name}"/>
    </path>

	
    <!--                    TARGETS                      -->
    <target name="prepare">
    	<delete dir="src/org/apache/jsieve/parser/generated"/>
        <!-- This target generated parts of the code out of the grammar file vor jjtree -->
        <mkdir dir="${src}${jsieveprefix}/jsieve/parser/generated"/>
        <java classname="jjtree" fork="yes" failonerror="true" dir="${src}">
            <arg line="-output_directory=${src}${jsieveprefix}/jsieve/parser/generated ${javacc.dir}/sieve.jjt"/>
            <classpath>
                <pathelement location="${javacc.jar}"/>
                <pathelement path="${java.class.path}" />
            </classpath>
       </java>

        <!-- This part isn't needed anymore if we switch to JAVACC 4.0 which isn't supplied with Ubuntu at the moment -->
        <replace file="${src}${jsieveprefix}/jsieve/parser/generated/SimpleNode.java" token="public class SimpleNode" value="public class SimpleNode extends ${jsievejavaprefix}.jsieve.parser.SieveNode"/>

        <java classname="javacc" fork="yes" failonerror="true" dir="${src}">
             <arg line="-output_directory=${src}${jsieveprefix}/jsieve/parser/generated ${src}${jsieveprefix}/jsieve/parser/generated/sieve.jj"/>
             <classpath>
                 <pathelement location="${javacc.jar}"/>
                 <pathelement path="${java.class.path}" />
             </classpath>
        </java>
    
        <delete file="${src}${jsieveprefix}/jsieve/parser/generated/sieve.jj"/>
    </target>

    <target name="compile" depends="prepare">
        <mkdir dir="classes"/>
        <javac failonerror="true" srcdir="src" debug="true" destdir="classes">
            <classpath>
                <path refid="project.classpath"/>
            </classpath>
        </javac>
    </target>

    <target name="jar" depends="compile">
        <mkdir dir="jar"/>
        <jar jarfile="jar/${bundle.name}"
        basedir="classes"
        manifest="META-INF/MANIFEST.MF"/>
    </target>

    <target name="testcompile">
        <mkdir dir="classes"/>
        <javac failonerror="true" srcdir="test" debug="true" destdir="classes">
            <classpath>
                <path refid="projecttest.classpath"/>
            </classpath>
        </javac>
    </target>

	<target name="testjar" depends="testcompile, jar">
        <mkdir dir="jar"/>
        <jar jarfile="jar/${bundletest.name}"
        basedir="classes"
        manifest="META-INF/MANIFEST.MF"/>
    </target>

	<target name="clean">
	    <delete dir="src/org/apache/jsieve/parser/generated"/>
        <delete dir="classes"/>
        <delete dir="jar"/>
    </target>

    <target name="dist" depends="clean">
		<property name="dist-package" value="dist-package"/>
    	<delete dir="${dist-package}"/>
        <mkdir dir="${dist-package}/${composite.name}"/>
        <copy todir="${dist-package}/${composite.name}">
            <fileset dir=".">
                <exclude name="**${dist-package}/**"/>
                <exclude name="**debian/**"/>
                <exclude name="**CVS/**"/>
                <exclude name="Todo"/>
            </fileset>
        </copy>
        <tar destfile="../${composite.name}.tar.gz"
        basedir="${dist-package}"
        includes="${composite.name}/"
        compression="gzip"/>
    	<delete dir="${dist-package}"/>
    </target>

    <target name="install" depends="jar">
        <mkdir dir="${destdir}/${prefix}/${serverconfdir}"/>
    	<copy todir="${destdir}/${prefix}/${serverconfdir}" overwrite="true">
            <fileset dir="conf" excludes="**/*.in"/>
        </copy>
        <!-- <chmod perm="640">
            <fileset dir="${destdir}/${prefix}/${serverconfdir}">
                <include name="**"/>
            </fileset>
        </chmod>-->
        <mkdir dir="${destdir}/${bundlesdir}"/>
        <copy todir="${destdir}/${bundlesdir}" file="jar/${bundle.name}" overwrite="true"/>
		<!-- generate config.ini registry snippet -->
    	<mkdir dir="${destdir}/${bundle.d}"/>
    	<echo file="${destdir}/${bundle.d}/${Bundle-SymbolicName}.ini"
            message="${bundlesdir}/${bundle.name}@start${line.separator}"/>
    </target>
	

</project>
