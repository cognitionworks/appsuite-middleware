<?xml version="1.0" encoding="UTF-8"?>
<project name="java_commons" default="download_check_and_add_jars" basedir=".">
	<description>
        Enhances target platform by downloading shared jars from artifactory.open-xchange
    </description>

	<property name="logback.jar.url" value="https://artifactory.open-xchange.com/artifactory/simple/libs-release/com/openexchange/java-commons/logback-extensions/1.0.0/logback-extensions-1.0.0.jar" />

	<target name="download_check_and_add_jars">
		<antcall target="download_check_and_add_jar">
			<param name="jar.url" value="${logback.jar.url}" />
		</antcall>
	</target>

	<target name="download_check_and_add_jar" depends="already_downloaded_test" unless="jar.found">
		
		<antcall target="download">
			<param name="url" value="${jar.url}" />
		</antcall>
		
		<antcall target="check">
			<param name="file" value="${jar.filename}" />
		</antcall>
		
		<antcall target="add_to_jars">
			<param name="file" value="${jar.filename}" />
		</antcall>
		
	</target>

	<target name="already_downloaded_test">
		<basename property="jar.filename" file="${jar.url}" />
		<available file="jars/${jar.filename}" property="jar.found"/>
	</target>

	<target name="download">
		<get dest=".">
			<url url="${url}" />
		</get>
	</target>

	<target name="check">
		<antcall target="download">
			<param name="url" value="${jar.url}.md5" />
		</antcall>
		<checksum file="${file}" fileext=".md5" verifyproperty="checksum.matches" />
		<condition property="checksum.matches.fail">
			<equals arg1="${checksum.matches}" arg2="false" />
		</condition>
		<echo message="MD5 matches for file ${file}: ${checksum.matches}" />
		<fail if="checksum.matches.fail">Checksum error</fail>
		<delete file="${file}.md5" />
	</target>

	<target name="add_to_jars">
		<move file="${file}" todir="jars" />
	</target>

</project>