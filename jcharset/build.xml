<?xml version="1.0" encoding="UTF-8"?>
<project name="net.freeutils.jcharset" default="install" basedir=".">

    <!-- Customizable values -->
    <property name="destdir" value=""/>
    <property name="prefix" value="/opt/open-xchange"/>

    <!-- Constants -->
    <property name="tmp.dir" value="tmp"/>
    <property name="libDir" value="lib"/>

    <property file="META-INF/MANIFEST.MF"/>
    <property file="build.properties"/>

    <property name="version" value="${Bundle-Version}"/>
    <property name="bundle.name" value="${Bundle-SymbolicName}"/>
    <property name="distpackage.name" value="open-xchange-jcharset"/>
    <property name="composite.name" value="${distpackage.name}-${version}"/>

    <!-- Install Constants -->
    <property name="bundlesdir" value="${prefix}/bundles"/>
    <property name="bundle.d" value="${prefix}/etc/groupware/osgi/bundle.d"/>

    <!-- Third party libs -->
    <fileset dir="${libDir}" id="3rdpartyjars">
        <include name="*.jar"/>
        <exclude name="CVS"/>
    </fileset>

    <fileset dir="." id="metainf">
        <include name="META-INF/**"/>
        <exclude name="CVS"/>
    </fileset>

    <!-- JAR names for classpath -->
    <property name="osgijar" value="org.eclipse.osgi_3.3.0.v20070530.jar" />
    <property name="commonsloggingjar" value="org.apache.commons.logging_1.0.4.v200706111724.jar" />

    <!-- Classpath -->
    <path id="project.classpath">
        <pathelement location="${bundlesdir}/${osgijar}"/>
        <pathelement location="${bundlesdir}/${commonsloggingjar}"/>
        <fileset refid="3rdpartyjars"/>
    </path>

    <!-- Compile -->
    <target name="prepare">
        <mkdir dir="${output.net.freeutils.jcharset.osgi.jar}"/>
        <mkdir dir="${tmp.dir}"/>
    </target>

    <target name="compile" depends="prepare">
        <javac srcdir="${source.net.freeutils.jcharset.osgi.jar}" destdir="${output.net.freeutils.jcharset.osgi.jar}" debug="true" encoding="US-ASCII" source="1.5" compiler="javac1.5" target="1.5">
            <classpath refid="project.classpath"/>
        </javac>
    </target>

    <target name="jar" depends="prepare,compile">
        <jar jarfile="${tmp.dir}/net.freeutils.jcharset.osgi.jar">
            <fileset dir="${output.net.freeutils.jcharset.osgi.jar}"/>
        </jar>
    </target>

    <!-- Install targets -->
    <target name="install" depends="installJars,installConfig"/>

    <target name="installConfig">
        <mkdir dir="${destdir}/${bundle.d}"/>
        <echo file="${destdir}/${bundle.d}/${Bundle-SymbolicName}.ini" message="${bundlesdir}/${bundle.name}@start${line.separator}"/>
    </target>

    <target name="installJars" depends="jar">
        <property name="bundlesdestdir" value="${destdir}${bundlesdir}"/>
        <mkdir dir="${bundlesdestdir}"/>
        <property name="jcharsetdir" value="${bundlesdestdir}/${bundle.name}"/>
        <mkdir dir="${jcharsetdir}"/>
        <mkdir dir="${jcharsetdir}/lib"/>
        <copy todir="${jcharsetdir}/lib">
            <fileset refid="3rdpartyjars"/>
        </copy>
        <copy todir="${jcharsetdir}">
            <fileset refid="metainf"/>
            <fileset dir="${tmp.dir}" includes="net.freeutils.jcharset.osgi.jar"/>
        </copy>
    </target>

    <!-- Dist -->
    <target name="dist" depends="clean">
        <property name="dist-package" value="dist-package"/>
        <delete dir="${dist-package}"/>
        <mkdir dir="${dist-package}/${composite.name}"/>
        <copy todir="${dist-package}/${composite.name}">
            <fileset dir=".">
                <exclude name="**${dist-package}/**"/>
                <exclude name="**debian/**"/>
                <exclude name="**CVS/**"/>
                <exclude name="Todo"/>
            </fileset>
        </copy>
        <tar destfile="../${composite.name}.tar.gz"
            basedir="${dist-package}"
            includes="${composite.name}/"
             compression="gzip"/>        <!-- dpkg-source does not like anything else -->
        <delete dir="${dist-package}"/>
    </target>

    <target name="clean">
        <delete dir="${tmp.dir}"/>
        <delete dir="${output..}"/>
    </target>

</project>
