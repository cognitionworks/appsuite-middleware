<?xml version="1.0" encoding="UTF-8"?>
<project name="oxscript overrides" basedir=".">

    <description>
        This build file uses the postInstall target to patch a lot of script files before installing them.
    </description>

    <!-- Customizable values -->
    <!-- This values must be changed for defining other installation places -->
    <property name="logInstallDir" value="/var/log/open-xchange"/>

    <!-- Constants -->
    <property name="osgiDir" value="osgi"/>
    <property name="sbinDir" value="sbin"/>

    <import file="build-project.xml"/>

    <target name="postInstall">
        <antcall target="patchAndInstallConfigIniTemplate"/>
        <antcall target="patchAndInstallScripts"/>
    </target>

    <target name="patchAndInstallConfigIniTemplate" description="Patches and installs config.ini.template file.">
        <mkdir dir="${tmpDir}/${osgiDir}"/>
        <copy todir="${tmpDir}/${osgiDir}" overwrite="true">
            <fileset dir="${osgiDir}"/>
        </copy>
        <move tofile="${tmpDir}/${osgiDir}/config.ini.template" file="${tmpDir}/${osgiDir}/config.ini.template.in" overwrite="true"/>
        <replace file="${tmpDir}/${osgiDir}/config.ini.template">
            <replacefilter token="@bundlesdir@" value="${bundlesDir}"/>
            <replacefilter token="@logfile@" value="${logInstallDir}/open-xchange-osgi.log"/>
        </replace>
        <copy todir="${destDir}/${prefix}/${osgiDir}">
            <fileset dir="${tmpDir}/${osgiDir}"/>
        </copy>
    </target>

    <target name="patchAndInstallScripts" depends="patchScripts">
        <property name="sbinInstallCopyDir" value="${destDir}/${prefix}/${sbinDir}"/>
        <copy todir="${sbinInstallCopyDir}" overwrite="true">
            <fileset dir="${patchSbinDir}"/>
        </copy>
        <chmod perm="755" file="${sbinInstallCopyDir}/checkconsistency"/>
        <chmod perm="755" file="${sbinInstallCopyDir}/checkconfigconsistency"/>
        <chmod perm="755" file="${sbinInstallCopyDir}/forceupdatetask"/>
        <chmod perm="755" file="${sbinInstallCopyDir}/listExecutedUpdateTasks"/>
        <chmod perm="755" file="${sbinInstallCopyDir}/logincounter"/>
        <chmod perm="755" file="${sbinInstallCopyDir}/open-xchange-groupware"/>
        <chmod perm="755" file="${sbinInstallCopyDir}/oxreport"/>
        <chmod perm="755" file="${sbinInstallCopyDir}/restoregabdefaults"/>
        <chmod perm="755" file="${sbinInstallCopyDir}/runupdate"/>

        <!-- TODO <copy todir="${destdir}/" overwrite="true">
            <fileset dir="system"/>
            <mapper type="glob" from="*.${distribution}" to="*"/>
        </copy>
        <chmod perm="755" file="${destdir}/etc/init.d/open-xchange-groupware"/> -->
    </target>

    <target name="patchScripts">
        <property name="patchSbinDir" value="${tmpDir}/${sbinDir}"/>
        <mkdir dir="${patchSbinDir}"/>
        <antcall target="moveAndPatchScripts">
            <param name="conf.subst.patch" value="${conf.install.dir}"/>
            <param name="lib.subst.patch" value="${lib.install.dir}"/>
        </antcall>
    </target>

    <target name="moveAndPatchScripts">
        <copy todir="${patchSbinDir}" overwrite="true">
            <fileset dir="${sbinDir}"/>
            <mapper type="glob" from="*.in" to="*"/>
        </copy>
        <replace dir="${patchSbinDir}" includes="checkconsistency checkconfigconsistency forceupdatetask listExecutedUpdateTasks logincounter open-xchange-groupware restoregabdefaults runupdate">
            <replacefilter token="@oxfunctions@" value="${prefix}/${sbinDir}/oxfunctions.sh"/>
            <replacefilter token="@oxscriptconf@" value="${conf.subst.patch}/ox-scriptconf.sh"/>
            <replacefilter token="@prefix@" value="${prefix}"/>
            <replacefilter token="@consolelogfile@" value="${log.install.dir}/open-xchange-console.log"/>
            <replacefilter token="@configini@" value="${conf.subst.patch}/osgi/config.ini"/>
            <replacefilter token="@bundle.d@" value="${gwbundle.d}"/>
        </replace>
    </target>

</project>
