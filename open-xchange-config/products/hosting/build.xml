<project name="Open-Xchange config for hosting" default="installConfig" basedir=".">

    <description>
        Open-Xchange configuration for hosting
    </description>

    <!-- Customizable values -->
    <property name="destdir" value=""/>
    <property name="prefix" location="/opt/open-xchange"/>
    <property name="log.install.dir" value="/var/log/open-xchange"/>

    <!-- Directories -->
    <property name="tmp.dir" value="tmp"/>
    <property name="conf.dir" value="conf"/>

    <!-- Replacements -->
    <property name="conf.install.dir" value="${prefix}/etc/groupware"/>
    <property name="conf.install.copy.dir" location="${destdir}${conf.install.dir}"/>

    <!-- Install -->

	<target name="prepare">
        <mkdir dir="${tmp.dir}"/>
    </target>

    <target name="patchConfig" depends="prepare">
        <property name="patch.conf.dir" value="${tmp.dir}/${conf.dir}"/>
        <mkdir dir="${patch.conf.dir}"/>
        <copy todir="${patch.conf.dir}" overwrite="true">
            <fileset dir="${conf.dir}"/>
        </copy>
        <antcall target="patchConfigFiles">
            <param name="conf.subst.patch" value="${conf.install.dir}"/>
        </antcall>
    </target>

    <target name="installConfig" depends="patchConfig">
        <mkdir dir="${conf.install.copy.dir}"/>
        <copy todir="${conf.install.copy.dir}" overwrite="true">
            <fileset dir="${patch.conf.dir}">
                <exclude name="*.in"/>
            </fileset>
        </copy>
    </target>

    <target name="clean">
        <delete dir="${tmp.dir}"/>
    </target>

    <!-- Template stuff -->

    <target name="patchConfigFiles">
        <fail message="Define conf.subst.patch." unless="conf.subst.patch"/>
        <antcall target="patchFileLoggingProperties"/>
        <antcall target="patchScriptConf"/>
        <antcall target="patchSessiondProperties"/>
        <antcall target="patchSystemProperties"/>
    </target>

    <target name="patchFileLoggingProperties">
        <move tofile="${patch.conf.dir}/file-logging.properties"
            file="${patch.conf.dir}/file-logging.properties.in" overwrite="true"/>
        <replace file="${patch.conf.dir}/file-logging.properties">
            <replacefilter token="@serverlogfile@" value="${log.install.dir}/open-xchange.log"/>
        </replace>
    </target>

    <target name="patchScriptConf">
        <move tofile="${patch.conf.dir}/ox-scriptconf.sh" file="${patch.conf.dir}/ox-scriptconf.sh.in" overwrite="true"/>
        <replace file="${patch.conf.dir}/ox-scriptconf.sh">
            <replacefilter token="@systemproperties@" value="${conf.subst.patch}/system.properties"/>
            <replacefilter token="@loggingproperties@" value= "${conf.subst.patch}/file-logging.properties"/>
        </replace>
    </target>

    <target name="patchSessiondProperties">
        <move tofile="${patch.conf.dir}/sessiond.properties" file="${patch.conf.dir}/sessiond.properties.in" overwrite="true"/>
        <replace file="${patch.conf.dir}/sessiond.properties">
            <replacefilter token="@sessiondport@" value="33333"/>
        </replace>
    </target>

    <target name="patchSystemProperties">
        <move tofile="${patch.conf.dir}/system.properties" file="${patch.conf.dir}/system.properties.in" overwrite="true"/>
        <replace file="${patch.conf.dir}/system.properties">
            <replacefilter token="@oxgroupwaresysconfdir@" value="${conf.subst.patch}"/>
        </replace>
    </target>

</project>