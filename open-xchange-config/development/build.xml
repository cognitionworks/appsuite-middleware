<project name="Open-Xchange Development Config" default="default" basedir=".">

    <description>
        Open-Xchange Collaboration Suite Server Development Configuration
    </description>

    <!-- Directories -->
    <property name="tmp.dir" value="tmp"/>
    <property name="conf.dir" value="conf"/>

    <!-- Replacements -->
    <property name="conf.install.dir" value="${basedir}/${tmp.dir}"/>

	<!-- Data Retention property file -->
	<property name="dataretention.properties" value="${basedir}/${tmp.dir}/dataretention.properties"/>

    <target name="prepare">
        <mkdir dir="${tmp.dir}"/>
    </target>

    <target name="patchConfig" depends="prepare">
        <property name="patch.conf.dir" value="${tmp.dir}"/>
        <mkdir dir="${patch.conf.dir}"/>
        <copy todir="${patch.conf.dir}" overwrite="true">
            <fileset dir="${conf.dir}"/>
        </copy>
        <antcall target="patchConfigFiles">
            <param name="conf.subst.patch" value="${conf.install.dir}"/>
        </antcall>
    </target>

    <target name="install" depends="patchConfig"/>

    <target name="default" depends="install"/>

    <target name="clean">
        <delete dir="${tmp.dir}"/>
    </target>

    <target name="patchConfigFiles">
        <fail message="Define conf.subst.patch." unless="conf.subst.patch"/>
        <antcall target="patchSessiondProperties"/>
        <antcall target="patchPath"/>
    	<antcall target="patchDataRetentionProperties"/>
    </target>

    <target name="patchSessiondProperties">
        <move tofile="${patch.conf.dir}/sessiond.properties" file="${patch.conf.dir}/sessiond.properties.in" overwrite="true"/>
        <replace file="${patch.conf.dir}/sessiond.properties">
            <replacefilter token="@sessiondport@" value="33333"/>
        </replace>
    </target>

    <target name="patchPath">
        <move todir="${patch.conf.dir}" includeemptydirs="false">
            <fileset dir="${patch.conf.dir}">
                <include name="*.in"/>
            </fileset>
            <mapper type="glob" from="*.in" to="*"/>
        </move>
        <replace dir="${patch.conf.dir}">
            <replacefilter token="@oxgroupwaresysconfdir@" value="${conf.subst.patch}"/>
        </replace>
    </target>

	<target name="patchDataRetentionProperties">
		<replace file="${dataretention.properties}" token="com.openexchange.dataretention.dir=/var/log/open-xchange" value="com.openexchange.dataretention.dir=${conf.install.dir}">
		</replace>
	</target>

</project>