<project name="Open-Xchange Development Config" default="default" basedir=".">

    <description>
        Open-Xchange Collaboration Suite Server Development Configuration
    </description>

    <!-- Directories -->
    <property name="tmpDir" value="tmp"/>
    <property name="adminTmpDir" value="adminTmp"/>
    <property name="confDir" value="conf"/>
    <property name="adminConfDir" value="adminConf"/>

    <!-- Replacements -->
    <property name="confInstallDir" value="${basedir}/${tmpDir}"/>

    <!-- Data Retention property file -->
    <property name="dataretention.properties" value="${basedir}/${tmpDir}/dataretention.properties"/>

    <target name="prepare">
        <mkdir dir="${tmpDir}"/>
        <mkdir dir="${adminTmpDir}"/>
    </target>

    <target name="patchConfig" depends="prepare">
        <property name="patchConfDir" value="${tmpDir}"/>
        <copy todir="${patchConfDir}" overwrite="true">
            <fileset dir="${confDir}"/>
        </copy>
        <antcall target="patchConfigFiles">
            <param name="confSubstPatch" value="${confInstallDir}"/>
            <param name="patchConfDir" value="${patchConfDir}"/>
        </antcall>
    </target>

    <target name="patchAdminConfig" depends="prepare">
        <property name="patchConfDir" value="${adminTmpDir}"/>
        <copy todir="${patchConfDir}" overwrite="true">
            <fileset dir="${adminConfDir}"/>
        </copy>
        <antcall target="patchAdminConfigFiles">
            <param name="confAdminSubstPatch" value="${basedir}/${adminTmpDir}"/>
            <param name="confGroupSubstPatch" value="${basedir}/${tmpDir}"/>
        </antcall>
    </target>

    <target name="install">
        <antcall target="patchConfig"/>
        <antcall target="patchAdminConfig"/>
    </target>

    <target name="default" depends="install"/>

    <target name="clean">
        <delete dir="${tmpDir}"/>
        <delete dir="${adminTmpDir}"/>
    </target>

    <target name="patchConfigFiles">
        <fail message="Define confSubstPatch." unless="confSubstPatch"/>
    	<antcall target="patchCrawlerProperties"/>
        <antcall target="patchPath"/>
        <antcall target="patchDataRetentionProperties"/>
    </target>

    <target name="patchAdminConfigFiles">
        <fail message="Define confGroupSubstPatch." unless="confGroupSubstPatch"/>
        <fail message="Define confAdminSubstPatch." unless="confAdminSubstPatch"/>
        <antcall target="patchAdminPath"/>
    </target>
	
	<target name="patchCrawlerProperties">
        <move tofile="${patchConfDir}/crawler.properties" file="${patchConfDir}/crawler.properties.in" overwrite="true"/>
        <replace file="${patchConfDir}/crawler.properties">
            <replacefilter token="@oxgroupwaresysconfdir@" value="${basedir}"/>
        </replace>
	</target>

    <target name="patchPath">
        <move todir="${patchConfDir}" includeemptydirs="false">
            <fileset dir="${patchConfDir}">
                <include name="*.in"/>
            </fileset>
            <mapper type="glob" from="*.in" to="*"/>
        </move>
        <replace dir="${patchConfDir}">
            <replacefilter token="@oxgroupwaresysconfdir@" value="${confSubstPatch}"/>
        </replace>
    </target>

    <target name="patchAdminPath">
        <move todir="${patchConfDir}" includeemptydirs="false">
            <fileset dir="${patchConfDir}">
                <include name="*.in"/>
            </fileset>
            <mapper type="glob" from="*.in" to="*"/>
        </move>
        <replace dir="${patchConfDir}">
            <replacefilter token="$PWD/" value=""/>
            <replacefilter token="INITIAL_OX_SQL_DIR=@oxconfdir@" value="INITIAL_OX_SQL_DIR=${basedir}/../com.openexchange.admin/etc"/>
            <replacefilter token="@oxconfdir@" value="${confAdminSubstPatch}"/>
            <replacefilter token="@serverconfdir@" value="${confGroupSubstPatch}"/>
            <replacefilter token="@oxgroupwaresysconfdir@" value="${confGroupSubstPatch}"/>
        </replace>
    </target>

    <target name="patchDataRetentionProperties">
        <replace file="${dataretention.properties}" token="com.openexchange.dataretention.dir=/var/log/open-xchange" value="com.openexchange.dataretention.dir=${confInstallDir}">
        </replace>
    </target>

</project>
