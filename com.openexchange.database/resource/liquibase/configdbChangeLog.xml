<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="urn:liquibase"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="urn:liquibase /liquibase/dbchangelog-3.0.xsd"
    logicalFilePath="configdbChangeLog">


    <!-- ******************************************************* -->
    <!-- ************** Release 7.6.1 starts here ************** -->
    <!-- ******************************************************* -->

    <changeSet id="7.6.1-milestone" author="martin.schneider@open-xchange.com">
        <tagDatabase tag="7.6.1-milestone" />
    </changeSet>

    <changeSet id="7.6.1:login2context:login_info" author="martin.schneider@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <customPrecondition
                className="liquibase.precondition.ext.ColumnSizePrecondition">
                <param name="expectedSize" value="255" />
                <param name="tableName" value="login2context" />
                <param name="columnName" value="login_info" />
            </customPrecondition>
        </preConditions>
        <comment>Fix for bug 33418: enhances the login_info column to 255
            characters</comment>
        <modifyDataType columnName="login_info" newDataType="varchar(255)"
            tableName="login2context" />
        <dropDefaultValue columnDataType="varchar(255)"
            columnName="login_info" tableName="login2context" />
        <rollback>
            <dropDefaultValue tableName="login2context"
                columnName="login_info" />
            <modifyDataType tableName="login2context" columnName="login_info"
                newDataType="varchar(128)" />
            <dropDefaultValue columnDataType="varchar(128)"
                columnName="login_info" tableName="login2context" />
        </rollback>
    </changeSet>

    <!-- ******************************************************* -->
    <!-- ************** Release 7.6.2 starts here ************** -->
    <!-- ******************************************************* -->

    <changeSet id="7.6.2:changelog:addprimarykey" author="martin.schneider@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <primaryKeyExists tableName="DATABASECHANGELOG"/>
            </not>
        </preConditions>
        <comment>Add missing primary key for DATABASECHANGELOG</comment>
        <addPrimaryKey columnNames="id, author, filename" tableName="DATABASECHANGELOG" />
    </changeSet>

    <changeSet id="7.6.2:context_server2db_pool:addpoolandschemaindex" author="thorben.betten@open-xchange.com">
        <validCheckSum>7:8ecb4a685838eb81a07d77c4835f6bce</validCheckSum>
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists tableName="context_server2db_pool"  columnNames="write_db_pool_id,db_schema"/>
            </not>
        </preConditions>
        <comment>Add index to context_server2db_pool table for columns write_db_pool_id and db_schema</comment>
        <createIndex indexName="poolAndSchema" tableName="context_server2db_pool">
            <column name="write_db_pool_id"/>
            <column name="db_schema"/>
        </createIndex>
        <rollback>
            <dropIndex indexName="poolAndSchema" tableName="context_server2db_pool"/>
        </rollback>
    </changeSet>

    <changeSet id="7.6.2:milestone" author="martin.schneider@open-xchange.com">
        <tagDatabase tag="7.6.2:milestone" />
    </changeSet>

    <!-- ******************************************************* -->
    <!-- ************** Release 7.8.0 starts here ************** -->
    <!-- *******************************************************

    <changeSet id="7.8.0:guest:create" author="martin.schneider@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="guest" />
            </not>
        </preConditions>
        <comment>
            Add table 'guest' to save known login addresses of guest users.
        </comment>
        <sql>
            CREATE TABLE guest (
                id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
                mail_address VARCHAR(255) NOT NULL,
                PRIMARY KEY (id),
                INDEX (mail_address),
                UNIQUE (id),
                UNIQUE (mail_address)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
        </sql>
        <rollback>
            <dropTable tableName="guest" />
        </rollback>
    </changeSet>

    <changeSet id="7.8.0:guest2context:create" author="martin.schneider@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="guest2context" />
            </not>
        </preConditions>
        <comment>
            Add table 'guest2context' to save mappings from guests to context and users.
        </comment>
        <sql>
            CREATE TABLE guest2context (
                guest_id BIGINT UNSIGNED NOT NULL,
                cid INT4 UNSIGNED NOT NULL,
                uid INT4 UNSIGNED NOT NULL,
                PRIMARY KEY(`guest_id`, `cid`,`uid`),
                FOREIGN KEY(`cid`) REFERENCES context(`cid`),
                FOREIGN KEY(`guest_id`) REFERENCES guest (`id`),
                INDEX(guest_id)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
        </sql>
        <rollback>
            <dropTable tableName="guest2context" />
        </rollback>
    </changeSet>

    <changeSet id="7.8.0:oauth_client:create" author="steffen.templin@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="oauth_client" />
            </not>
        </preConditions>
        <comment>
            Add table 'oauth_client' to persist OAuth 2.0 client registrations
        </comment>
        <sql>
            CREATE TABLE oauth_client (
                id VARCHAR(255) NOT NULL,
                secret VARCHAR(255) NOT NULL,
                name VARCHAR(255) UNIQUE NOT NULL,
                description TEXT NOT NULL,
                icon MEDIUMBLOB NOT NULL,
                icon_mime_type VARCHAR(32) NOT NULL,
                default_scope VARCHAR(767) NOT NULL,
                contact_address VARCHAR(255) NOT NULL,
                website VARCHAR(255) NOT NULL,
                enabled TINYINT UNSIGNED NOT NULL,
                registration_date BIGINT(64) UNSIGNED NOT NULL,
                PRIMARY KEY (`id`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
        </sql>
        <rollback>
            <dropTable tableName="oauth_client"/>
        </rollback>
    </changeSet>

    <changeSet id="7.8.0:oauth_client_uri:create" author="steffen.templin@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="oauth_client_uri" />
            </not>
        </preConditions>
        <comment>
            Add table 'oauth_client_uri' to persist OAuth 2.0 client redirect URIs
        </comment>
        <sql>
            CREATE TABLE oauth_client_uri (
                id INT4 NOT NULL AUTO_INCREMENT,
                client VARCHAR(255) NOT NULL,
                uri VARCHAR(767) NOT NULL,
                PRIMARY KEY (`id`),
                INDEX `client_index` (`client`)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
        </sql>
        <rollback>
            <dropTable tableName="oauth_client_uri"/>
        </rollback>
    </changeSet>

    <changeSet id="7.8.0-milestone" author="martin.schneider@open-xchange.com">
        <tagDatabase tag="7.8.0-milestone" />
    </changeSet>
    -->
</databaseChangeLog>
