/*
 *
 *    OPEN-XCHANGE legal information
 *
 *    All intellectual property rights in the Software are protected by
 *    international copyright laws.
 *
 *
 *    In some countries OX, OX Open-Xchange, open xchange and OXtender
 *    as well as the corresponding Logos OX Open-Xchange and OX are registered
 *    trademarks of the Open-Xchange, Inc. group of companies.
 *    The use of the Logos is not covered by the GNU General Public License.
 *    Instead, you are allowed to use these Logos according to the terms and
 *    conditions of the Creative Commons License, Version 2.5, Attribution,
 *    Non-commercial, ShareAlike, and the interpretation of the term
 *    Non-commercial applicable to the aforementioned license is published
 *    on the web site http://www.open-xchange.com/EN/legal/index.html.
 *
 *    Please make sure that third-party modules and libraries are used
 *    according to their respective licenses.
 *
 *    Any modifications to this package must retain all copyright notices
 *    of the original copyright holder(s) for the original code used.
 *
 *    After any such modifications, the original and derivative code shall remain
 *    under the copyright of the copyright holder(s) and/or original author(s)per
 *    the Attribution and Assignment Agreement that can be located at
 *    http://www.open-xchange.com/EN/developer/. The contributing author shall be
 *    given Attribution for the derivative code and a license granting use.
 *
 *     Copyright (C) 2004-2012 Open-Xchange, Inc.
 *     Mail: info@open-xchange.com
 *
 *
 *     This program is free software; you can redistribute it and/or modify it
 *     under the terms of the GNU General Public License, Version 2 as published
 *     by the Free Software Foundation.
 *
 *     This program is distributed in the hope that it will be useful, but
 *     WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *     or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *     for more details.
 *
 *     You should have received a copy of the GNU General Public License along
 *     with this program; if not, write to the Free Software Foundation, Inc., 59
 *     Temple Place, Suite 330, Boston, MA 02111-1307 USA
 *
 */

package com.openexchange.http.grizzly.services.atmosphere;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

/**
 * {@link AtmosphereJSServlet}
 *
 * @author <a href="mailto:francisco.laguna@open-xchange.com">Francisco Laguna</a>
 */
public class AtmosphereJSServlet extends HttpServlet {
	private static final long serialVersionUID = 2028538891724626568L;
	private static final String JS = "jQuery.atmosphere=function(){jQuery(window).bind(\"beforeunload\",function(){jQuery.atmosphere.unsubscribe()});var a=function(a){var b,c=/^(.*?):[ \\t]*([^\\r\\n]*)\\r?$/mg,d={};while(b=c.exec(a))d[b[1]]=b[2];return d};return{version:\"1.0\",requests:[],callbacks:[],onError:function(a){},onClose:function(a){},onOpen:function(a){},onMessage:function(a){},onReconnect:function(a,b){},onMessagePublished:function(a){},onTransportFailure:function(a){},onLocalMessage:function(a){},AtmosphereRequest:function(b){function q(){j=!0,l=!1,k=0,e=null,f=null,g=null,h=null}function r(){bf(),q()}function s(a){r(),c=jQuery.extend(c,a)}function t(){return c.webSocketImpl!=null||window.WebSocket||window.MozWebSocket}function u(){return window.EventSource}function v(){if(c.shared&&!jQuery.browser.opera){o=w(c);if(o!=null){c.logLevel==\"debug\"&&jQuery.atmosphere.debug(\"Storage service available. All communication will be local\");if(o.open(c))return}c.logLevel==\"debug\"&&jQuery.atmosphere.debug(\"No Storage service available.\"),o=null}c.transport!=\"websocket\"&&c.transport!=\"sse\"?(y(\"opening\",c.transport,c),L()):c.transport==\"websocket\"?t()?F(!1):I(\"Websocket is not supported, using request.fallbackTransport (\"+c.fallbackTransport+\")\"):c.transport==\"sse\"&&(u()?E(!1):I(\"Server Side Events(SSE) is not supported, using request.fallbackTransport (\"+c.fallbackTransport+\")\"))}function w(a){function h(b){var d=jQuery.parseJSON(b),f=d.data;if(d.target===\"c\")switch(d.type){case\"open\":y(\"opening\",\"local\",c);break;case\"close\":e=!0,f.reason===\"aborted\"?be():(ba(\"\",\"closed\",200,c.transport),f.heir===p?be():setTimeout(function(){be()},100));break;case\"message\":ba(f,\"messageReceived\",200,a.transport);break;case\"localMessage\":_(f)}}var d,e,f=\"atmosphere-\"+a.url,g={storage:function(){if(!jQuery.atmosphere.supportStorage())return;var b=window.localStorage,c=function(a){return jQuery.parseJSON(b.getItem(f+\"-\"+a))},d=function(a,c){b.setItem(f+\"-\"+a,jQuery.stringifyJSON(c))};return{init:function(){return d(\"children\",c(\"children\").concat([p])),jQuery(window).on(\"storage.socket\",function(a){a=a.originalEvent,a.key===f&&a.newValue&&h(a.newValue)}),c(\"opened\")},signal:function(a,c){b.setItem(f,jQuery.stringifyJSON({target:\"p\",type:a,data:c}))},close:function(){var b,e=c(\"children\");jQuery(window).off(\"storage.socket\"),e&&(b=jQuery.inArray(a.id,e),b>-1&&(e.splice(b,1),d(\"children\",e)))}}},windowref:function(){var a=window.open(\"\",f.replace(/\\W/g,\"\"));if(!a||a.closed||!a.callbacks)return;return{init:function(){return a.callbacks.push(h),a.children.push(b.id),a.opened},signal:function(b,c){!a.closed&&a.fire&&a.fire(jQuery.stringifyJSON({target:\"p\",type:b,data:c}))},close:function(){function c(a,b){var c=jQuery.inArray(b,a);c>-1&&a.splice(c,1)}e||(c(a.callbacks,h),c(a.children,b.id))}}}};if(!(new RegExp(\"(?:^|; )(\"+encodeURIComponent(f)+\")=([^;]*)\")).test(document.cookie))return;d=g.storage()||g.windowref();if(!d)return;return{open:function(){var b;return b=d.init(),b&&setTimeout(function(){y(\"opening\",\"local\",a)},50),b},send:function(a){d.signal(\"send\",a)},localSend:function(a){d.signal(\"localSend\",jQuery.stringifyJSON({id:p,event:a}))},close:function(){l||(d.signal(\"close\"),d.close())}}}function x(){function e(a){var b=jQuery.parseJSON(a),c=b.data;if(b.target===\"p\")switch(b.type){case\"send\":S(c);break;case\"localSend\":_(c);break;case\"close\":be()}}var a,b=\"atmosphere-\"+c.url,d={storage:function(){if(!jQuery.atmosphere.supportStorage())return;var a=window.localStorage;return{init:function(){jQuery(window).on(\"storage.socket\",function(a){a=a.originalEvent,a.key===b&&a.newValue&&e(a.newValue)})},signal:function(c,d){a.setItem(b,jQuery.stringifyJSON({target:\"c\",type:c,data:d}))},get:function(c){return jQuery.parseJSON(a.getItem(b+\"-\"+c))},set:function(c,d){a.setItem(b+\"-\"+c,jQuery.stringifyJSON(d))},close:function(){jQuery(window).off(\"storage.socket\"),a.removeItem(b),a.removeItem(b+\"-opened\"),a.removeItem(b+\"-children\")}}},windowref:function(){var a=b.replace(/\\W/g,\"\"),c=(jQuery('iframe[name=\"'+a+'\"]')[0]||jQuery('<iframe name=\"'+a+'\" />').hide().appendTo(\"body\")[0]).contentWindow;return{init:function(){c.callbacks=[e],c.fire=function(a){var b;for(b=0;b<c.callbacks.length;b++)c.callbacks[b](a)}},signal:function(a,b){!c.closed&&c.fire&&c.fire(jQuery.stringifyJSON({target:\"c\",type:a,data:b}))},get:function(a){return c.closed?null:c[a]},set:function(a,b){c.closed||(c[a]=b)},close:function(){}}}};m=function(c){a.signal(\"message\",c)},document.cookie=encodeURIComponent(b)+\"=\"+jQuery.now(),a=d.storage()||d.windowref(),a.init(),c.logLevel==\"debug\"&&jQuery.atmosphere.debug(\"Installed StorageService \"+a),a.set(\"children\",[]),a.get(\"opened\")!=null&&!a.get(\"opened\")&&a.set(\"opened\",!1),n=a}function y(a,b,e){c.shared&&b!=\"local\"&&!jQuery.browser.opera&&x(),n!=null&&n.set(\"opened\",!0),e.close=function(){be(),e.reconnect=!1},d.request=e;var f=d.state;d.state=a,d.status=200;var g=d.transport;d.transport=b,bd(),d.state=f,d.transport=g}function z(a){var b=c;a!=null&&typeof a!=\"undefined\"&&(b=a);var d=b.url,e=b.data;b.attachHeadersAsQueryString&&(d=J(b),e!=\"\"&&(d+=\"&X-Atmosphere-Post-Body=\"+e),e=\"\"),i=jQuery.ajax({url:d,type:b.method,dataType:\"jsonp\",error:function(a,c,d){a.status<300&&b.requestCount++<b.maxRequest?N(i,b):ba(c,\"error\",a.status,b.transport)},jsonp:\"jsonpTransport\",success:function(a){if(b.requestCount++<b.maxRequest){b.executeCallbackBeforeReconnect||N(i,b);var d=a.message;if(d!=null&&typeof d!=\"string\")try{d=jQuery.stringifyJSON(d)}catch(e){}ba(d,\"messageReceived\",200,b.transport),b.executeCallbackBeforeReconnect&&N(i,b)}else jQuery.atmosphere.log(c.logLevel,[\"JSONP reconnect maximum try reached \"+c.requestCount]),G()},data:b.data,beforeSend:function(a){M(a,b,!1)}})}function A(a){var b=c;a!=null&&typeof a!=\"undefined\"&&(b=a);var d=b.url,e=b.data;b.attachHeadersAsQueryString&&(d=J(b),e!=\"\"&&(d+=\"&X-Atmosphere-Post-Body=\"+e),e=\"\"),i=jQuery.ajax({url:d,type:b.method,error:function(a,c,d){a.status<300&&b.requestCount++<b.maxRequest?N(i,b):ba(c,\"error\",a.status,b.transport)},success:function(a,d,e){b.requestCount++<b.maxRequest?(b.executeCallbackBeforeReconnect||N(i,b),ba(a,\"messageReceived\",200,b.transport),b.executeCallbackBeforeReconnect&&N(i,b)):(jQuery.atmosphere.log(c.logLevel,[\"AJAX reconnect maximum try reached \"+c.requestCount]),G())},data:b.data,beforeSend:function(a){M(a,b,!1)}})}function B(a){return c.webSocketImpl!=null?c.webSocketImpl:window.WebSocket?new WebSocket(a):new MozWebSocket(a)}function C(){var a=J(c);return decodeURI(jQuery('<a href=\"'+a+'\"/>')[0].href.replace(/^http/,\"ws\"))}function D(){var a=J(c);return a}function E(a){d.transport=\"sse\";var b=D(c.url);c.logLevel==\"debug\"&&(jQuery.atmosphere.debug(\"Invoking executeSSE\"),jQuery.atmosphere.debug(\"Using URL: \"+b)),a&&y(\"re-opening\",\"sse\",c);if(!c.reconnect){f!=null&&f.close();return}f=new EventSource(b,{withCredentials:c.withCredentials}),c.connectTimeout>0&&(c.id=setTimeout(function(){a||f.close()},c.connectTimeout)),f.onopen=function(b){c.logLevel==\"debug\"&&jQuery.atmosphere.debug(\"SSE successfully opened\"),a||y(\"opening\",\"sse\",c),a=!0,c.method==\"POST\"&&(d.state=\"messageReceived\",f.send(c.data))},f.onmessage=function(a){if(a.origin!=\"http://\"+window.location.host){jQuery.atmosphere.log(c.logLevel,[\"Origin was not http://\"+window.location.host]);return}d.state=\"messageReceived\",d.status=200;var a=a.data,b=H(a,c,d);jQuery.trim(a).length==0&&(b=!0),b||(bd(),d.responseBody=\"\")},f.onerror=function(b){clearTimeout(c.id),d.state=\"closed\",d.responseBody=\"\",d.status=a?200:501,bd(),l?jQuery.atmosphere.log(c.logLevel,[\"SSE closed normally\"]):a?c.reconnect&&d.transport==\"sse\"&&(k++<c.maxRequest?(c.requestCount=k,d.responseBody=\"\",E(!0)):(f.close(),jQuery.atmosphere.log(c.logLevel,[\"SSE reconnect maximum try reached \"+c.requestCount]),G())):I(\"SSE failed. Downgrading to fallback transport and resending\")}}function F(a){d.transport=\"websocket\";var b=C(c.url),f=!1;c.logLevel==\"debug\"&&(jQuery.atmosphere.debug(\"Invoking executeWebSocket\"),jQuery.atmosphere.debug(\"Using URL: \"+b)),a&&y(\"re-opening\",\"websocket\",c);if(!c.reconnect){e!=null&&e.close();return}e=B(b),c.connectTimeout>0&&(c.id=setTimeout(function(){if(!a){var b={code:1002,reason:\"\",wasClean:!1};e.onclose(b);try{e.close()}catch(c){}}},c.connectTimeout)),e.onopen=function(b){c.logLevel==\"debug\"&&jQuery.atmosphere.debug(\"Websocket successfully opened\"),a||y(\"opening\",\"websocket\",c),a=!0,c.method==\"POST\"&&(d.state=\"messageReceived\",e.send(c.data))},e.onmessage=function(a){a.data.indexOf(\"parent.callback\")!=-1&&jQuery.atmosphere.log(c.logLevel,[\"parent.callback no longer supported with 0.8 version and up. Please upgrade\"]),d.state=\"messageReceived\",d.status=200;var a=a.data,b=H(a,c,d);b||(bd(),d.responseBody=\"\")},e.onerror=function(a){clearTimeout(c.id)},e.onclose=function(b){if(f)return;var e=b.reason;if(e===\"\")switch(b.code){case 1e3:e=\"Normal closure; the connection successfully completed whatever purpose for which it was created.\";break;case 1001:e=\"The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.\";break;case 1002:e=\"The endpoint is terminating the connection due to a protocol error.\";break;case 1003:e=\"The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).\";break;case 1004:e=\"The endpoint is terminating the connection because a data frame was received that is too large.\";break;case 1005:e=\"Unknown: no status code was provided even though one was expected.\";break;case 1006:e=\"Connection was closed abnormally (that is, with no close frame being sent).\"}jQuery.atmosphere.warn(\"Websocket closed, reason: \"+e),jQuery.atmosphere.warn(\"Websocket closed, wasClean: \"+b.wasClean),d.state=\"closed\",d.responseBody=\"\",d.status=a?200:501,bd(),clearTimeout(c.id),f=!0,l?jQuery.atmosphere.log(c.logLevel,[\"Websocket closed normally\"]):a?c.reconnect&&d.transport==\"websocket\"&&(c.reconnect&&k++<c.maxRequest?(c.requestCount=k,d.responseBody=\"\",F(!0)):(jQuery.atmosphere.log(c.logLevel,[\"Websocket reconnect maximum try reached \"+c.requestCount]),jQuery.atmosphere.warn(\"Websocket error, reason: \"+b.reason),G())):I(\"Websocket failed. Downgrading to Comet and resending\")}}function G(){d.state=\"error\",d.responseBody=\"\",d.status=500,bd()}function H(a,b,c){if(b.trackMessageLength){var d=a.indexOf(b.messageDelimiter),e=c.expectedBodySize;d!=-1&&(e=a.substring(0,d),a=a.substring(d+1),c.expectedBodySize=e),d!=-1?c.responseBody=a:c.responseBody+=a;if(c.responseBody.length!=e)return!0}else c.responseBody=a;return!1}function I(a){jQuery.atmosphere.log(c.logLevel,[a]),typeof c.onTransportFailure!=\"undefined\"?c.onTransportFailure(a,c):typeof jQuery.atmosphere.onTransportFailure!=\"undefined\"&&jQuery.atmosphere.onTransportFailure(a,c),c.transport=c.fallbackTransport;if(c.reconnect&&c.transport!=\"none\"||c.transport==null)c.method=c.fallbackMethod,d.transport=c.fallbackTransport,c.id=setTimeout(function(){v()},c.reconnectInterval)}function J(a){var b=c;a!=null&&typeof a!=\"undefined\"&&(b=a);var e=b.url;return b.attachHeadersAsQueryString?e.indexOf(\"X-Atmosphere-Framework\")!=-1?e:(e+=e.indexOf(\"?\")!=-1?\"&\":\"?\",e+=\"X-Atmosphere-tracking-id=\"+b.uuid,e+=\"&X-Atmosphere-Framework=\"+jQuery.atmosphere.version,e+=\"&X-Atmosphere-Transport=\"+b.transport,b.trackMessageLength&&(e+=\"&X-Atmosphere-TrackMessageSize=true\"),b.lastTimestamp!=undefined?e+=\"&X-Cache-Date=\"+b.lastTimestamp:e+=\"&X-Cache-Date=0\",b.contentType!=\"\"&&(e+=\"&Content-Type=\"+b.contentType),jQuery.each(b.headers,function(c,f){var g=jQuery.isFunction(f)?f.call(this,b,a,d):f;g!=null&&(e+=\"&\"+encodeURIComponent(c)+\"=\"+encodeURIComponent(g))}),e):e}function K(){var a;if(jQuery.browser.msie){var b=[\"Msxml2.XMLHTTP\",\"Microsoft.XMLHTTP\"];for(var c=0;c<b.length;c++)try{a=new ActiveXObject(b[c])}catch(d){}}else window.XMLHttpRequest&&(a=new XMLHttpRequest);return a}function L(b){var e=c;if(b!=null||typeof b!=\"undefined\")e=b;if(e.transport==\"jsonp\"||e.enableXDR&&jQuery.atmosphere.checkCORSSupport()){z(e);return}if(e.transport==\"ajax\"){A(b);return}if(e.transport==\"streaming\"&&jQuery.browser.msie){e.enableXDR&&window.XDomainRequest?O(e):Q(e);return}if(e.enableXDR&&window.XDomainRequest){O(e);return}if(e.reconnect&&e.requestCount++<e.maxRequest){var f=K();M(f,e,!0),e.suspend&&(g=f),e.transport!=\"polling\"&&(d.transport=e.transport);var h=!1;jQuery.browser.msie||(f.onerror=function(){h=!0;try{d.status=XMLHttpRequest.status}catch(a){d.status=404}d.state=\"error\",N(f,e,!0)}),f.onreadystatechange=function(){if(l)return;var b=!1,g=!1;if(e.transport==\"streaming\"&&e.readyState>2&&f.readyState==4){e.readyState=0,e.lastIndex=0,N(f,e,!0);return}e.readyState=f.readyState,f.readyState==4?jQuery.browser.msie?g=!0:e.transport==\"streaming\"?g=!0:e.transport==\"long-polling\"&&(g=!0,clearTimeout(e.id)):!jQuery.browser.msie&&f.readyState==3&&f.status==200&&e.transport!=\"long-polling\"?g=!0:clearTimeout(e.id);try{if(e.readResponsesHeaders){var h=f.getResponseHeader(\"X-Atmosphere-tracking-id\");if(h!=null||h!=undefined)c.uuid=h.split(\" \").pop()}}catch(i){}if(g){var j=f.responseText;try{if(e.readResponsesHeaders){var k=f.getResponseHeader(\"X-Cache-Date\");if(k!=null||k!=undefined)c.lastTimestamp=k.split(\" \").pop()}}catch(i){}if(e.transport==\"streaming\"){var m=j.substring(e.lastIndex,j.length);d.isJunkEnded=!0,e.lastIndex==0&&m.indexOf(\"<!-- Welcome to the Atmosphere Framework.\")!=-1&&(d.isJunkEnded=!1);if(!d.isJunkEnded){var n=\"<!-- EOD -->\",o=n.length,p=m.indexOf(n)+o;p>o&&p!=m.length?d.responseBody=m.substring(p):b=!0}else{var q=j.substring(e.lastIndex,j.length);b=H(q,e,d)}e.lastIndex=j.length,jQuery.browser.opera&&jQuery.atmosphere.iterate(function(){if(f.responseText.length>e.lastIndex){try{d.status=f.status,d.headers=a(f.getAllResponseHeaders()),c.readResponsesHeaders&&c.headers&&jQuery.each(c.headers,function(a){var b=f.getResponseHeader(a);b&&(d.headers[a]=b)})}catch(b){d.status=404}d.state=\"messageReceived\",d.responseBody=f.responseText.substring(e.lastIndex),e.lastIndex=f.responseText.length,bd(),e.transport==\"streaming\"&&f.responseText.length>e.maxStreamingLength&&(f.abort(),M(f,e,!0))}},0);if(b)return}else b=H(j,e,d),e.lastIndex=j.length;try{d.status=f.status,d.headers=a(f.getAllResponseHeaders()),c.readResponsesHeaders&&c.headers&&jQuery.each(c.headers,function(a){var b=f.getResponseHeader(a);b&&(d.headers[a]=b)})}catch(i){d.status=404}e.suspend?d.state=d.status==0?\"closed\":\"messageReceived\":d.state=\"messagePublished\",e.executeCallbackBeforeReconnect||N(f,e,!1),d.responseBody.indexOf(\"parent.callback\")!=-1&&jQuery.atmosphere.log(e.logLevel,[\"parent.callback no longer supported with 0.8 version and up. Please upgrade\"]),bd(),e.executeCallbackBeforeReconnect&&N(f,e,!1),e.transport==\"streaming\"&&j.length>e.maxStreamingLength&&(f.abort(),M(f,e,!0))}},f.send(e.data),e.suspend&&(e.id=setTimeout(function(){j&&(f.abort(),s(e),v())},e.timeout)),j=!0}else jQuery.atmosphere.log(e.logLevel,[\"Max re-connection reached.\"]),G()}function M(a,b,e){var f=J(b);f=jQuery.atmosphere.prepareURL(f),e&&(a.open(b.method,f,!0),b.connectTimeout>-1&&(b.id=setTimeout(function(){b.requestCount==0&&(a.abort(),ba(\"Connect timeout\",\"closed\",200,b.transport))},b.connectTimeout))),c.withCredentials&&\"withCredentials\"in a&&(a.withCredentials=!0),c.dropAtmosphereHeaders||(a.setRequestHeader(\"X-Atmosphere-Framework\",jQuery.atmosphere.version),a.setRequestHeader(\"X-Atmosphere-Transport\",b.transport),b.lastTimestamp!=undefined?a.setRequestHeader(\"X-Cache-Date\",b.lastTimestamp):a.setRequestHeader(\"X-Cache-Date\",0),b.trackMessageLength&&a.setRequestHeader(\"X-Atmosphere-TrackMessageSize\",\"true\"),b.contentType!=\"\"&&a.setRequestHeader(\"Content-Type\",b.contentType),a.setRequestHeader(\"X-Atmosphere-tracking-id\",b.uuid)),jQuery.each(b.headers,function(c,f){var g=jQuery.isFunction(f)?f.call(this,a,b,e,d):f;g!=null&&a.setRequestHeader(c,g)})}function N(a,b,c){(c||b.suspend&&a.status==200&&b.transport!=\"streaming\"&&j)&&b.reconnect&&(y(\"re-opening\",b.transport,b),b.id=setTimeout(function(){L()},b.reconnectInterval))}function O(a){h=P(a),h.open()}function P(a){var b=c;a!=null&&typeof a!=\"undefined\"&&(b=a);var d=\"\",e=b.transport,f=0,g=function(a){var b=a.responseText,c=!1;b.indexOf(\"<!-- Welcome to the Atmosphere Framework.\")!=-1&&(c=!0);if(c){var d=\"<!-- EOD -->\",g=d.length,h=b.indexOf(d);h!==-1&&(b=b.substring(h+g+f),f+=b.length)}ba(b,\"messageReceived\",200,e)},h=new window.XDomainRequest,i=b.rewriteURL||function(a){var b=/(?:^|;\\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(b&&b[1]){case\"JSESSIONID\":return a.replace(/;jsessionid=[^\\?]*|(\\?)|$/,\";jsessionid=\"+b[2]+\"$1\");case\"PHPSESSID\":return a.replace(/\\?PHPSESSID=[^&]*&?|\\?|$/,\"?PHPSESSID=\"+b[2]+\"&\").replace(/&$/,\"\")}return a};return h.onprogress=function(){g(h)},h.onerror=function(){b.transport!=\"polling\"&&ba(h.responseText,\"error\",500,e)},h.onload=function(){d!=h.responseText&&g(h),b.transport==\"long-polling\"&&L()},{open:function(){b.method==\"POST\"&&(b.attachHeadersAsQueryString=!0);var a=J(b);b.method==\"POST\"&&(a+=\"&X-Atmosphere-Post-Body=\"+b.data),h.open(b.method,i(a)),h.send(),b.connectTimeout>-1&&(b.id=setTimeout(function(){b.requestCount==0&&(h.abort(),ba(\"Connect timeout\",\"closed\",200,b.transport))},b.connectTimeout))},close:function(){h.abort(),ba(h.responseText,\"closed\",200,e)}}}function Q(a){h=R(a),h.open()}function R(a){var b=c;a!=null&&typeof a!=\"undefined\"&&(b=a);var e,f=new window.ActiveXObject(\"htmlfile\");f.open(),f.close();var g=b.url;return b.transport!=\"polling\"&&(d.transport=b.transport),{open:function(){var a=f.createElement(\"iframe\");g=J(b),b.data!=\"\"&&(g+=\"&X-Atmosphere-Post-Body=\"+b.data),g=jQuery.atmosphere.prepareURL(g),a.src=g,f.body.appendChild(a);var c=a.contentDocument||a.contentWindow.document;e=jQuery.atmosphere.iterate(function(){try{if(!c.firstChild)return;if(c.readyState===\"complete\")try{jQuery.noop(c.fileSize)}catch(a){return ba(\"Connection Failure\",\"error\",500,b.transport),!1}var f=c.body?c.body.lastChild:c,g=function(){var a=f.cloneNode(!0);a.appendChild(c.createTextNode(\".\"));var b=a.innerText,d=!0;b.indexOf(\"<!-- Welcome to the Atmosphere Framework.\")==-1&&(d=!1);if(d){var e=\"<!-- EOD -->\",g=e.length,h=b.indexOf(e)+g;b=b.substring(h)}return b.substring(0,b.length-1)};if(!jQuery.nodeName(f,\"pre\")){var h=c.head||c.getElementsByTagName(\"head\")[0]||c.documentElement||c,i=c.createElement(\"script\");i.text=\"document.write('<plaintext>')\",h.insertBefore(i,h.firstChild),h.removeChild(i),f=c.body.lastChild}return ba(g(),\"opening\",200,b.transport),e=jQuery.atmosphere.iterate(function(){var a=g();a.length>b.lastIndex&&(d.status=200,ba(a,\"messageReceived\",200,b.transport),f.innerText=\"\",b.lastIndex=0);if(c.readyState===\"complete\")return ba(\"\",\"re-opening\",200,b.transport),Q(b),!1},null),!1}catch(j){jQuery.atmosphere.error(j)}})},close:function(){e&&e(),f.execCommand(\"Stop\"),ba(\"\",\"closed\",200,b.transport)}}}function S(a){o!=null?T(a):g!=null||f!=null?V(a):h!=null?W(a):i!=null?X(a):e!=null&&$(a)}function T(a){o.send(a)}function U(a){try{o?o.localSend(a):n.signal(\"localMessage\",jQuery.stringifyJSON({id:p,event:a}))}catch(b){jQuery.atmosphere.error(b)}}function V(a){var b=Z(a);L(b)}function W(a){if(c.enableXDR&&jQuery.atmosphere.checkCORSSupport()){var b=Z(a);b.reconnect=!1,z(b)}else V(a)}function X(a){V(a)}function Y(a){var b=a;return typeof b==\"object\"&&(b=a.data),b}function Z(a){var b=Y(a),d={connected:!1,timeout:6e4,method:\"POST\",url:c.url,contentType:c.contentType,headers:{},reconnect:!0,callback:null,data:b,suspend:!1,maxRequest:60,logLevel:\"info\",requestCount:0,transport:\"polling\",attachHeadersAsQueryString:!0,enableXDR:c.enableXDR,uuid:c.uuid};return typeof a==\"object\"&&(d=jQuery.extend(d,a)),d}function $(a){var b=Y(a),d;try{c.webSocketUrl!=null?d=c.webSocketPathDelimiter+c.webSocketUrl+c.webSocketPathDelimiter+b:d=b,e.send(d)}catch(f){e.onclose=function(a){},e.close(),I(\"Websocket failed. Downgrading to Comet and resending \"+d),V(a)}}function _(a){var b=jQuery.parseJSON(a);b.id!=p&&(typeof c.onLocalMessage!=\"undefined\"?c.onLocalMessage(b.event):typeof jQuery.atmosphere.onLocalMessage!=\"undefined\"&&jQuery.atmosphere.onLocalMessage(b.event))}function ba(a,b,e,f){if(b==\"messageReceived\"&&H(a,c,d))return;d.transport=f,d.status=e,d.expectedBodySize==-1&&(d.responseBody=a),d.state=b,bd()}function bb(a){bc(a,c),bc(a,jQuery.atmosphere)}function bc(a,b){switch(a.state){case\"messageReceived\":typeof b.onMessage!=\"undefined\"&&b.onMessage(a);break;case\"error\":typeof b.onError!=\"undefined\"&&b.onError(a);break;case\"opening\":typeof b.onOpen!=\"undefined\"&&b.onOpen(a);break;case\"messagePublished\":typeof b.onMessagePublished!=\"undefined\"&&b.onMessagePublished(a);break;case\"re-opening\":typeof b.onReconnect!=\"undefined\"&&b.onReconnect(c,a);break;case\"unsubscribe\":case\"closed\":typeof b.onClose!=\"undefined\"&&b.onClose(a)}}function bd(){var a=function(a,b){b(d)};o==null&&m!=null&&m(d.responseBody);var b=typeof d.responseBody==\"string\"?d.responseBody.split(c.messageDelimiter):new Array(d.responseBody);for(var e=0;e<b.length;e++){if(b.length>1&&b[e].length==0)continue;d.responseBody=jQuery.trim(b[e]);if(d.responseBody.length==0&&d.transport==\"streaming\"&&d.state==\"messageReceived\"){var f=navigator.userAgent.toLowerCase(),g=f.indexOf(\"android\")>-1;if(g)continue}bb(d);if(jQuery.atmosphere.callbacks.length>0){c.logLevel==\"debug\"&&jQuery.atmosphere.debug(\"Invoking \"+jQuery.atmosphere.callbacks.length+\" global callbacks: \"+d.state);try{jQuery.each(jQuery.atmosphere.callbacks,a)}catch(h){jQuery.atmosphere.log(c.logLevel,[\"Callback exception\"+h])}}if(typeof c.callback==\"function\"){c.logLevel==\"debug\"&&jQuery.atmosphere.debug(\"Invoking request callbacks\");try{c.callback(d)}catch(h){jQuery.atmosphere.log(c.logLevel,[\"Callback exception\"+h])}}}}function be(){c.reconnect=!1,d.request=c,j=!1,l=!0,d.state=\"unsubscribe\",d.responseBody=\"\",d.status=408,bd(),bf(),o==null&&m!=null&&(n.signal(\"close\",{reason:\"\",heir:l?n.get(\"children\")[0]:p}),document.cookie=encodeURIComponent(\"atmosphere-\"+c.url)+\"=; expires=Thu, 01 Jan 1970 00:00:00 GMT\"),n!=null&&n.close(),o!=null&&o.close()}function bf(){h!=null&&(h.close(),h=null),i!=null&&(i.abort(),i=null),g!=null&&(g.abort(),g=null),e!=null&&(e.close(),e=null),f!=null&&(f.close(),f=null)}var c={timeout:3e5,method:\"GET\",headers:{},contentType:\"\",callback:null,url:\"\",data:\"\",suspend:!0,maxRequest:60,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:\"info\",requestCount:0,fallbackMethod:\"GET\",fallbackTransport:\"streaming\",transport:\"long-polling\",webSocketImpl:null,webSocketUrl:null,webSocketPathDelimiter:\"@@\",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:\"|\",connectTimeout:-1,reconnectInterval:0,dropAtmosphereHeaders:!0,uuid:0,shared:!1,readResponsesHeaders:!0,onError:function(a){},onClose:function(a){},onOpen:function(a){},onMessage:function(a){},onReconnect:function(a,b){},onMessagePublished:function(a){},onTransportFailure:function(a,b){},onLocalMessage:function(a){}},d={status:200,responseBody:\"\",expectedBodySize:-1,headers:[],state:\"messageReceived\",transport:\"polling\",error:null,request:null,id:0},e=null,f=null,g=null,h=null,i=null,j=!0,k=0,l=!1,m=null,n,o=null,p=jQuery.now();s(b),this.subscribe=function(a){s(a),v()},this.execute=function(){v()},this.invokeCallback=function(){bd()},this.close=function(){be()},this.getUrl=function(){return c.url},this.push=function(a){S(a)},this.pushLocal=function(a){U(a)},this.response=d},subscribe:function(a,b,c){typeof b==\"function\"&&jQuery.atmosphere.addCallback(b),typeof a!=\"string\"?c=a:c.url=a;var d=new jQuery.atmosphere.AtmosphereRequest(c);return d.execute(),jQuery.atmosphere.requests[jQuery.atmosphere.requests.length]=d,d},addCallback:function(a){jQuery.inArray(a,jQuery.atmosphere.callbacks)==-1&&jQuery.atmosphere.callbacks.push(a)},removeCallback:function(a){var b=jQuery.inArray(a,jQuery.atmosphere.callbacks);b!=-1&&jQuery.atmosphere.callbacks.splice(b,1)},unsubscribe:function(){if(jQuery.atmosphere.requests.length>0)for(var a=0;a<jQuery.atmosphere.requests.length;a++)jQuery.atmosphere.requests[a].close(),clearTimeout(jQuery.atmosphere.requests[a].id);jQuery.atmosphere.requests=[],jQuery.atmosphere.callbacks=[]},unsubscribeUrl:function(a){var b=-1;if(jQuery.atmosphere.requests.length>0)for(var c=0;c<jQuery.atmosphere.requests.length;c++){var d=jQuery.atmosphere.requests[c];if(d.getUrl()==a){d.close(),clearTimeout(d.id),b=c;break}}b>=0&&jQuery.atmosphere.requests.splice(b,1)},publish:function(a){typeof a.callback==\"function\"&&jQuery.atmosphere.addCallback(callback),a.transport=\"polling\";var b=new jQuery.atmosphere.AtmosphereRequest(a);return jQuery.atmosphere.requests[jQuery.atmosphere.requests.length]=b,b},checkCORSSupport:function(){if(jQuery.browser.msie&&!window.XDomainRequest)return!0;if(jQuery.browser.opera)return!0;var a=navigator.userAgent.toLowerCase(),b=a.indexOf(\"android\")>-1;return b?!0:!1},S4:function(){return((1+Math.random())*65536|0).toString(16).substring(1)},guid:function(){return jQuery.atmosphere.S4()+jQuery.atmosphere.S4()+\"-\"+jQuery.atmosphere.S4()+\"-\"+jQuery.atmosphere.S4()+\"-\"+jQuery.atmosphere.S4()+\"-\"+jQuery.atmosphere.S4()+jQuery.atmosphere.S4()+jQuery.atmosphere.S4()},prepareURL:function(a){var b=jQuery.now(),c=a.replace(/([?&])_=[^&]*/,\"$1_=\"+b);return c+(c===a?(/\\?/.test(a)?\"&\":\"?\")+\"_=\"+b:\"\")},param:function(a){return jQuery.param(a,jQuery.ajaxSettings.traditional)},supportStorage:function(){var a=window.localStorage;if(a)try{return a.setItem(\"t\",\"t\"),a.removeItem(\"t\"),!!window.StorageEvent||Object.prototype.toString.call(a)===\"[object Storage]\"}catch(b){}return!1},iterate:function(a,b){var c;return b=b||0,function d(){c=setTimeout(function(){if(a()===!1)return;d()},b)}(),function(){clearTimeout(c)}},log:function(a,b){if(window.console){var c=window.console[a];typeof c==\"function\"&&c.apply(window.console,b)}},warn:function(){jQuery.atmosphere.log(\"warn\",arguments)},info:function(){jQuery.atmosphere.log(\"info\",arguments)},debug:function(){jQuery.atmosphere.log(\"debug\",arguments)},error:function(){jQuery.atmosphere.log(\"error\",arguments)}}}(),function(a){function d(a){return'\"'+a.replace(b,function(a){var b=c[a];return typeof b==\"string\"?b:\"\\\\u\"+(\"0000\"+a.charCodeAt(0).toString(16)).slice(-4)})+'\"'}function e(a){return a<10?\"0\"+a:a}function f(a,b){var c,g,h,i,j=b[a],k=typeof j;j&&typeof j==\"object\"&&typeof j.toJSON==\"function\"&&(j=j.toJSON(a),k=typeof j);switch(k){case\"string\":return d(j);case\"number\":return isFinite(j)?String(j):\"null\";case\"boolean\":return String(j);case\"object\":if(!j)return\"null\";switch(Object.prototype.toString.call(j)){case\"[object Date]\":return isFinite(j.valueOf())?'\"'+j.getUTCFullYear()+\"-\"+e(j.getUTCMonth()+1)+\"-\"+e(j.getUTCDate())+\"T\"+e(j.getUTCHours())+\":\"+e(j.getUTCMinutes())+\":\"+e(j.getUTCSeconds())+\"Z\"+'\"':\"null\";case\"[object Array]\":h=j.length,i=[];for(c=0;c<h;c++)i.push(f(c,j)||\"null\");return\"[\"+i.join(\",\")+\"]\";default:i=[];for(c in j)Object.prototype.hasOwnProperty.call(j,c)&&(g=f(c,j),g&&i.push(d(c)+\":\"+g));return\"{\"+i.join(\",\")+\"}\"}}}var b=/[\\\\\\\"\\x00-\\x1f\\x7f-\\x9f\\u00ad\\u0600-\\u0604\\u070f\\u17b4\\u17b5\\u200c-\\u200f\\u2028-\\u202f\\u2060-\\u206f\\ufeff\\ufff0-\\uffff]/g,c={\"\\b\":\"\\\\b\",\"\\t\":\"\\\\t\",\"\\n\":\"\\\\n\",\"\\f\":\"\\\\f\",\"\\r\":\"\\\\r\",'\"':'\\\\\"',\"\\\\\":\"\\\\\\\\\"};a.stringifyJSON=function(a){return window.JSON&&window.JSON.stringify?window.JSON.stringify(a):f(\"\",{\"\":a})}}(jQuery);";
	
	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp)
			throws ServletException, IOException {
		resp.setContentType("text/javascript");
		resp.getWriter().print(JS);
		resp.getWriter().flush();
		
	}
}
